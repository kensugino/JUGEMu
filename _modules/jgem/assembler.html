<!DOCTYPE html>


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>jgem.assembler &mdash; jGEM 0.9.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.3.4/css/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-3.3.4/css/bootstrap-theme.min.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.9.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-3.3.4/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../../_static/bootstrap-sphinx.js"></script>
    <link rel="top" title="jGEM 0.9.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body role="document">

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          jGEM</a>
        <span class="navbar-text navbar-version pull-left"><b>0.9.0</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">jGEM packages</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput > div,
div.nbinput div[class^=highlight],
div.nbinput div[class^=highlight] pre,
div.nboutput,
div.nboutput > div,
div.nboutput div[class^=highlight],
div.nboutput div[class^=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class^=highlight] pre {
    line-height: unset;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput > :first-child pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput > :first-child pre {
    color: #D84315;
}

/* all prompts */
div.nbinput > :first-child[class^=highlight],
div.nboutput > :first-child[class^=highlight],
div.nboutput > :first-child {
    /*min-width: 11ex;*/
    min-width:10ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}

/* input/output area */
div.nbinput > :nth-child(2)[class^=highlight],
div.nboutput > :nth-child(2),
div.nboutput > :nth-child(2)[class^=highlight] {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
}

/* input area */
div.nbinput > :nth-child(2)[class^=highlight] {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput  > :nth-child(2).stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-bold { font-weight: bold; }
</style>
<h1>Source code for jgem.assembler</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">.. module:: assembler</span>
<span class="sd">    :synopsis: assemble genes from RNASeq data (normalized genome coverage (bigwig) and junctions)</span>

<span class="sd">..  moduleauthor:: Ken Sugino &lt;ken.sugino@gmail.com&gt;</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># system imports</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="nb">reduce</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="kn">import</span> <span class="n">iadd</span><span class="p">,</span> <span class="n">iand</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
<span class="n">LOG</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="c1"># 3rd party imports</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">PD</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">N</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">P</span>

<span class="c1"># library imports</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">utils</span> <span class="k">as</span> <span class="n">UT</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">bedtools</span> <span class="k">as</span> <span class="n">BT</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">bigwig</span> <span class="k">as</span> <span class="n">BW</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">gtfgffbed</span> <span class="k">as</span> <span class="n">GGB</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">filenames</span> <span class="k">as</span> <span class="n">FN</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">graph</span> <span class="k">as</span> <span class="n">GP</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">calccov</span> <span class="k">as</span> <span class="n">CC</span>
<span class="kn">from</span> <span class="nn">jgem</span> <span class="kn">import</span> <span class="n">convert</span> <span class="k">as</span> <span class="n">CV</span>


<span class="c1"># Assemblers ###############################################################</span>

<span class="n">PARAMS</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">merging</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">genome</span><span class="o">=</span><span class="s1">&#39;mm10&#39;</span><span class="p">,</span> <span class="c1"># genome id</span>
    <span class="n">selectsj_ratio</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="c1"># ratio for selecting overlapping junctions</span>
    <span class="n">checksjsupport</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="c1"># whether check splice junctions without read support (necessary when merging or binth&gt;0)</span>
    <span class="n">binth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># bigwig to bed threshold</span>

    <span class="n">jie_binth</span><span class="o">=</span><span class="mi">320</span><span class="p">,</span> <span class="c1">#16,</span>
    <span class="n">jie_sjth</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>    
    <span class="n">jie_ratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># junctions in a exon ratio to surrounding junctions which define the exon</span>

    <span class="n">ureadth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># SJ uniq read (can be -1 to use uread=0 but mread&gt;0)</span>
    <span class="n">mreadth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1"># SJ non-uniq read threshold</span>
    <span class="c1"># SJ is selected as (uread&gt;ureadth | mread&gt;mreadth), so ureadth should really be &gt;=0</span>
    <span class="n">maxexonsize</span><span class="o">=</span><span class="mi">35000</span><span class="p">,</span><span class="c1"># max exon size (Ttn has ~20kbp exon)</span>
    <span class="n">edgesize</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="c1"># temporary edge exon size</span>

    <span class="n">mpth</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="c1"># mapped% th for detecting gene boundary</span>
    <span class="n">cutlen</span><span class="o">=</span><span class="mi">350</span><span class="p">,</span> <span class="c1"># check candidate bounded exons larger than this for cutting</span>
    <span class="n">gap</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="c1"># fill this gap to distinguish gene boundary vs. exon (fill exon but not intergenic)</span>

    <span class="n">gap5</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1">#150,#300, # for 5&#39; UTR extension</span>
    <span class="n">gap3</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="c1">#500, #1000,# for 3&#39; UTR extension</span>
    <span class="n">covfactor</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># for gap filling: if coverage of the next interval is &lt; covfactor*current cov</span>
    <span class="c1"># then don&#39;t fill</span>

    <span class="n">binstrand</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span>
    
    <span class="n">iret_mpth</span><span class="o">=</span><span class="mf">0.98</span><span class="p">,</span><span class="c1"># mapped% th for detecting intron retension</span>
    <span class="n">iret_covratio</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="c1"># min cov ratio between an iret and average of surrounding exons </span>
    <span class="n">iret_covth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1">#0.005, # if intron cov smaller than this, then ignore</span>


    <span class="n">findsecovth</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># whether to use adaptive secovth (pndr2)</span>
    <span class="n">minsecovth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#0.1,# minimum single exon coverage (normalized to million alignments)</span>
    <span class="n">secovth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#0.5, # default SE cov threshold if not using adaptive version (pndr1)</span>
    <span class="n">se_gap</span><span class="o">=</span><span class="mi">170</span><span class="p">,</span> <span class="c1">#50,# single exon gap fill</span>
    <span class="n">se_sizeth</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="c1"># single exon size th</span>
    <span class="n">se_sizeth2</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="c1"># for SELECTSEME</span>
    <span class="n">se_binth</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="c1">#0.01,</span>
    <span class="c1"># adaptive threshold is calculated and bigger of this and calculated value is used</span>
    <span class="c1"># se_th99, FINDSE_secovth in stats is the calculated value</span>
    <span class="n">findsecovth_useref</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># whether to use ref for finding secov, if not use ME</span>
    <span class="n">savepndr1</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="c1"># whether to save pndr1 (no adaptive secovth) when doing pndr2</span>
    
    <span class="n">find53ir_covratio</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="c1"># cov ratio threshold for FIND53IR</span>
    <span class="n">find53ir_covth</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="c1">#0.03, # cov threhold for FIND53IR</span>

    <span class="n">remove_overlappingse</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="c1"># whether to remove SE overlapping to ME</span>
    <span class="n">remove_bad2exon</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="c1"># whether to perform bad 2 exon gene removal</span>
    <span class="n">me2exon_sjth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># 2exon genes with splice junction support less than this will be removed</span>
    <span class="n">me2exon_sizeth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="c1"># 2exon genes terminal size th ~ 2 x read length</span>
    <span class="n">me2exon_covth</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1">#0.5,# 2exon genes cov th</span>
    
    <span class="n">ed_window</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="c1"># edge detector smooth window (in bp)</span>
    <span class="n">ed_minth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="c1"># edge detector minth for smoothed derivative</span>
    <span class="n">ed_sigma</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="c1"># edge detector sigma for threshold (larger of minth, sigma*std is used)</span>
    <span class="n">ed_covratio</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="c1"># edge detector if cov ratio to surrounds is &lt; covratio, discard</span>
    <span class="c1"># for abundant one covratio needs to be small to retrieve </span>
    <span class="n">ed_covth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1">#0.1,# edge detector abs cov threshold</span>
    <span class="n">ed_smwinsize</span><span class="o">=</span><span class="mi">151</span><span class="p">,</span> <span class="c1"># smooth window for trimming</span>
    <span class="n">ed_minintsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># window for merging peaks</span>
    <span class="n">ed_aggratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="c1"># </span>
    <span class="n">ed_mimath</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="c1"># min-max ratio threshold for cut decision</span>
    <span class="n">ed_mimath2</span><span class="o">=</span><span class="mf">0.30</span><span class="p">,</span>
    <span class="n">ed_triggerth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="c1"># for rise detection (detect rise when &gt;= max*mimath*triggerth after &lt;max*mima)</span>

    <span class="c1">#printerr=True, # mostly for FIXEDGES part</span>
    <span class="n">override</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span><span class="c1"># override previously saved calculation</span>
    <span class="n">np</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1"># number of process to spawn for connected component calculation</span>
    <span class="n">writegtf</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">writeiso</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">maxisonum</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">useallconnected</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>

    <span class="p">)</span>
<span class="c1"># use different parameters for merging</span>
<span class="n">MPARAMDIFF</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">merging</span> <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
    <span class="n">checksjsupport</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="n">binth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="c1">#0.001</span>
    <span class="n">mpth</span><span class="o">=</span><span class="mf">0.9999</span><span class="p">,</span>
    <span class="n">gap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">gap5</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">gap3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>

    <span class="n">findsecovth</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="c1">#minsecovth=0.03,</span>
    <span class="c1">#secovth=0.05,</span>
    <span class="c1">#se_binth=0.01,</span>
    <span class="n">se_gap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="c1">#se_sizeth=10,</span>

    <span class="n">ed_covratio</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">ed_minth</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
    <span class="n">ed_mimath</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span>
    <span class="n">ed_mimath2</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">ed_sigma</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="c1">#ed_covth=0.001,</span>

    <span class="n">iret_mpth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#0.9999,</span>
    <span class="n">iret_covratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="c1">#iret_covth=1, #0.01,</span>

    <span class="n">find53ir_covratio</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
    <span class="c1">#find53ir_covth=0.03,</span>
<span class="p">)</span>
<span class="n">MPARAMS</span> <span class="o">=</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">MPARAMS</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">MPARAMDIFF</span><span class="p">)</span>

<span class="c1"># for documentation purpose</span>
<span class="n">PARAMSDOC</span> <span class="o">=</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">MPARAMS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">PARAMSDOC</span><span class="p">[</span><span class="n">k</span><span class="o">+</span><span class="s1">&#39;_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

<span class="c1">#LOG.debug(PARAMSDOC)</span>

<div class="viewcode-block" id="Assembler"><a class="viewcode-back" href="../../modules.html#jgem.assembler.Assembler">[docs]</a><span class="k">class</span> <span class="nc">Assembler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fnobj</span><span class="p">,</span> <span class="n">merging</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">saveintermediates</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            fnobj: FileNames object</span>
<span class="sd">            merging (bool): whether merging assembled models or not (default False)</span>
<span class="sd">            saveintermediates (bool): whether to save intermediates (default True)</span>
<span class="sd">            kwargs: to change any of the parameter values</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span><span class="o">=</span><span class="n">fnobj</span>
        <span class="k">if</span> <span class="n">merging</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">MPARAMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pr</span> <span class="o">=</span> <span class="n">PARAMS</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saveintermediates</span> <span class="o">=</span> <span class="n">saveintermediates</span>
        <span class="n">pr</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># def delete_intermediates(self):</span>
    <span class="c1">#     &quot;Delete intermediate files.&quot;</span>
    <span class="c1">#     fn = self.fnobj</span>
    <span class="c1">#     categories = [x for x in fn._fnames.keys() if x !=&#39;output&#39;]</span>
    <span class="c1">#     fn.delete(delete=categories, protect=[&#39;output&#39;])</span>

<div class="viewcode-block" id="Assembler.check_params"><a class="viewcode-back" href="../../modules.html#jgem.assembler.Assembler.check_params">[docs]</a>    <span class="k">def</span> <span class="nf">check_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Check parameter change (if run previously) and save current parameter set.&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">del</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
        <span class="k">del</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span>
        <span class="c1"># parameter check</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merging&#39;</span><span class="p">]):</span> 
            <span class="c1"># always do consistency check if binth&gt;0 (since support may be reduced)</span>
            <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;checksjsupport&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;checksjsupport&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
        <span class="n">prdf</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;assemble.params.txt&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">prdf0</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span><span class="n">index_col</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prdf</span><span class="p">)</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">prdf0</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">prdf</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">==</span> <span class="n">prdf0</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;parameter different overriding...&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">prdf</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prdf</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                        <span class="n">p2</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">prdf0</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">x</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                        <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
                            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  {0}: {1} &lt;=&gt; {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span><span class="o">=</span><span class="bp">True</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;parameter set changed, overriding...&#39;</span><span class="p">)</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prdf</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">p2</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">prdf0</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">p1</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">p2</span><span class="p">)</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">p2</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  old({0}) new({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">))</span>
        <span class="c1"># save parameters</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">prdf</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;ih&#39;</span><span class="p">)</span></div>
            
<div class="viewcode-block" id="Assembler.save_stats"><a class="viewcode-back" href="../../modules.html#jgem.assembler.Assembler.save_stats">[docs]</a>    <span class="k">def</span> <span class="nf">save_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Saves assemble related stats into (samplename).assemble.stats.txt. &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;assemble.stats.txt&#39;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="s1">&#39;ih&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assembler.assemble"><a class="viewcode-back" href="../../modules.html#jgem.assembler.Assembler.assemble">[docs]</a>    <span class="k">def</span> <span class="nf">assemble</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Perform the assembly &quot;&quot;&quot;</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_params</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">sjfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merging&#39;</span><span class="p">]:</span>
            <span class="n">SELECTSJ</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;checksjsupport&#39;</span><span class="p">]:</span>
            <span class="n">CHECKSJSUPPORT</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>

        <span class="n">REMOVEJIE</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">SJ2EX</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="c1"># ADDJIE(self)() # no need to do this</span>
        <span class="n">MERGEEXONS</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merging&#39;</span><span class="p">]:</span>
            <span class="n">FINDEDGES2</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FIXSTRAND</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="c1"># FIND53IR only deals with exons with length &gt; SE sizeth = 50bp)</span>
            <span class="c1"># gap smaller than this will be missed if we skip FINDIRETS</span>
            <span class="n">FINDIRETS</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FIND53IR</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FINDEDGES</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FIXSTRAND</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">EDGEFIXER</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FINDIRETS</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FINDSECOVTH</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
            <span class="n">FINDSE</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>

        <span class="n">CALCCOV</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">SETINFO</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span> <span class="c1"># SET ACCEPTOR/DONOR/EXON CATEGORY</span>
        <span class="n">FINDGENES</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">SELECTSEME</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span> <span class="c1"># SELECT ME and SE, saves exname2, exname3, sjname2</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merging&#39;</span><span class="p">]:</span>
            <span class="n">FIXEDGES2</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span> <span class="c1"># TRIM 3&#39;,5&#39; edges</span>

        <span class="n">CONSISTENTSJ</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span> <span class="c1"># remove sj without ex support</span>
        <span class="n">WRITESJEX</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>
        <span class="n">WRITEGENES</span><span class="p">(</span><span class="bp">self</span><span class="p">)()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">save_stats</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">saveintermediates</span><span class="p">:</span>
            <span class="c1"># self.delete_intermediates()</span>
            <span class="n">fn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">delete</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">],</span> <span class="n">protect</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">,</span><span class="s1">&#39;stats&#39;</span><span class="p">])</span></div></div>


<span class="c1"># assembler modules #######################################################</span>

<span class="c1"># def mp_worker(args):</span>
<span class="c1">#     func, arg = args</span>
<span class="c1">#     return func(*arg)</span>

<div class="viewcode-block" id="SUBASE"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE">[docs]</a><span class="k">class</span> <span class="nc">SUBASE</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class of assembler modules.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">asm</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span> <span class="o">=</span> <span class="n">asm</span> <span class="c1"># assembler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">fnobj</span> <span class="c1"># FileNames object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">params</span> <span class="c1"># dict </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span> <span class="o">=</span> <span class="n">asm</span><span class="o">.</span><span class="n">stats</span> <span class="c1"># dict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0} &#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">_sttime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">rslt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; time: {0:.3f}s&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">_sttime</span><span class="p">))</span>

<div class="viewcode-block" id="SUBASE.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span></div>

<div class="viewcode-block" id="SUBASE.bw2bed"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE.bw2bed">[docs]</a>    <span class="k">def</span> <span class="nf">bw2bed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">binth</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="n">BW</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span>
            <span class="n">bwfile</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span>
            <span class="n">bedfile</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bedname2</span><span class="p">(</span><span class="s1">&#39;bw&#39;</span><span class="p">,</span><span class="n">binth</span><span class="p">),</span>
            <span class="n">chroms</span><span class="o">=</span><span class="n">UT</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;genome&#39;</span><span class="p">]),</span>
            <span class="n">th</span><span class="o">=</span><span class="n">binth</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">binfile</span></div>

<div class="viewcode-block" id="SUBASE.fillgap"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE.fillgap">[docs]</a>    <span class="k">def</span> <span class="nf">fillgap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">binfile</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="k">if</span> <span class="n">gap</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">gapfile</span><span class="o">=</span><span class="n">binfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gapfile</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">fillgap</span><span class="p">(</span><span class="n">binfile</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">bedname2</span><span class="p">(</span><span class="s1">&#39;gap&#39;</span><span class="p">,</span> <span class="n">gap</span><span class="p">),</span> <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">gapfile</span></div>

<div class="viewcode-block" id="SUBASE.chroms"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE.chroms">[docs]</a>    <span class="k">def</span> <span class="nf">chroms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">chroms0</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;genome&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">chroms0</span><span class="p">]</span></div>

    <span class="c1"># def _process_mp(self, func, args):</span>
    <span class="c1">#     np = self.params[&#39;np&#39;]</span>
    <span class="c1">#     rslts = []</span>
    <span class="c1">#     if np==1:</span>
    <span class="c1">#         for i, arg in enumerate(args):</span>
    <span class="c1">#             rslts += func(*arg)</span>
    <span class="c1">#             LOG.debug(&#39; processing: {0}/{1}...&#39;.format(i+1,len(args)))</span>
    <span class="c1">#     else:</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             p = multiprocessing.Pool(np)</span>
    <span class="c1">#             a = zip(repeat(func), args)</span>
    <span class="c1">#             tmp = p.map(mp_worker, a)</span>
    <span class="c1">#         finally:</span>
    <span class="c1">#             LOG.debug(&#39;closing pool&#39;)</span>
    <span class="c1">#             p.close()</span>
    <span class="c1">#         rslts = reduce(iadd, tmp)</span>
    <span class="c1">#     return rslts</span>

<div class="viewcode-block" id="SUBASE.sjfile"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SUBASE.sjfile">[docs]</a>    <span class="k">def</span> <span class="nf">sjfile</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">fname0</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;checksjsupport.sj&#39;</span><span class="p">)</span>
        <span class="n">fname1</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;fixstrand.sj&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fname1</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;checksjsupport&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">fname0</span>
        <span class="k">return</span> <span class="n">fn</span><span class="o">.</span><span class="n">sjfile</span></div></div>


<div class="viewcode-block" id="SELECTSJ"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SELECTSJ">[docs]</a><span class="k">class</span> <span class="nc">SELECTSJ</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Select splice junction based on ratio of junction counts within overlapping junctions.</span>
<span class="sd">    Use ratio of unique counts and ratio of total counts (to incorporate cases where there are</span>
<span class="sd">    only non-unique counts). </span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: selected junctions dataframe</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * selectsj_ratio: thredhold for the ratio, default:{selectsj_ratio}</span>

<span class="sd">    Files:</span>
<span class="sd">        * selectsj.bed.gz</span>
<span class="sd">        * selectsj.inte.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SELECTSJ.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SELECTSJ.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;selectsj&#39;</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;selectsj.inte&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolintersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">wao</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># somehow -s (force same strand) doesn&#39;t work</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">read_ovl</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
        <span class="n">idxstrand</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;b_strand&#39;</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
        <span class="n">sjgr</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span>
        <span class="c1"># BEDCOLUMNS sc1(5th), tst(7th) contains unique count (ucnt) and non-unique count (mcnt)</span>
        <span class="n">sj2</span> <span class="o">=</span> <span class="n">sjgr</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;tst&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ucnt_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sjgr</span><span class="p">[</span><span class="s1">&#39;b_sc1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;mcnt_sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sjgr</span><span class="p">[</span><span class="s1">&#39;b_tst&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ucnt_sum&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;mcnt_sum&#39;</span><span class="p">]</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;tst&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sj2</span> <span class="o">=</span> <span class="n">sj2</span> <span class="o">=</span> <span class="n">sj2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;locus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">calc_locus_strand</span><span class="p">(</span><span class="n">sj2</span><span class="p">)</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ucnt_sum&#39;</span><span class="p">]</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ratio_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;tst&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;mcnt_sum&#39;</span><span class="p">]</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ratio_a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;cnt&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;sum&#39;</span><span class="p">]</span>        
        <span class="bp">self</span><span class="o">.</span><span class="n">sj2</span> <span class="o">=</span> <span class="n">sj2</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">sj2</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;selectsj.sj2&#39;</span><span class="p">,</span><span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">),</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span> <span class="c1"># TODO change cat to &#39;temp&#39;</span>

        <span class="c1"># select </span>
        <span class="n">th_ratio</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;selectsj_ratio&#39;</span><span class="p">]</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ratio&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">th_ratio</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;ratio_a&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">th_ratio</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sj4</span> <span class="o">=</span> <span class="n">sj4</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="n">idx1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#sj:{0}=&gt;{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SELECTSJ.#sj0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SELECTSJ.#sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj4</span><span class="p">)</span>
        <span class="c1">#return sj4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj4</span></div></div>

<div class="viewcode-block" id="CHECKSJSUPPORT"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CHECKSJSUPPORT">[docs]</a><span class="k">class</span> <span class="nc">CHECKSJSUPPORT</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check junction edges have &gt;0 coverages. Remove junctions without support. </span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: compatible junctions</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * binth: coverage threshold, default:{binth}, (for merging: {binth_m})</span>
<span class="sd">        * genome: genome version, default:{genome}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * bw*.bed.gz</span>
<span class="sd">        * sjst.bed.gz</span>
<span class="sd">        * sjed.bed.gz</span>
<span class="sd">        * sjst.ovl.txt.gz</span>
<span class="sd">        * sjed.ovl.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CHECKSJSUPPORT.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CHECKSJSUPPORT.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="c1"># get bindf</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">])</span>
        <span class="c1"># write st,ed from sjs</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st-2&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ed+1&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">))</span>
        <span class="n">sjst</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;checksjsupport.sjst&#39;</span><span class="p">)</span>
        <span class="n">sjed</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;checksjsupport.sjed&#39;</span><span class="p">)</span>
        <span class="c1"># BEDCOLS: chr,st,ed,name,sc1,strand,tst</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">sj</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st-2&#39;</span><span class="p">,</span><span class="s1">&#39;st-1&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;tst&#39;</span><span class="p">]],</span><span class="n">sjst</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">sj</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;ed+1&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;tst&#39;</span><span class="p">]],</span><span class="n">sjed</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">stovl</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;checksjsupport.sjst.ovl&#39;</span><span class="p">)</span>
        <span class="n">edovl</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;checksjsupport.sjed.ovl&#39;</span><span class="p">)</span>
        <span class="c1"># bedtools intersect to bindf</span>
        <span class="n">ost</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span><span class="n">sjst</span><span class="p">,</span> <span class="n">binfile</span><span class="p">,</span> <span class="n">stovl</span><span class="p">,</span> <span class="n">nacol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">oed</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span><span class="n">sjed</span><span class="p">,</span> <span class="n">binfile</span><span class="p">,</span> <span class="n">edovl</span><span class="p">,</span> <span class="n">nacol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">ost</span> <span class="o">=</span> <span class="n">ost</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">oed</span> <span class="o">=</span> <span class="n">oed</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
        <span class="n">sjsupp</span> <span class="o">=</span> <span class="n">sj</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)[(</span><span class="n">ost</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">oed</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span><span class="s1">&#39;#sj: {0}=&gt;{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sjsupp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;CHECKSJSUPPORT.#sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;CHECKSJSUPPORT.#sjsupp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sjsupp</span><span class="p">)</span>
        <span class="c1">#return sjsupp</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">sjsupp</span><span class="p">,</span> <span class="s1">&#39;checksjsupport.sj&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sjsupp</span></div></div>

<div class="viewcode-block" id="REMOVEJIE"><a class="viewcode-back" href="../../modules.html#jgem.assembler.REMOVEJIE">[docs]</a><span class="k">class</span> <span class="nc">REMOVEJIE</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove Junctions In Exons. Often times exons with high coverage contain </span>
<span class="sd">    noise junctions. </span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: junction dataframe without JIE</span>
<span class="sd">        :jie: junctions in exons</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * jie_binth: coverage threshold,  default:{jie_binth}</span>
<span class="sd">        * jie_sjth: threshold for normalized read counts,  default:{genome}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * bw*.bed.gz</span>
<span class="sd">        * sjsupp.bed.gz</span>
<span class="sd">        * jie.bw.ovl.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="REMOVEJIE.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.REMOVEJIE.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">sjfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sjfile</span><span class="p">()</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="c1"># covarage file</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;jie_binth&#39;</span><span class="p">])</span>
        <span class="c1"># if nothing in binfile then skip</span>
        <span class="n">jiebw</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">binfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jiebw</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">jie</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;nothing above jie_binth {0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;jie_binth&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;REMOVEJIE.#sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;REMOVEJIE.#jie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">return</span>            

        <span class="n">sjmp</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span>
            <span class="n">aname</span><span class="o">=</span><span class="n">sjfile</span><span class="p">,</span> 
            <span class="n">bname</span><span class="o">=</span><span class="n">binfile</span><span class="p">,</span> 
            <span class="n">tname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;removejie.bw.ovl&#39;</span><span class="p">),</span> 
            <span class="n">nacol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
            <span class="n">idcol</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="c1"># match records between sjmp and mg.sj</span>
        <span class="n">sjmp</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">calc_locus</span><span class="p">(</span><span class="n">sjmp</span><span class="p">)</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">calc_locus</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="n">sid2ovl</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">df2dict</span><span class="p">(</span><span class="n">sjmp</span><span class="p">,</span> <span class="s1">&#39;str_id&#39;</span><span class="p">,</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">)</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid2ovl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]]</span>
        
        <span class="c1"># should use count ratios instead of actual reads as threshold ?</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;jie_sjth&#39;</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">th</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;tst&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">th</span><span class="p">)</span>
        

        <span class="n">sj1</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># use these for &quot;nearest donor/acceptor&quot; exon extraction</span>
        <span class="n">jie</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># junctions in exon, add later</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#sj:{0}=&gt;{1}, jie {2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">jie</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;REMOVEJIE.#sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;REMOVEJIE.#jie&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jie</span><span class="p">)</span>
        <span class="c1">#return sj1, jie</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">jie</span> <span class="o">=</span> <span class="n">jie</span></div></div>

<div class="viewcode-block" id="SJ2EX"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SJ2EX">[docs]</a><span class="k">class</span> <span class="nc">SJ2EX</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find candidate exons from junctions.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :me: exons dataframe</span>
<span class="sd">        :sj: compatible junctions</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * ureadth: threshold for junction unique counts, default:{ureadth} ({ureadth_m} for merging)</span>
<span class="sd">        * mreadth: threshold for non-unique junction counts, default:{mreadth} ({mreadth_m} for merging)</span>
<span class="sd">        * maxexonsize: maximum exon size, default:{maxexonsize}</span>
<span class="sd">        * edgesize: temporary edge exon size, default:{edgesize}</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SJ2EX.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SJ2EX.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">ureadth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ureadth&#39;</span><span class="p">]</span>
        <span class="n">mreadth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;mreadth&#39;</span><span class="p">]</span>

        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ureads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;mreads&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;tst&#39;</span><span class="p">]</span>
        <span class="n">sj1</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ureads&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">ureadth</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;mreads&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">mreadth</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#sj:{0}=&gt;{1} after ureadth, mreadth&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SJ2EX.#sj_before_uth_mth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SJ2EX.#sj_after_uth_mth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">)</span>

        <span class="n">ex</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sj2ex</span><span class="p">(</span><span class="n">sj1</span><span class="p">)],</span><span class="n">columns</span><span class="o">=</span><span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
        <span class="c1"># there are small cases of duplicates</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span>
        <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;_ord&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="c1"># bring bounded both [...] to front (others lack)</span>
        <span class="n">exg</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;_ord&#39;</span><span class="p">])</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">exg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#ex:{0}, #sj:{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SJ2EX.#exon_candidates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="c1">#return ex, sj1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">ex</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj1</span></div>

    <span class="k">def</span> <span class="nf">_sj2ex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sj</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">maxsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;maxexonsize&#39;</span><span class="p">]</span> 
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;merging&#39;</span><span class="p">]:</span>
            <span class="n">edgesize</span> <span class="o">=</span> <span class="n">maxsize</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edgesize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;edgesize&#39;</span><span class="p">]</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># workaround for nonlocal closure variable for Python2</span>
        <span class="c1"># in Python3 use nonlocal keyword</span>
                
        <span class="k">def</span> <span class="nf">sj2expn</span><span class="p">(</span><span class="n">strand</span><span class="p">):</span>
            <span class="c1"># strand +,-</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">)]</span>
            <span class="c1"># chrom wise</span>
            <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;chr&#39;</span><span class="p">):</span>
                <span class="n">sts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="c1"># right end of exon (ed)</span>
                <span class="n">eds</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="c1"># left end of exon (st)</span>
                <span class="n">eds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edgesize</span><span class="p">)]</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">eds</span><span class="p">)</span>
                <span class="n">nsts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span>
                <span class="n">neds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># current left end pos</span>
                <span class="n">usededs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsts</span><span class="p">):</span> <span class="c1"># go through right ends</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="c1"># find nearest left end</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">usededs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;{0}{1}s]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxsize</span><span class="p">:</span> <span class="c1"># too far</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;{0}{1}f]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">edgesize</span><span class="p">,</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># bounded on both</span>
                        <span class="n">usededs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[{0}{1}a]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                <span class="n">unusededs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">neds</span><span class="p">))</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">usededs</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">sts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span><span class="o">+</span><span class="p">[</span><span class="n">eds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">edgesize</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unusededs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="c1"># dummy ed</span>
                        <span class="k">continue</span> 
                    <span class="k">while</span> <span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">]):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">nsts</span><span class="p">:</span><span class="c1"># len(sts)=nsts+1</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[{0}{1}e&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxsize</span><span class="p">:</span> <span class="c1"># too far</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[{0}{1}f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">+</span><span class="n">edgesize</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># bounded on both sides</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[{0}{1}b]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">strand</span><span class="p">,</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">strand</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">sj2exns</span><span class="p">():</span>
            <span class="n">sj0</span> <span class="o">=</span> <span class="n">sj</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
            <span class="c1"># chrom wise</span>
            <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;chr&#39;</span><span class="p">):</span>
                <span class="n">sts</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">g</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="c1"># right end of exon (ed) for &#39;.&#39;</span>
                <span class="n">sjchr</span> <span class="o">=</span> <span class="n">sj0</span><span class="p">[</span><span class="n">sj0</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">]</span><span class="c1">#.copy()</span>
                <span class="c1">#sjchr[&#39;st&#39;] = sjchr[&#39;st&#39;]-1</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sjchr</span><span class="p">[[</span><span class="s1">&#39;st-1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
                <span class="n">sts0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="c1"># all right end of exon (ed)+strand</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sjchr</span><span class="p">[[</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
                <span class="n">eds0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="c1"># all left end of exon (st)+strand</span>
                <span class="n">sts0</span> <span class="o">=</span> <span class="n">sts0</span><span class="o">+</span><span class="p">[(</span><span class="n">eds0</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">edgesize</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span>
                <span class="n">eds0</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">sts0</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">edgesize</span><span class="p">),</span><span class="s1">&#39;.&#39;</span><span class="p">)]</span><span class="o">+</span><span class="n">eds0</span>
                <span class="n">nsts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sts</span><span class="p">)</span>
                <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># current left end pos</span>
                <span class="n">usededs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nsts</span><span class="p">):</span> <span class="c1"># go through right ends</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span> <span class="c1"># find nearest left end</span>
                        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">:</span>
                            <span class="n">usededs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;.{0}s]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxsize</span><span class="p">:</span> <span class="c1"># too far</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;.{0}f]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">edgesize</span><span class="p">,</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>  <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># bounded on both</span>
                        <span class="k">if</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">:</span>
                            <span class="n">usededs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[.{0}a]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sts</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">alleds</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">eds0</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">i</span><span class="o">!=</span><span class="mi">0</span><span class="p">)])</span>
                <span class="c1"># eds0[0] is a dummy record =&gt; don&#39;t include</span>
                <span class="n">unusededs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">alleds</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">usededs</span><span class="p">))</span>
                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">nsts0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sts0</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">unusededs</span><span class="p">:</span>
                    <span class="k">while</span> <span class="p">(</span><span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">i</span><span class="o">==</span><span class="n">nsts0</span><span class="p">:</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[.{0}e&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">&gt;</span><span class="n">maxsize</span><span class="p">:</span> <span class="c1"># too far</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[.{0}f&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">edgesize</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span> <span class="c1"># bounded on both sides</span>
                        <span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;[.{0}b]&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">eds0</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sts0</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj2expn</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj2expn</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">x</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj2exns</span><span class="p">():</span>
            <span class="k">yield</span> <span class="n">x</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; total {0} exon candidates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span></div>

<div class="viewcode-block" id="MERGEEXONS"><a class="viewcode-back" href="../../modules.html#jgem.assembler.MERGEEXONS">[docs]</a><span class="k">class</span> <span class="nc">MERGEEXONS</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Merge overlapping exons.</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :me: exon dataframe with merged exons</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * sjex.bed.gz</span>
<span class="sd">        * sjex.inte.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO:</span>
    <span class="c1">#     Currently only two overlapping exons are merged. Generalized to n.</span>


<div class="viewcode-block" id="MERGEEXONS.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.MERGEEXONS.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="c1"># ex vs. ex overlap</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;mergeexons.sjex&#39;</span><span class="p">),</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;mergeexons.sjex.inte&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolintersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">wao</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># somehow -s (force same strand) doesn&#39;t work</span>
        <span class="n">cols0</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">read_ovl</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cols0</span><span class="p">)</span>
        <span class="n">idxstrand</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;b_strand&#39;</span><span class="p">]</span>
        <span class="c1"># select ordered overlaps (to count overlap only once)</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;b_st&#39;</span><span class="p">]</span> 
        <span class="n">idx2</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;b_st&#39;</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">o</span><span class="p">[</span><span class="s1">&#39;b_ed&#39;</span><span class="p">])</span>
        <span class="n">o</span> <span class="o">=</span> <span class="n">o</span><span class="p">[</span><span class="n">idxstrand</span><span class="o">&amp;</span><span class="p">(</span><span class="n">idx1</span><span class="o">|</span><span class="n">idx2</span><span class="p">)]</span> <span class="c1"># unique overlap pairs</span>
        <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;b_st&#39;</span><span class="p">,</span><span class="s1">&#39;b_ed&#39;</span><span class="p">,</span><span class="s1">&#39;b_name&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">t</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">bs</span><span class="p">,</span><span class="n">be</span><span class="p">,</span><span class="n">bn</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">cols</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">e</span><span class="o">!=</span><span class="n">be</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">be</span><span class="p">,</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">bn</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">s</span><span class="o">!=</span><span class="n">bs</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">bs</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">bn</span><span class="o">+</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">n</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">t</span><span class="p">)</span>
        <span class="n">mrgd</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_gen</span><span class="p">()],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols0</span><span class="p">)</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">ex</span><span class="p">[</span><span class="n">cols0</span><span class="p">],</span> <span class="n">mrgd</span><span class="p">[</span><span class="n">cols0</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#ex:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">me</span><span class="p">))</span>
        <span class="c1">#return me</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span></div></div>

<div class="viewcode-block" id="FINDEDGES2"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDEDGES2">[docs]</a><span class="k">class</span> <span class="nc">FINDEDGES2</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find edges </span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: compatible junctions</span>
<span class="sd">        :me: exon dataframe with edge exons added</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * mpth: mapped% th for detecting gene boundary, default {mpth}</span>
<span class="sd">        * binth: bigwig to bed threshold, default {binth} (merging: {binth_m})</span>
<span class="sd">        * gap: fill this gap to distinguish gene boundary vs. exon (fill exon but not intergenic), default {gap} (merging: {gap_m})</span>
<span class="sd">        * edgesize: temporary edge exon size, default {edgesize}</span>
<span class="sd">        * maxexonsize: max exon size (Ttn has ~20kbp exon), default {maxexonsize}</span>
<span class="sd">        * cutlen: check candidate bounded exons larger than this for cutting, default {cutlen}</span>
<span class="sd">        * ed_sigma: edge detector sigma for threshold (larger of minth, sigma*std is used), </span>
<span class="sd">          default {ed_sigma}  (merging: {ed_sigma_m})</span>
<span class="sd">        * ed_minth: edge detector minth for smoothed derivative, default {ed_minth} (merging: {ed_minth_m})</span>
<span class="sd">        * ed_covratio: edge detector if cov ratio to surrounds is &lt; covratio, discard, </span>
<span class="sd">          default {ed_covratio} (merging: {ed_covratio_m})</span>
<span class="sd">        * ed_window: edge detector smooth window (in bp), default {ed_window}</span>
<span class="sd">        * ed_covth: edge detector abs cov threshold, default {ed_covth}  (merging: {ed_covth_m})</span>
<span class="sd">        * ed_smwinsize: smooth window for trimming default {ed_smwinsize}</span>
<span class="sd">        * ed_minintsize: window for merging peaks, default {ed_minintsize}</span>
<span class="sd">        * ed_aggratio: default {ed_aggratio} </span>
<span class="sd">        * ed_mimath: min-max ratio threshold for cut decision, default {ed_mimath} (merging: {ed_mimath_m})</span>
<span class="sd">        * ed_mimath2: default {ed_mimath2}  (merging: {ed_mimath2_m})</span>
<span class="sd">        * ed_triggerth: for rise detection (detect rise when &gt;= max*mimath*triggerth after &lt;max*mima), default {ed_triggerth}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * fe2.sjbb.bed.gz</span>
<span class="sd">        * fe2.sjbb-ovl.txt.gz</span>
<span class="sd">        * fe2.me1.ci.txt.gz</span>
<span class="sd">        * fe2.me2p.ci.txt.gz</span>
<span class="sd">        * fe2.me2n.ci.txt.gz</span>
<span class="sd">        * fe2.sj.txt.gz</span>
<span class="sd">        * fe2.me.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FINDEDGES2.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDEDGES2.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj</span>

        <span class="c1"># bounded (kind: a,b)=&gt; cut</span>
        <span class="n">me</span><span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">me</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;s|e|f&#39;</span><span class="p">)</span> <span class="c1"># unbounded</span>
        <span class="n">me1</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># bounded cut these</span>
        <span class="n">me2</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># not (a,b) kind:(s,e,f) =&gt; fix (~20K)</span>

        <span class="c1"># do it at the level of ci </span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">chopintervals</span><span class="p">(</span><span class="n">me1</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findedges2.me1.ci&#39;</span><span class="p">),</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">])</span>
        <span class="n">sjbbname</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">ci</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">]],</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findedges2.sjbb&#39;</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">bbg</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span>
                <span class="n">aname</span><span class="o">=</span><span class="n">sjbbname</span><span class="p">,</span> 
                <span class="n">bname</span><span class="o">=</span><span class="n">binfile</span><span class="p">,</span> 
                <span class="n">tname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findedges2.sjbb-ovl&#39;</span><span class="p">),</span> 
                <span class="n">nacol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="c1"># calculate mp and len</span>
        <span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
        <span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="c1"># name1 contains list of ids</span>
        <span class="n">ci1</span> <span class="o">=</span> <span class="n">bbg</span><span class="p">[(</span><span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;mpth&#39;</span><span class="p">])</span><span class="o">|</span><span class="p">(</span><span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;cutlen&#39;</span><span class="p">])]</span> <span class="c1"># ~ 16K</span>
        <span class="c1"># cut candidates</span>
        <span class="n">eids1</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">iadd</span><span class="p">,</span> <span class="n">ci1</span><span class="p">[</span><span class="s1">&#39;name1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">[])</span> <span class="c1"># exons being cut</span>
        <span class="n">eids0</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">me1</span><span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">eids1</span><span class="p">)))</span>
        <span class="n">me1i</span> <span class="o">=</span> <span class="n">me1</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span> <span class="c1"># me1 (bounded) indexed</span>
        <span class="n">me1s</span> <span class="o">=</span> <span class="n">me1i</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">eids1</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># cut targets</span>
        <span class="n">me0</span> <span class="o">=</span> <span class="n">me1i</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">eids0</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># remaining (non-cut) exons</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;cutting {0} ci chrom-wise&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ci1</span><span class="p">)))</span>
        <span class="n">me1r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">ci1</span><span class="p">,</span><span class="n">me1s</span><span class="p">,</span><span class="n">cutedges_m</span><span class="p">)</span>

        <span class="c1"># fix me2</span>
        <span class="n">me2p</span> <span class="o">=</span> <span class="n">me2</span><span class="p">[</span><span class="n">me2</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)]</span>
        <span class="n">ci2p</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">chopintervals</span><span class="p">(</span><span class="n">me2p</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findedges2.me2p.ci&#39;</span><span class="p">),</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span>
        <span class="n">ci2p</span> <span class="o">=</span> <span class="n">ci2p</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;sc1&#39;</span><span class="p">})</span>
        <span class="n">ci2p</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;+&#39;</span>
        <span class="n">me2n</span> <span class="o">=</span> <span class="n">me2</span><span class="p">[</span><span class="n">me2</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)]</span>
        <span class="n">ci2n</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">chopintervals</span><span class="p">(</span><span class="n">me2n</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findedges2.me2n.ci&#39;</span><span class="p">),</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span>
        <span class="n">ci2n</span> <span class="o">=</span> <span class="n">ci2n</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;id&#39;</span><span class="p">:</span><span class="s1">&#39;sc1&#39;</span><span class="p">})</span>
        <span class="n">ci2n</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fixing {0} cip chrom-wise&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ci2p</span><span class="p">)))</span>
        <span class="n">me2pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">ci2p</span><span class="p">,</span><span class="n">me2p</span><span class="p">,</span><span class="n">fixedges_m</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fixing {0} cin chrom-wise&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ci2n</span><span class="p">)))</span>
        <span class="n">me2nr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">ci2n</span><span class="p">,</span><span class="n">me2n</span><span class="p">,</span><span class="n">fixedges_m</span><span class="p">)</span>
        <span class="c1"># concatenate</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span>
        <span class="n">me3</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me0</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">me1r</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">me2pr</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">me2nr</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])</span>
        <span class="n">me3</span> <span class="o">=</span> <span class="n">me3</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="c1"># find consistent sj</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_info</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">me3</span><span class="p">)</span>
        <span class="c1"># acceptor</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">me3</span><span class="p">[</span><span class="s1">&#39;a_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;a_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">dids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">me3</span><span class="p">[</span><span class="s1">&#39;d_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;d_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">sja</span> <span class="o">=</span> <span class="n">sj</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;a_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">aids</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">dids</span> <span class="o">=</span> <span class="n">dids</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sja</span><span class="p">[</span><span class="s1">&#39;d_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">sjd</span> <span class="o">=</span> <span class="n">sja</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;d_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">dids</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1">#return sjd, me3</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">sjd</span><span class="p">,</span> <span class="s1">&#39;findedges2.sj&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">me3</span><span class="p">,</span> <span class="s1">&#39;findedges2.me&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sjd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me3</span></div>

<div class="viewcode-block" id="FINDEDGES2.process_mp"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDEDGES2.process_mp">[docs]</a>    <span class="k">def</span> <span class="nf">process_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">bwname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span><span class="o">.</span><span class="n">bwfile</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">me</span><span class="p">):</span>
            <span class="n">mechr</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cichr</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[</span><span class="n">ci</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cichr</span><span class="p">,</span><span class="n">mechr</span><span class="p">,</span><span class="n">bwname</span><span class="p">,</span><span class="n">pr</span><span class="p">,</span><span class="n">chrom</span><span class="p">))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># if pr[&#39;np&#39;]==1:</span>
        <span class="c1">#     for i,arg in enumerate(args):</span>
        <span class="c1">#         tmp = func(*arg) #cutedges_m(arg)</span>
        <span class="c1">#         LOG.debug(&#39;  processing {3}: {0}/{1} {2}...&#39;.format(i+1,len(args),len(tmp),arg[-1]))</span>
        <span class="c1">#         rslts.append(tmp)</span>
        <span class="c1">#     return PD.concat(rslts,ignore_index=True)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     p = multiprocessing.Pool(pr[&#39;np&#39;])</span>
        <span class="c1">#     tmp = p.map(func, args)</span>
        <span class="c1"># finally:</span>
        <span class="c1">#     LOG.debug(&#39;  closing pool&#39;)</span>
        <span class="c1">#     p.close()</span>
        <span class="c1"># return PD.concat(tmp, ignore_index=True)</span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">])</span></div></div>

<div class="viewcode-block" id="cutedges_m"><a class="viewcode-back" href="../../modules.html#jgem.assembler.cutedges_m">[docs]</a><span class="k">def</span> <span class="nf">cutedges_m</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">me</span><span class="p">,</span><span class="n">bwname</span><span class="p">,</span><span class="n">pr</span><span class="p">,</span><span class="n">chrom</span><span class="p">):</span>
    <span class="c1"># input ci: chopped interval, me: exons, pr: params</span>
    <span class="c1"># return cut exons</span>
    <span class="c1"># convert ci =&gt; cicut  [+side col]</span>
    <span class="n">edgedet</span> <span class="o">=</span> <span class="n">EdgeDetector</span><span class="p">(</span>
                    <span class="n">bwname</span><span class="o">=</span><span class="n">bwname</span><span class="p">,</span>
                    <span class="n">sigmath</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_sigma&#39;</span><span class="p">],</span>
                    <span class="n">minth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_minth&#39;</span><span class="p">],</span>
                    <span class="n">covratio</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_covratio&#39;</span><span class="p">],</span>
                    <span class="n">winsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_window&#39;</span><span class="p">],</span>
                    <span class="n">covth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_covth&#39;</span><span class="p">],</span>
                    <span class="n">gapth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">],</span>
                    <span class="n">gap</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">],</span>
                    <span class="n">smwinsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_smwinsize&#39;</span><span class="p">],</span>
                    <span class="n">minintsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_minintsize&#39;</span><span class="p">],</span>
                    <span class="n">aggregateratio</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_aggratio&#39;</span><span class="p">],</span>
                    <span class="n">mimath</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_mimath&#39;</span><span class="p">],</span>
                    <span class="n">mimath2</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_mimath2&#39;</span><span class="p">],</span>
                    <span class="n">triggerth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_triggerth&#39;</span><span class="p">])</span>
    <span class="n">cicols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">edgedet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">cicols</span><span class="p">):</span>
                <span class="n">cuts</span> <span class="o">=</span> <span class="n">edgedet</span><span class="o">.</span><span class="n">cutboth</span><span class="p">(</span><span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span><span class="p">)</span>
                <span class="c1"># left</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># 0: left</span>
                <span class="c1"># right </span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># 1: right</span>
                <span class="c1"># both</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1"># 2: both</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_gen</span><span class="p">()]</span>
    <span class="c1">#LOG.debug(&#39;cut ci {2}: {0}=&gt;{1}&#39;.format(len(ci),len(tmp),chrom))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span><span class="s1">&#39;side&#39;</span><span class="p">])</span>
    <span class="c1"># now put them together as exons</span>
    <span class="c1"># eid (_id2 in me) &lt;=&gt; cid (in df): encoded in df[name]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
    <span class="n">dff</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">flattendf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;eid&#39;</span><span class="p">)</span>
    <span class="c1"># eid=&gt;strand, eid=&gt;name</span>
    <span class="n">e2strand</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]))</span>
    <span class="n">e2name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
    <span class="n">e2st</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">]))</span> 
    <span class="n">e2ed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">]))</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2strand</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;ename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2st</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2ed</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">_egen</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">eid</span><span class="p">,</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">dff</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">gr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;side&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span><span class="c1"># no cut</span>
                <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">]]</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">gri</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="c1"># left </span>
            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">:</span>
                <span class="n">gci</span> <span class="o">=</span> <span class="n">gri</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="n">cid</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
                <span class="c1"># side 0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">s0</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">s0</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                        <span class="n">n1</span> <span class="o">=</span> <span class="s1">&#39;{0}*(l{1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">cnt</span><span class="p">)</span>
                        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># if not side 2 break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s2</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">cid</span><span class="o">==</span><span class="n">cids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># last one all connected</span>
                        <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="c1"># right</span>
            <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                <span class="n">gci</span> <span class="o">=</span> <span class="n">gri</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="n">cid</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
                <span class="c1"># side 1</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">s1</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                        <span class="n">n1</span> <span class="o">=</span> <span class="s1">&#39;(r{1})*{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">cnt</span><span class="p">)</span>
                        <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="c1"># if not side 2 break</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">s2</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="n">tmp2</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_egen</span><span class="p">()]</span>
    <span class="c1">#LOG.debug(&#39;cut ex {2}: {0}=&gt;{1}&#39;.format(len(me),len(tmp2),chrom))</span>
    <span class="k">return</span> <span class="n">tmp2</span></div>
    <span class="c1"># edf = PD.DataFrame(tmp2, columns=[&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;,&#39;_id2&#39;])</span>
    <span class="c1"># return edf</span>
    
<div class="viewcode-block" id="fixedges_m"><a class="viewcode-back" href="../../modules.html#jgem.assembler.fixedges_m">[docs]</a><span class="k">def</span> <span class="nf">fixedges_m</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">me</span><span class="p">,</span><span class="n">bwname</span><span class="p">,</span><span class="n">pr</span><span class="p">,</span><span class="n">chrom</span><span class="p">):</span>
    <span class="c1"># input me: exons only need to be fixed in one direction (kind: s,e,f)</span>
    <span class="c1"># startswith [ =&gt; &#39;+&#39;, endswith ] =&gt; &#39;-&#39;</span>
    <span class="n">edgedet</span> <span class="o">=</span> <span class="n">EdgeDetector</span><span class="p">(</span><span class="n">bwname</span><span class="p">,</span>
                        <span class="n">sigmath</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_sigma&#39;</span><span class="p">],</span>
                        <span class="n">minth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_minth&#39;</span><span class="p">],</span>
                        <span class="n">covratio</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_covratio&#39;</span><span class="p">],</span>
                        <span class="n">winsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_window&#39;</span><span class="p">],</span>
                        <span class="n">covth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_covth&#39;</span><span class="p">],</span>
                        <span class="n">gapth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">],</span>
                        <span class="n">gap</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">],</span>
                        <span class="n">smwinsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_smwinsize&#39;</span><span class="p">],</span>
                        <span class="n">minintsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_minintsize&#39;</span><span class="p">],</span>
                        <span class="n">aggregateratio</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_aggratio&#39;</span><span class="p">],</span>
                        <span class="n">mimath</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_mimath&#39;</span><span class="p">],</span>
                        <span class="n">mimath2</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_mimath2&#39;</span><span class="p">],</span>                        
                        <span class="n">triggerth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_triggerth&#39;</span><span class="p">])</span>
    <span class="n">cicols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">edgedet</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">d</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">cicols</span><span class="p">):</span>
                <span class="n">cuts</span> <span class="o">=</span> <span class="n">edgedet</span><span class="o">.</span><span class="n">cutone</span><span class="p">(</span><span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span><span class="p">,</span><span class="n">d</span><span class="p">)</span>
                <span class="c1"># left</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="c1"># 0: left</span>
                <span class="c1"># right </span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="c1"># 1: right</span>
                <span class="c1"># both</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span> <span class="ow">in</span> <span class="n">cuts</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st1</span><span class="p">,</span><span class="n">ed1</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="c1"># 2: both</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">_gen</span><span class="p">()]</span>
    <span class="c1">#LOG.debug(&#39;cut ci2 {2}: {0}=&gt;{1}&#39;.format(len(ci),len(tmp),chrom))</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">,</span><span class="s1">&#39;side&#39;</span><span class="p">,</span><span class="s1">&#39;direction&#39;</span><span class="p">])</span>
    <span class="c1"># now put them together as exons</span>
    <span class="c1"># eid (_id2 in me) &lt;=&gt; cid (in df): encoded in df[name]</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
    <span class="n">dff</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">flattendf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;eid&#39;</span><span class="p">)</span>
    <span class="c1"># eid=&gt;strand, eid=&gt;name</span>
    <span class="n">e2strand</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]))</span>
    <span class="n">e2name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]))</span>
    <span class="n">e2st</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">]))</span> 
    <span class="n">e2ed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">]))</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2strand</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;ename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2name</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;est&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2st</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">e2ed</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dff</span><span class="p">[</span><span class="s1">&#39;eid&#39;</span><span class="p">]]</span>
    <span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">])</span>
    <span class="k">def</span> <span class="nf">_egen</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">eid</span><span class="p">,</span> <span class="n">gr</span> <span class="ow">in</span> <span class="n">dff</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">gr</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">gr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;side&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span><span class="c1"># no cut</span>
                <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">cid</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;cid&#39;</span><span class="p">]]</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">cids</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">gr</span><span class="p">[</span><span class="s1">&#39;cid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
            <span class="n">gri</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;cid&#39;</span><span class="p">)</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="n">gr</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span>
            <span class="c1"># only do left or right depending on direction</span>
            <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="c1"># left </span>
                <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">:</span>
                    <span class="n">gci</span> <span class="o">=</span> <span class="n">gri</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="n">cid</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
                    <span class="c1"># side 0</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">s0</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">s0</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                            <span class="n">n1</span> <span class="o">=</span> <span class="s1">&#39;{0}*(l{1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">cnt</span><span class="p">)</span>
                            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># if not side 2 break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s2</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">cid</span><span class="o">==</span><span class="n">cids</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span> <span class="c1"># last one all connected</span>
                            <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># right</span>
                <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="n">cids</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">gci</span> <span class="o">=</span> <span class="n">gri</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="n">cid</span><span class="p">]]</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;side&#39;</span><span class="p">)</span>
                    <span class="c1"># side 1</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">s1</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="ow">in</span> <span class="n">s1</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                            <span class="n">n1</span> <span class="o">=</span> <span class="s1">&#39;(r{1})*{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">cnt</span><span class="p">)</span>
                            <span class="n">cnt</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n1</span><span class="p">,</span><span class="n">cid</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                    <span class="c1"># if not side 2 break</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">s2</span> <span class="o">=</span> <span class="n">gci</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">cid</span><span class="o">==</span><span class="n">cids</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="c1"># last one all connected</span>
                            <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">r</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">eid</span><span class="p">)</span>                        
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">break</span>
    <span class="n">tmp2</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_egen</span><span class="p">()]</span>
    <span class="c1">#LOG.debug(&#39;cut ex {2}: {0}=&gt;{1}&#39;.format(len(me),len(tmp2),chrom))</span>
    <span class="k">return</span> <span class="n">tmp2</span></div>
    <span class="c1"># edf = PD.DataFrame(tmp2, columns=[&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;,&#39;_id2&#39;])</span>
    <span class="c1"># return edf</span>

<div class="viewcode-block" id="FINDEDGES"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDEDGES">[docs]</a><span class="k">class</span> <span class="nc">FINDEDGES</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find edge exons. (Add * to the name when cut.)</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :me: exon dataframe with edge exons added</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * mpth: mapped% th for detecting gene boundary, default:{mpth} (merging: {mpth_m})</span>
<span class="sd">        * binth: default {binth} (merging: {binth_m})</span>
<span class="sd">        * gap: fill this gap to distinguish gene boundary vs. exon (fill exon but not intergenic)</span>
<span class="sd">          default {gap} (merging: {gap_m})</span>
<span class="sd">        * edgesize: temporary edge exon size, default {edgesize}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * fe.sjbb.bed.gz</span>
<span class="sd">        * fe.sjbb-ovl.txt.gz</span>
<span class="sd">        * fe.exons.bed.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FINDEDGES.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDEDGES.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sjexdf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap&#39;</span><span class="p">]</span>
        <span class="n">edgesize</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;edgesize&#39;</span><span class="p">]</span>

        <span class="c1"># covarage file</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">])</span>
        <span class="n">gapfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillgap</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">binfile</span><span class="p">)</span>

        <span class="c1"># write sjex bounded both</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">sjexdf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">sjexdf</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="n">sjbb</span> <span class="o">=</span> <span class="n">sjexdf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">sjbbname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">sjbb</span><span class="p">,</span> <span class="s1">&#39;findedges.sjbb&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        
        <span class="c1"># bedtools intersect</span>
        <span class="n">ovlname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findedges.sjbb-ovl&#39;</span><span class="p">)</span>
        <span class="n">bbg</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span><span class="n">sjbbname</span><span class="p">,</span> <span class="n">gapfile</span><span class="p">,</span> <span class="n">ovlname</span><span class="p">,</span> <span class="n">nacol</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        
        <span class="c1"># write internal exons (&gt;pr[&#39;mpth&#39;])</span>
        <span class="n">inexs</span> <span class="o">=</span> <span class="n">bbg</span><span class="p">[</span><span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;mpth&#39;</span><span class="p">]]</span>

        <span class="c1"># turn ones with ratio&lt;pr[&#39;mpth&#39;] into edges and write together with </span>
        <span class="c1"># other edge exons</span>
        <span class="n">edexs1</span> <span class="o">=</span> <span class="n">sjexdf</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">bbg</span><span class="p">[</span><span class="n">bbg</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&lt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;mpth&#39;</span><span class="p">]]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="c1"># [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;]</span>
        <span class="n">cols0</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">_iter_edges</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="n">cols0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="c1"># name = [(strand)(counter)(kind)]</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">st</span><span class="o">+</span><span class="n">edgesize</span><span class="p">,</span><span class="n">name</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">strand</span><span class="p">)</span> 
                    <span class="c1"># name = [(strand)(counter)(kind)*</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">ed</span><span class="o">-</span><span class="n">edgesize</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span><span class="n">ratio</span><span class="p">,</span><span class="n">strand</span><span class="p">)</span> 
                    <span class="c1"># name = *(strand)(counter)(kind)]</span>
            <span class="n">edexs2</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_iter_edges</span><span class="p">()],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span><span class="p">)</span>
            <span class="n">edexs</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">edexs1</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">edexs2</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">edexs</span> <span class="o">=</span> <span class="n">edexs1</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
        <span class="n">edexs</span> <span class="o">=</span> <span class="n">edexs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">edexs</span> <span class="o">=</span> <span class="n">edexs</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">],</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        
        <span class="c1"># return concat</span>
        <span class="n">exons</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">inexs</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">edexs</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#return exons</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="s1">&#39;findedges.exons&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">exons</span></div></div>

<div class="viewcode-block" id="FIXSTRAND"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIXSTRAND">[docs]</a><span class="k">class</span> <span class="nc">FIXSTRAND</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Assign strand to unstranded elements using information from connected components.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        me: exon dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: junction dataframe with strand fixed</span>
<span class="sd">        :me: exon dataframe with strand fixed</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * useallconnected (bool): whether to use all connected components or just direct neighbors</span>
<span class="sd">          default {useallconnected}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * sj0.bed.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FIXSTRAND.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIXSTRAND.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        
        <span class="n">useallconnected</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;useallconnected&#39;</span><span class="p">]</span>
        <span class="c1"># ureadth = pr[&#39;ureadth&#39;]</span>
        <span class="c1"># mreadth = pr[&#39;mreadth&#39;]</span>
        <span class="c1"># sj = sj[((sj[&#39;ureads&#39;]&gt;ureadth)|(sj[&#39;mreads&#39;]&gt;mreadth))].copy()</span>
        
        <span class="n">mg</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">MEGraph2</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">me</span><span class="p">)</span> <span class="c1"># connections</span>
        <span class="c1"># fix unstranded exons</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">useallconnected</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">mg</span><span class="o">.</span><span class="n">ex_ex</span><span class="p">(</span><span class="n">x</span><span class="p">)][</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="p">(</span><span class="n">me</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">mg</span><span class="o">.</span><span class="n">connected</span><span class="p">(</span><span class="n">x</span><span class="p">)][</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;#unstranded={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FIXSTRAND.#unstranded_exons_before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">me</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cnt</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;#unstranded_exons_after={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FIXSTRAND.#unstranded_exons_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="c1"># make sure there&#39;s no missing strand col</span>
        <span class="n">me</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">(),</span> <span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="c1"># fix unstranded junctions</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="p">[</span><span class="n">Counter</span><span class="p">(</span><span class="n">mg</span><span class="o">.</span><span class="n">sj_ex</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;#unstranded junctions={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FIXSTRAND.#unstranded_junctions_before&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="n">sj</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">most_common</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;.&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cnt</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;#still unstranded={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FIXSTRAND.#unstranded_junctions_after&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;discarding {0} still unstranded junctions...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)))</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1">#return sj, me</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="s1">&#39;fixstrand.sj&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span></div></div>

<div class="viewcode-block" id="fixedge"><a class="viewcode-back" href="../../modules.html#jgem.assembler.fixedge">[docs]</a><span class="k">def</span> <span class="nf">fixedge</span><span class="p">(</span><span class="n">posarr</span><span class="p">,</span><span class="n">exs</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">gap</span><span class="p">,</span><span class="n">utr</span><span class="p">,</span><span class="n">ignorefirstdonors</span><span class="p">,</span><span class="n">covfactor</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
        <span class="n">NAME</span> <span class="o">=</span> <span class="p">{</span><span class="bp">True</span><span class="p">:{</span><span class="s1">&#39;gap_too_large&#39;</span><span class="p">:</span><span class="s1">&#39;==&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;assertfail_2_donor&#39;</span><span class="p">:</span><span class="s1">&#39;=D&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;assertfail_2_bined&#39;</span><span class="p">:</span><span class="s1">&#39;=B&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;acceptor&#39;</span><span class="p">:</span><span class="s1">&#39;_a&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;donor&#39;</span><span class="p">:</span><span class="s1">&#39;=d]&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;opposite&#39;</span><span class="p">:</span><span class="s1">&#39;_o&#39;</span><span class="p">},</span>
                <span class="bp">False</span><span class="p">:{</span><span class="s1">&#39;gap_too_large&#39;</span><span class="p">:</span><span class="s1">&#39;==&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;assertfail_2_donor&#39;</span><span class="p">:</span><span class="s1">&#39;D=&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;assertfail_2_bined&#39;</span><span class="p">:</span><span class="s1">&#39;B=&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;acceptor&#39;</span><span class="p">:</span><span class="s1">&#39;a_&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;donor&#39;</span><span class="p">:</span><span class="s1">&#39;[d=&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;opposite&#39;</span><span class="p">:</span><span class="s1">&#39;o_&#39;</span><span class="p">}}</span>
        <span class="n">flag</span> <span class="o">=</span> <span class="p">((</span><span class="n">strand</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">utr</span><span class="o">==</span><span class="s1">&#39;3pr&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">strand</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">utr</span><span class="o">==</span><span class="s1">&#39;5pr&#39;</span><span class="p">))</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">flag</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">def</span> <span class="nf">_nposkind</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
            <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">posarr</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">i</span><span class="p">][[</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;kind&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">cov</span> <span class="c1"># remove initial one char which was for sorting</span>

        <span class="k">def</span> <span class="nf">_step1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">dcp</span><span class="p">):</span><span class="c1"># look for bined or donor</span>
            <span class="c1"># (None(close) or newpos, reason(kind), newidx, coverage)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">posarr</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="s1">&#39;outofrange_1&#39;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.</span>
            <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_nposkind</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">while</span><span class="p">((</span><span class="n">kind</span><span class="o">==</span><span class="s1">&#39;acceptor&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">kind</span><span class="o">==</span><span class="s1">&#39;binst&#39;</span><span class="p">)</span><span class="o">|</span><span class="p">((</span><span class="n">kind</span><span class="o">==</span><span class="s1">&#39;donor&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">delta</span><span class="o">*</span><span class="p">(</span><span class="n">dcp</span><span class="o">-</span><span class="n">npos</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">))):</span> 
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">posarr</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="s1">&#39;outofrange_1&#39;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.</span>
                <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_nposkind</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="c1">#if kind==&#39;binst&#39;: # this cannot be the case&lt;== actually if using different gap then happens</span>
            <span class="c1">#    return None,&#39;assertfail_1_binst&#39;,i+1, cov</span>
            <span class="k">if</span> <span class="n">kind</span><span class="o">==</span><span class="s1">&#39;opposite&#39;</span><span class="p">:</span> <span class="c1"># stop here</span>
                <span class="k">return</span> <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span>
            <span class="c1"># the rests are bined and donor, prioritize donor</span>
            <span class="k">while</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">posarr</span><span class="p">)):</span>
                <span class="n">npos2</span><span class="p">,</span> <span class="n">kind2</span><span class="p">,</span> <span class="n">cov2</span> <span class="o">=</span> <span class="n">_nposkind</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npos2</span> <span class="o">!=</span> <span class="n">npos</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1">#if kind2==&#39;donor&#39;:</span>
                <span class="c1">#    kind = &#39;donor&#39;</span>
            <span class="k">return</span> <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cov</span> <span class="c1"># i+1 is next pos so return i</span>

        <span class="k">def</span> <span class="nf">_step2</span><span class="p">(</span><span class="n">i</span><span class="p">):</span><span class="c1"># look for next interval</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="nb">len</span><span class="p">(</span><span class="n">posarr</span><span class="p">)):</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="s1">&#39;outofrange_2&#39;</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.</span>
            <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">cov</span> <span class="o">=</span> <span class="n">_nposkind</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">kind</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;bined&#39;</span><span class="p">,</span><span class="s1">&#39;donor&#39;</span><span class="p">]:</span> <span class="c1"># this cannot be the case</span>
                <span class="k">return</span> <span class="bp">None</span><span class="p">,</span><span class="s1">&#39;assertfail_2_&#39;</span><span class="o">+</span><span class="n">kind</span><span class="p">,</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span>
            <span class="c1"># the rests are binst, acceptor, or opposite</span>
            <span class="k">return</span> <span class="n">npos</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">cov</span>

        <span class="k">def</span> <span class="nf">_next</span><span class="p">(</span><span class="n">cpos</span><span class="p">,</span><span class="n">i0</span><span class="p">,</span><span class="n">donorcheckpos</span><span class="p">,</span><span class="n">cov1</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="c1"># cpos: current end of interval could be None</span>
            <span class="c1"># i0: current index pos into posarr</span>
            <span class="c1"># donorcheckpos: (for SE attachment) ignore donor within this </span>
            <span class="c1"># cov1: current coverage, could be None</span>

            <span class="c1"># cpos only updated at bined (end of interval) or at donor </span>

            <span class="n">npos1</span><span class="p">,</span> <span class="n">kind1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">cov1n</span> <span class="o">=</span> <span class="n">_step1</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span><span class="n">donorcheckpos</span><span class="p">)</span> <span class="c1"># step1 find ends</span>
            <span class="k">if</span> <span class="n">cov1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">cov1</span> <span class="o">=</span> <span class="n">cov1n</span>
            <span class="k">if</span> <span class="n">npos1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># didn&#39;t find end=&gt; close at current end</span>
                <span class="c1"># (close?, cur_end_pos, reason, cur_idx, coverage)</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">kind1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">cov1</span><span class="p">)</span> 
            <span class="k">if</span> <span class="n">kind1</span><span class="o">==</span><span class="s1">&#39;bined&#39;</span><span class="p">:</span> <span class="c1"># found end of an interval</span>
                <span class="c1"># but it could be an interval that we ignored, so check coverage</span>
                <span class="k">if</span> <span class="n">cov1</span><span class="o">*</span><span class="n">covfactor</span> <span class="o">&lt;=</span> <span class="n">cov1n</span><span class="p">:</span> <span class="c1"># update pos/ use &#39;&lt;= &#39; so that cov1=cov1n=0 is ok</span>
                    <span class="n">cpos</span> <span class="o">=</span> <span class="n">npos1</span>
                <span class="c1"># then find the start of the next interval</span>
                <span class="n">npos2</span><span class="p">,</span> <span class="n">kind2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">cov2</span> <span class="o">=</span> <span class="n">_step2</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">npos2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">kind2</span><span class="o">==</span><span class="s1">&#39;outofrange_2&#39;</span><span class="p">:</span> <span class="c1"># no further intervals</span>
                        <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span><span class="s1">&#39;gap_too_large&#39;</span><span class="p">,</span><span class="n">i1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c1"># close at current pos</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">kind2</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c1"># assert fail</span>
                <span class="c1"># kind2 must be binst or acceptor or opposite</span>
                <span class="k">if</span> <span class="n">kind2</span><span class="o">==</span><span class="s1">&#39;binst&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">npos2</span><span class="o">-</span><span class="n">cpos</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">gap</span><span class="p">:</span> <span class="c1"># keep moving</span>
                        <span class="k">return</span> <span class="p">(</span><span class="bp">False</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="s1">&#39;binst&#39;</span><span class="p">,</span> <span class="n">i2</span><span class="p">,</span> <span class="n">cov1</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="s1">&#39;gap_too_large&#39;</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="c1"># close</span>
                <span class="c1"># kind2 must be acceptor or opposite, close</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">kind2</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> 
            <span class="c1"># must be donor or opposite, close</span>
            <span class="k">if</span> <span class="n">kind1</span><span class="o">==</span><span class="s1">&#39;donor&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cov1</span><span class="o">*</span><span class="n">covfactor</span> <span class="o">&lt;=</span> <span class="n">cov1n</span><span class="p">:</span> <span class="c1"># update pos/ use &#39;&lt;= &#39; so that cov1=cov1n=0 is ok</span>
                    <span class="n">cpos</span> <span class="o">=</span> <span class="n">npos1</span>                
                <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">kind1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> 
            <span class="c1"># must be opposite</span>
            <span class="k">return</span> <span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">cpos</span><span class="p">,</span> <span class="n">kind1</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> 


        <span class="c1"># ex: [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,...]</span>
        <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
            <span class="n">tgt</span><span class="p">,</span><span class="n">tgt2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span><span class="mi">2</span> <span class="c1"># st, ed</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tgt</span><span class="p">,</span><span class="n">tgt2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span><span class="mi">1</span> <span class="c1"># ed, st</span>
        <span class="k">for</span> <span class="n">ex</span> <span class="ow">in</span> <span class="n">exs</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">tgt</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ignorefirstdonors</span><span class="p">:</span>
                <span class="n">donorcheckpos</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">tgt2</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">donorcheckpos</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">tgt</span><span class="p">]</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">posarr</span><span class="p">[</span><span class="n">posarr</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">pos</span><span class="p">][</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1">#LOG.debug(&#39;======= initial pos={0}&#39;.format(pos))</span>
            <span class="n">close</span><span class="p">,</span><span class="n">npos</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">i0</span><span class="p">,</span><span class="n">cov</span> <span class="o">=</span> <span class="n">_next</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">i0</span><span class="p">,</span><span class="n">donorcheckpos</span><span class="p">,</span><span class="bp">None</span><span class="p">)</span>
            <span class="k">while</span><span class="p">(</span><span class="ow">not</span> <span class="n">close</span><span class="p">):</span>
                <span class="n">close</span><span class="p">,</span><span class="n">npos</span><span class="p">,</span><span class="n">kind</span><span class="p">,</span><span class="n">i0</span><span class="p">,</span><span class="n">cov</span> <span class="o">=</span> <span class="n">_next</span><span class="p">(</span><span class="n">npos</span><span class="p">,</span><span class="n">i0</span><span class="p">,</span><span class="n">donorcheckpos</span><span class="p">,</span><span class="n">cov</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">npos</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">npos</span><span class="o">!=</span><span class="n">pos</span><span class="p">):</span> <span class="c1"># yield if there&#39;s end</span>
                <span class="k">if</span> <span class="n">flag</span><span class="p">:</span>
                    <span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">+</span><span class="n">NAME</span><span class="p">[</span><span class="n">flag</span><span class="p">][</span><span class="n">kind</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">NAME</span><span class="p">[</span><span class="n">flag</span><span class="p">][</span><span class="n">kind</span><span class="p">]</span><span class="o">+</span><span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                <span class="n">ex</span><span class="p">[</span><span class="n">tgt2</span><span class="p">]</span> <span class="o">=</span> <span class="n">npos</span>
                <span class="k">if</span> <span class="n">kind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;assert&#39;</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  error:{0}/{1}/{2}/{3}/{4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">exid</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">kind</span><span class="p">,</span> <span class="n">npos</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span><span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">posarr</span><span class="p">[</span><span class="n">i0</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
                <span class="k">yield</span> <span class="n">ex</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#if printerr:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  error:{0}/{1}/{2}/{3}/{4}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">exid</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span> <span class="n">kind</span><span class="p">,</span> <span class="n">npos</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span><span class="n">ex</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">kind</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;outofrange&#39;</span><span class="p">):</span>
                    <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">posarr</span><span class="p">[</span><span class="n">i0</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
    
    <span class="n">rslt</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_gen</span><span class="p">()]</span>    
    <span class="k">return</span> <span class="n">rslt</span></div>
        
<div class="viewcode-block" id="EDGEFIXER"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER">[docs]</a><span class="k">class</span> <span class="nc">EDGEFIXER</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fix edge exons by extending.</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        :me: exon dataframe with edge exons fixed</span>
<span class="sd">        :edgefixer: this instance for reuse later</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * gap3: for 3&#39; UTR extension, default {gap3} (merging: {gap3_m})</span>
<span class="sd">        * gap5: for 5&#39; UTR extension, default {gap5} (merging: {gap5_m})</span>
<span class="sd">        * covfactor: for gap filling: if coverage of the next interval is &lt; covfactor*current cov</span>
<span class="sd">          default {covfactor}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * fixed5pr.bed.gz</span>
<span class="sd">        * fixed3pr.bed.gz</span>
<span class="sd">        * edgefixer.me.bed.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># [TODO]</span>
    <span class="c1"># - how to distinguish gaps in real 3&#39;UTRs vs. gaps between genes or within exons?</span>
    <span class="c1">#   =&gt; use coverage information?</span>
    <span class="c1">#   =&gt; EDGEFIXER2 does this</span>
    
<div class="viewcode-block" id="EDGEFIXER.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span><span class="p">[</span><span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]]</span> <span class="c1"># part of the code assumes standard BED order</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        
        <span class="n">gap3</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap3&#39;</span><span class="p">]</span>
        <span class="n">gap5</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap5&#39;</span><span class="p">]</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
        <span class="n">covfactor</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;covfactor&#39;</span><span class="p">]</span>

        <span class="c1"># make interval bed with strand info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bindf</span> <span class="o">=</span> <span class="n">bindf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_bindf</span><span class="p">(</span><span class="n">me</span><span class="p">)</span> <span class="c1">#sname, exons, binth=binth, override=override)</span>
        
        <span class="c1"># 3prime</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;edgefixer.fixed3pr&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; fixing 3pr exons...&#39;</span><span class="p">)</span>
            <span class="n">fixed3pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_edges</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">bindf</span><span class="p">,</span> <span class="n">utr</span><span class="o">=</span><span class="s1">&#39;3pr&#39;</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap3</span><span class="p">,</span><span class="n">covfactor</span><span class="o">=</span><span class="n">covfactor</span><span class="p">)</span>
            <span class="n">GGB</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">fixed3pr</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; reading cached fixed3pr ...&#39;</span><span class="p">)</span>
            <span class="n">fixed3pr</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="c1"># find reconnected and remove the other side</span>
        
        <span class="k">def</span> <span class="nf">_remove</span><span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">me</span><span class="p">):</span>
            <span class="n">tmp0</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">[</span><span class="n">fixed</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;*=d]&#39;</span><span class="p">)]</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">fixed</span><span class="p">[</span><span class="n">fixed</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[d=*&#39;</span><span class="p">)]</span>
            <span class="n">remove0</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;]&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">tmp0</span><span class="p">,[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])])</span>
            <span class="n">remove1</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="s1">&#39;[&#39;</span><span class="o">+</span><span class="n">x</span><span class="p">[</span><span class="mi">4</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">p</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">tmp1</span><span class="p">,[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">])])</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  removing {0}/{1}: me len={2}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">remove0</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">remove1</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">me</span><span class="p">)))</span>
            <span class="n">me0a</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">remove0</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="n">me1a</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">remove1</span><span class="o">.</span><span class="n">keys</span><span class="p">())]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  me0a({0}), me1a({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">me0a</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">me1a</span><span class="p">)))</span>
            <span class="n">me0b</span> <span class="o">=</span> <span class="n">me0a</span><span class="p">[</span><span class="n">me0a</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">==</span><span class="p">[</span><span class="n">remove0</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">me0a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]]</span>
            <span class="n">me1b</span> <span class="o">=</span> <span class="n">me1a</span><span class="p">[</span><span class="n">me1a</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">==</span><span class="p">[</span><span class="n">remove1</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">me1a</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]]]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  me0b({0}), me1b({1})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">me0b</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">me1b</span><span class="p">)))</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">me0b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="n">me1b</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">idx0</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  idx0({0}), idx1({1}))&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx0</span><span class="p">),</span><span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx1</span><span class="p">)))</span>
            <span class="n">me1</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="o">~</span><span class="n">idx1</span><span class="p">]</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  after removing: me len={0} diff={1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">me1</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">me</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">me1</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">me1</span>
            
        <span class="n">me</span> <span class="o">=</span> <span class="n">_remove</span><span class="p">(</span><span class="n">fixed3pr</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
        
        <span class="c1"># 5prime</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;edgefixer.fixed5pr&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)):</span> 
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; fixing 5pr exons...&#39;</span><span class="p">)</span>
            <span class="n">fixed5pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_edges</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">bindf</span><span class="p">,</span><span class="n">utr</span><span class="o">=</span><span class="s1">&#39;5pr&#39;</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap5</span><span class="p">,</span><span class="n">covfactor</span><span class="o">=</span><span class="n">covfactor</span><span class="p">)</span>
            <span class="n">GGB</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">fixed5pr</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; reading cached fixed5pr ...&#39;</span><span class="p">)</span>
            <span class="n">fixed5pr</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">_remove</span><span class="p">(</span><span class="n">fixed5pr</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
        
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">inexs</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;i&#39;</span><span class="p">]</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">fixed3pr</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">fixed5pr</span><span class="p">)</span>
        

        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span>
        <span class="n">nexons</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">inexs</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">fixed3pr</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">fixed5pr</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nexons</span> <span class="o">=</span> <span class="n">nexons</span> <span class="o">=</span> <span class="n">nexons</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ptyp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1">#return nexons</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">nexons</span><span class="p">,</span> <span class="s1">&#39;edgefixer.me&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">nexons</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">edgefixer</span> <span class="o">=</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="EDGEFIXER.fixSEedge"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER.fixSEedge">[docs]</a>    <span class="k">def</span> <span class="nf">fixSEedge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">utr</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="k">if</span> <span class="n">utr</span><span class="o">==</span><span class="s1">&#39;3pr&#39;</span><span class="p">:</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap3&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gap</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;gap5&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_edges_subset</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bindf</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">utr</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">covfactor</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;covfactor&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="EDGEFIXER.make_bindf"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER.make_bindf">[docs]</a>    <span class="k">def</span> <span class="nf">make_bindf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">):</span>
        <span class="c1">#sname, exons, binth=0, override=False</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>

        <span class="c1"># assign strand using exons</span>
        <span class="n">bfile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;edgefixer.bindf&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bfile</span><span class="p">))</span> <span class="ow">or</span> <span class="n">override</span><span class="p">:</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binstrand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">:</span>
                <span class="n">efile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s1">&#39;edgefixer.exons&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
                <span class="n">ofile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;edgefixer.bindf-exons&#39;</span><span class="p">)</span>
                <span class="n">ofile</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolintersect</span><span class="p">(</span><span class="n">binfile</span><span class="p">,</span><span class="n">efile</span><span class="p">,</span><span class="n">ofile</span><span class="p">,</span><span class="n">wao</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;ex_chr&#39;</span><span class="p">,</span><span class="s1">&#39;ex_st&#39;</span><span class="p">,</span><span class="s1">&#39;ex_ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ovl&#39;</span><span class="p">]</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">ofile</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
                <span class="n">tg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])</span>
                <span class="n">t2</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="c1"># choose first, then fix intervals with multiple elements</span>
                <span class="n">t2s</span> <span class="o">=</span> <span class="n">tg</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
                <span class="n">tidx</span> <span class="o">=</span> <span class="n">t2s</span><span class="p">[</span><span class="n">t2s</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># one with more than 1 overlapping element</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">tidx</span><span class="p">]</span>
                <span class="n">cnt</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">index</span><span class="p">)[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">sidx</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">[</span><span class="n">cnt</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">index</span> <span class="c1"># more than one strand</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sidx</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">t2</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">sidx</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span> <span class="c1"># multiple strand over this inverval =&gt; set to &#39;.&#39;</span>
                <span class="n">t3</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;ovl&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]]</span>
                <span class="n">t4</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_mp</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> <span class="n">bfile</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
                <span class="c1"># clean up</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">efile</span><span class="p">)</span>
                <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">t4</span> 
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">binfile</span><span class="p">)</span> <span class="c1"># chr,st,ed</span>
                <span class="n">df</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binstrand&#39;</span><span class="p">]</span>
                <span class="n">UT</span><span class="o">.</span><span class="n">save_tsv_nidx_whead</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">bfile</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">bfile</span><span class="p">)</span></div>
        <span class="c1"># subtract internal exons ...=&gt; wasn&#39;t a good idea</span>
        <span class="c1">#     inexfile = os.path.join(MD.SJEXDIR, sname+&#39;.sj.inex.bed.gz&#39;)</span>
        <span class="c1">#     binfile2 = os.path.join(MD.SJEXDIR, sname+&#39;.bindf.bed&#39;)</span>
        <span class="c1">#     if (not os.path.exists(binfile2+&#39;.gz&#39;)) or override:</span>
        <span class="c1">#         BT.bedtoolsubtract(binfile, inexfile, binfile2)</span>
        <span class="c1">#     return GGB.read_bed(binfile2+&#39;.gz&#39;)</span>

    <span class="k">def</span> <span class="nf">_make_arr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">bindf</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">utr</span><span class="o">=</span><span class="s1">&#39;3pr&#39;</span><span class="p">):</span>
        <span class="n">binchr</span> <span class="o">=</span> <span class="n">bindf</span><span class="p">[(</span><span class="n">bindf</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">bindf</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="n">strand</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]))]</span>
        <span class="n">exchr</span> <span class="o">=</span> <span class="n">exons</span><span class="p">[(</span><span class="n">exons</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">exons</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">)]</span>
        <span class="c1">#exchr2 = exons[(exons[&#39;chr&#39;]==chrom)&amp;(exons[&#39;strand&#39;]!=strand)] # opposite strand</span>
        <span class="n">lex</span> <span class="o">=</span> <span class="n">exchr</span><span class="p">[</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">)]</span>
        <span class="n">rex</span> <span class="o">=</span> <span class="n">exchr</span><span class="p">[</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)]</span>
        <span class="k">def</span> <span class="nf">_todf</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">tgt</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">tgt</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;pos&#39;</span><span class="p">])</span>
            <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">if</span> <span class="s1">&#39;cov&#39;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tmp</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">return</span> <span class="n">tmp</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">strand</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">utr</span><span class="o">==</span><span class="s1">&#39;3pr&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">((</span><span class="n">strand</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">utr</span><span class="o">==</span><span class="s1">&#39;5pr&#39;</span><span class="p">))</span> <span class="p">:</span>
            <span class="n">posarr</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_todf</span><span class="p">(</span><span class="n">binchr</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;2binst&#39;</span><span class="p">),</span> <span class="c1"># going right direction</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">binchr</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;2bined&#39;</span><span class="p">),</span> 
                                <span class="c1"># make sure acceptor/donor comes before binst/ed (initial 1&amp;2)</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">lex</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;1acceptor&#39;</span><span class="p">),</span> 
                                <span class="c1"># 5pr donor regard as acceptor for the purpose of edge extension</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">rex</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;1donor&#39;</span><span class="p">),</span>
                                <span class="c1">#_todf(exchr2,&#39;st&#39;,&#39;opposite&#39;)</span>
                               <span class="p">],</span>
                               <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;kind&#39;</span><span class="p">])</span>
            <span class="n">eidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span><span class="c1"># (-,3&#39;) or (+,5&#39;)</span>
            <span class="n">posarr</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">_todf</span><span class="p">(</span><span class="n">binchr</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;1bined&#39;</span><span class="p">),</span> <span class="c1"># going left direction</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">binchr</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;1binst&#39;</span><span class="p">),</span>
                                <span class="c1"># since going opposite direction acceptor/donor after binst/ed</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">lex</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;2donor&#39;</span><span class="p">),</span>
                                <span class="n">_todf</span><span class="p">(</span><span class="n">rex</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;2acceptor&#39;</span><span class="p">),</span>
                                <span class="c1">#_todf(exchr2,&#39;ed&#39;,&#39;opposite&#39;)</span>
                               <span class="p">],</span>
                               <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span><span class="s1">&#39;kind&#39;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="n">eidx</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">exchr</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="n">exs</span> <span class="o">=</span> <span class="n">exchr</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span>
        <span class="n">posarr</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">posarr</span><span class="p">))</span>
        <span class="n">posarr</span><span class="p">[</span><span class="s1">&#39;idx&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">posarr</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> <span class="c1">#N.arange(len(posarr))</span>
        <span class="k">return</span> <span class="n">posarr</span><span class="p">,</span> <span class="n">exs</span>


<div class="viewcode-block" id="EDGEFIXER.process_edges"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER.process_edges">[docs]</a>    <span class="k">def</span> <span class="nf">process_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">bindf</span><span class="p">,</span> <span class="n">utr</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">covfactor</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  preparing data...&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">exons</span><span class="p">):</span> <span class="c1"># exons[&#39;chr&#39;].unique():</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]:</span>
                <span class="n">posarr</span><span class="p">,</span> <span class="n">exs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_arr</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">bindf</span><span class="p">,</span><span class="n">exons</span><span class="p">,</span><span class="n">utr</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">exs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">posarr</span><span class="p">,</span> <span class="n">exs</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">utr</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">covfactor</span><span class="p">))</span><span class="c1">#,printerr))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">fixedge</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># if np==1:</span>
        <span class="c1">#     for arg in args:</span>
        <span class="c1">#         rslts += fixedge(arg)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         p = multiprocessing.Pool(np)</span>
        <span class="c1">#         tmp = p.map(fixedge, args)</span>
        <span class="c1">#         LOG.debug(&#39;done fixEdge calculation: np={0}&#39;.format(np))</span>
        <span class="c1">#     finally:</span>
        <span class="c1">#         LOG.debug(&#39;closing pool&#39;)</span>
        <span class="c1">#         p.close()</span>
        <span class="c1">#     rslts = reduce(iadd, tmp)</span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">exons</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div>

<div class="viewcode-block" id="EDGEFIXER.process_edges_subset"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EDGEFIXER.process_edges_subset">[docs]</a>    <span class="k">def</span> <span class="nf">process_edges_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">bindf</span><span class="p">,</span> <span class="n">targets</span><span class="p">,</span> <span class="n">utr</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">covfactor</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  preparing data...&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">exons</span><span class="p">):</span> <span class="c1">#exons[&#39;chr&#39;].unique():</span>
            <span class="k">for</span> <span class="n">strand</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">]:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">posarr</span><span class="p">,</span> <span class="n">exs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_make_arr</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">bindf</span><span class="p">,</span><span class="n">exons</span><span class="p">,</span><span class="n">utr</span><span class="p">)</span>
                <span class="n">exs</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">posarr</span><span class="p">,</span> <span class="n">exs</span><span class="p">,</span> <span class="n">strand</span><span class="p">,</span> <span class="n">gap</span><span class="p">,</span> <span class="n">utr</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">covfactor</span><span class="p">))</span><span class="c1">#,printerr))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">fixedge</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># if np==1:</span>
        <span class="c1">#     for arg in args:</span>
        <span class="c1">#         rslts += fixedge(arg)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         p = multiprocessing.Pool(np)</span>
        <span class="c1">#         tmp = p.map(fixedge, args)</span>
        <span class="c1">#         LOG.debug(&#39;done fixEdge calculation: np={0}&#39;.format(np))</span>
        <span class="c1">#     finally:</span>
        <span class="c1">#         LOG.debug(&#39;closing pool&#39;)</span>
        <span class="c1">#         p.close()</span>
        <span class="c1">#     rslts = reduce(iadd, tmp)            </span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">targets</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FINDIRETS"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDIRETS">[docs]</a><span class="k">class</span> <span class="nc">FINDIRETS</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find intron retentions.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction DataFrame</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :me: exons with irets</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * iret_mpth: mapped% th for detecting intron retension,</span>
<span class="sd">          default {iret_mpth} (merging: {iret_mpth_m})</span>
<span class="sd">        * iret_covth: if intron cov smaller than this, then ignore</span>
<span class="sd">          default {iret_covth} (merging: {iret_covth_m})</span>
<span class="sd">        * iret_covratio: min cov ratio between an iret and average of surrounding exons </span>
<span class="sd">          default {iret_covratio} (merging: {iret_covratio_m})</span>
<span class="sd">        * binth: default {binth} (merging: {binth_m})</span>


<span class="sd">    TempFiles:</span>
<span class="sd">        * irets.bed.gz</span>
<span class="sd">        * irets.exons.txt.gz</span>
<span class="sd">        * irets.me.cov.txt.gz</span>
<span class="sd">        * irets.me.bed.gz</span>
<span class="sd">        * irets.me.covci.txt.gz</span>
<span class="sd">        * irets.me.ci.txt.gz</span>
<span class="sd">        * sj.iret.sub.bed.gz</span>
<span class="sd">        * sj.iret.ci.txt.gz</span>
<span class="sd">        * sj.iret.covci.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FINDIRETS.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDIRETS.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
        <span class="n">iretmpth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;iret_mpth&#39;</span><span class="p">]</span>
        <span class="n">binth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">]</span>
        
        <span class="n">dfname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findirets.irets&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dfname</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; finding iret...&#39;</span><span class="p">)</span>
            <span class="n">irets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_irets</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">mpth</span><span class="o">=</span><span class="n">iretmpth</span><span class="p">,</span> <span class="n">binth</span><span class="o">=</span><span class="n">binth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; reading cached iret...&#39;</span><span class="p">)</span>
            <span class="n">irets</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">dfname</span><span class="p">)</span>

        <span class="n">irets</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;r&#39;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s1">&#39;ptyp&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">me</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">nexons</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">irets</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nexons</span> <span class="o">=</span> <span class="n">nexons</span> <span class="o">=</span> <span class="n">nexons</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ptyp&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1">#return nexons</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">nexons</span><span class="p">,</span> <span class="s1">&#39;findirets.exons&#39;</span><span class="p">,</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">nexons</span></div>

<div class="viewcode-block" id="FINDIRETS.find_irets"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDIRETS.find_irets">[docs]</a>    <span class="k">def</span> <span class="nf">find_irets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">mpth</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> <span class="n">binth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
        <span class="c1"># covarage file</span>
        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">binth</span><span class="p">)</span>
        <span class="n">sjfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sjfile</span><span class="p">()</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.sj.mp&#39;</span><span class="p">)</span>
        <span class="n">sjmp</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">calc_ovlratio</span><span class="p">(</span>
            <span class="n">aname</span><span class="o">=</span><span class="n">sjfile</span><span class="p">,</span> 
            <span class="n">bname</span><span class="o">=</span><span class="n">binfile</span><span class="p">,</span> 
            <span class="n">tname</span><span class="o">=</span><span class="n">cname</span><span class="p">,</span> 
            <span class="n">nacol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> 
            <span class="n">nbcol</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="c1"># match records between sjmp and mg.sj</span>
        <span class="n">sjmp</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">calc_locus</span><span class="p">(</span><span class="n">sjmp</span><span class="p">)</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">calc_locus</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="n">sid2ovl</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">df2dict</span><span class="p">(</span><span class="n">sjmp</span><span class="p">,</span> <span class="s1">&#39;str_id&#39;</span><span class="p">,</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">)</span>
        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sid2ovl</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;str_id&#39;</span><span class="p">]]</span>
        <span class="k">if</span> <span class="s1">&#39;_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sj</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">sj</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">me</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;st_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sj</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;st_id&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">me</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_pos_info</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">me</span><span class="p">)</span> 

        <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">sj2</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">mpth</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># calc sj cov 1. subtract me, 2. calc_cov_ovl</span>
        <span class="n">mefile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s1">&#39;findirets.me&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">sjname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findirets.sj&#39;</span><span class="p">)</span>
        <span class="n">sjname</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">sj2</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st-1&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">]],</span> <span class="n">sjname</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findirets.sj.sub&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cname</span><span class="p">)):</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolsubtract</span><span class="p">(</span><span class="n">sjname</span><span class="p">,</span> <span class="n">mefile</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span> 
        <span class="c1"># bed: idcol=name, moreover </span>
        <span class="c1"># sj is reduced (some sj completely overlap with exon)</span>
        <span class="n">sj2</span> <span class="o">=</span> <span class="n">sj2</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">sub</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

        <span class="n">ciname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.sj.ci&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ciname</span><span class="p">)):</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">chopintervals</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">ciname</span><span class="p">,</span> <span class="n">idcol</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">)</span> 
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">ciname</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>

        <span class="n">covciname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.sj.covci&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">covciname</span><span class="p">)):</span>
            <span class="n">covci</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_mp</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> <span class="n">covciname</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covci</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">covciname</span><span class="p">)</span>

        <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">covci</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
        <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">covci</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>            
        <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;sjid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covci</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)])</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">flattendf</span><span class="p">(</span><span class="n">covci</span><span class="p">[[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="s1">&#39;sjid&#39;</span><span class="p">,</span><span class="s1">&#39;len&#39;</span><span class="p">,</span><span class="s1">&#39;val&#39;</span><span class="p">]],</span> <span class="s1">&#39;sjid&#39;</span><span class="p">)</span>
        <span class="n">covg</span> <span class="o">=</span> <span class="n">cov</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sjid&#39;</span><span class="p">)[[</span><span class="s1">&#39;len&#39;</span><span class="p">,</span><span class="s1">&#39;val&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">covg</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">covg</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">covg</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span>
        <span class="n">sj2cov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">df2dict</span><span class="p">(</span><span class="n">covg</span><span class="p">,</span> <span class="s1">&#39;sjid&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">)</span>
        <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">sj2cov</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]]</span>
        <span class="n">sj2</span> <span class="o">=</span> <span class="n">sj2</span><span class="p">[</span><span class="n">sj2</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;iret_covth&#39;</span><span class="p">]]</span>

        <span class="c1"># calc me cov</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.me.cov&#39;</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calculating ME cov...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_ovl_mp</span><span class="p">(</span>
                <span class="n">srcname</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> 
                <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> 
                <span class="n">dstname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.me.cov&#39;</span><span class="p">),</span> 
                <span class="n">override</span><span class="o">=</span><span class="n">override</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">],</span>
                <span class="n">covciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.me.covci&#39;</span><span class="p">),</span>
                <span class="n">ciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findirets.me.ci&#39;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">read_txt</span><span class="p">(</span><span class="s1">&#39;findirets.me.cov&#39;</span><span class="p">)</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">irets</span> <span class="o">=</span> <span class="n">irets</span> <span class="o">=</span> <span class="n">sj2</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#irets candidates:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">irets</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDIRETS.#irets_sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">irets</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">sj2</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">irets</span><span class="p">)</span></div>

<div class="viewcode-block" id="FINDIRETS.process_mp"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDIRETS.process_mp">[docs]</a>    <span class="k">def</span> <span class="nf">process_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">irets</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">covratio</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;iret_covratio&#39;</span><span class="p">]</span>
        <span class="n">covth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;iret_covth&#39;</span><span class="p">]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; preparing data...&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">me</span><span class="p">):</span>
            <span class="n">mechr</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;st_id&#39;</span><span class="p">,</span><span class="s1">&#39;ed_id&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">sjchr</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="n">sj</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;st_id&#39;</span><span class="p">,</span><span class="s1">&#39;ed_id&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">irchr</span> <span class="o">=</span> <span class="n">irets</span><span class="p">[</span><span class="n">irets</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;st_id&#39;</span><span class="p">,</span><span class="s1">&#39;ed_id&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]]</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sjchr</span><span class="p">,</span><span class="n">mechr</span><span class="p">,</span><span class="n">irchr</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">covratio</span><span class="p">,</span><span class="n">covth</span><span class="p">))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">findirets</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># np = pr[&#39;np&#39;]</span>
        <span class="c1"># if np==1:</span>
        <span class="c1">#     for i,arg in enumerate(args):</span>
        <span class="c1">#         tmp = findirets(arg)</span>
        <span class="c1">#         LOG.debug(&#39;  processing {3}: {0}/{1} {2}...&#39;.format(i+1,len(args),len(tmp),arg[3]))</span>
        <span class="c1">#         rslts += tmp</span>
        <span class="c1"># else:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         p = multiprocessing.Pool(np)</span>
        <span class="c1">#         tmp = p.map(findirets, args)</span>
        <span class="c1">#     finally:</span>
        <span class="c1">#         LOG.debug(&#39;  closing pool&#39;)</span>
        <span class="c1">#         p.close()</span>
        <span class="c1">#     rslts = reduce(iadd, tmp)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="c1"># [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;FINDIRETS.#irets_ex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rslts</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rslts</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">cols</span><span class="p">)</span>
            <span class="n">dfname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s1">&#39;findirets.irets&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;{0} irets found&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)))</span>
            <span class="k">return</span> <span class="n">df</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;******************** NO IRET FOUND!***********************&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">))),</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span> <span class="c1"># return empty dataframe</span></div></div>
               
<div class="viewcode-block" id="findirets"><a class="viewcode-back" href="../../modules.html#jgem.assembler.findirets">[docs]</a><span class="k">def</span> <span class="nf">findirets</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">me</span><span class="p">,</span><span class="n">irets</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">covratio</span><span class="p">,</span><span class="n">covth</span><span class="p">):</span>
    <span class="n">mg</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">MEGraph2</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">me</span><span class="p">)</span>
    <span class="c1"># turn irets junction into iret exons</span>
    <span class="k">def</span> <span class="nf">_iter_irets</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">st_id</span><span class="p">,</span><span class="n">ed_id</span><span class="p">,</span><span class="n">cov</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">irets</span><span class="p">,[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;ovlratio&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;st_id&#39;</span><span class="p">,</span><span class="s1">&#39;ed_id&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">st</span><span class="p">,</span><span class="n">namel</span><span class="p">,</span><span class="n">covl</span> <span class="ow">in</span> <span class="n">mg</span><span class="o">.</span><span class="n">sj_leftex</span><span class="p">(</span><span class="n">st_id</span><span class="p">,</span><span class="n">flds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">ed</span><span class="p">,</span><span class="n">namer</span><span class="p">,</span><span class="n">covr</span> <span class="ow">in</span> <span class="n">mg</span><span class="o">.</span><span class="n">sj_rightex</span><span class="p">(</span><span class="n">ed_id</span><span class="p">,</span><span class="n">flds</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">cov</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">covr</span><span class="o">+</span><span class="n">covl</span><span class="p">)</span><span class="o">*</span><span class="n">covratio</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cov</span><span class="o">&gt;</span><span class="n">covth</span><span class="p">):</span>
                    <span class="c1">#if (cov &gt; min(covr,covl)*covratio) &amp; (cov&gt;covth):</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">namel</span><span class="o">+</span><span class="s1">&#39;_iret_&#39;</span><span class="o">+</span><span class="n">namer</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="n">st</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">ed</span><span class="p">),</span><span class="n">name</span><span class="p">,</span><span class="n">ratio</span><span class="p">,</span><span class="n">strand</span><span class="p">)</span>

    <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span> <span class="c1"># [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;]</span>
    <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_iter_irets</span><span class="p">()]</span>
    <span class="c1">#LOG.debug(&#39;{0}: len:{1}&#39;.format(chrom,len(recs)))</span>
    <span class="k">return</span> <span class="n">recs</span></div>

<div class="viewcode-block" id="FINDSE"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSE">[docs]</a><span class="k">class</span> <span class="nc">FINDSE</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find single exons.</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon DataFrame</span>
<span class="sd">        edgefixer: EdgeFixer instance</span>
<span class="sd">        secovth: se coverage threshold</span>

<span class="sd">    Returns:</span>
<span class="sd">        :ae: all exons</span>
<span class="sd">        :se: single exons</span>
<span class="sd">        :me: multi-exons</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * minsecovth: minimum single exon coverage (normalized to million alignments)</span>
<span class="sd">          default {minsecovth} (merging: {minsecovth_m})</span>
<span class="sd">        * secovth: default SE cov threshold if not using adaptive version</span>
<span class="sd">          default {secovth} (merging: {secovth_m})</span>
<span class="sd">        * se_gap: single exon gap fill, default {se_gap}</span>
<span class="sd">        * se_binth: coverage threshold for SE finding, default {se_binth} (merging: {se_binth_m})</span>
<span class="sd">        * se_sizeth: single exon size th, default {se_sizeth} (merging: {se_sizeth_m})</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * se.cov.tmp.txt.gz</span>
<span class="sd">        * se.cov.all.txt.gz</span>
<span class="sd">        * secov.txt.gz</span>
<span class="sd">        * se.bed.gz</span>
<span class="sd">        * exons.afterfindse.txt.gz</span>
<span class="sd">        * me.exons.bed.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

    
<div class="viewcode-block" id="FINDSE.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSE.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">edgefixer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">edgefixer</span>
        <span class="n">secovth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">secovth</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        
        <span class="n">secovth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;minsecovth&#39;</span><span class="p">],</span> <span class="n">secovth</span><span class="p">)</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.secovth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secovth</span>
        
        <span class="n">gap</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_gap&#39;</span><span class="p">]</span>
        <span class="n">binth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_binth&#39;</span><span class="p">]</span>
        <span class="n">sesizeth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_sizeth&#39;</span><span class="p">]</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findse.se&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; finding SE...&#39;</span><span class="p">)</span>
            <span class="n">se0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_se</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">covth</span><span class="o">=</span><span class="n">secovth</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="n">gap</span><span class="p">,</span><span class="n">binth</span><span class="o">=</span><span class="n">binth</span><span class="p">,</span><span class="n">sizeth</span><span class="o">=</span><span class="n">sesizeth</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; reading cached SE {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">se0</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">se0</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">se0</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span>
        <span class="n">seme</span> <span class="o">=</span> <span class="n">se0</span><span class="p">[</span><span class="o">~</span><span class="n">idx</span><span class="p">]</span> <span class="c1"># 3&#39; or 5&#39; exons</span>

        <span class="c1"># fix 3&#39; exons</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; fixing 3pr extension 2nd phase ...&#39;</span><span class="p">)</span>
        <span class="n">seme2</span> <span class="o">=</span> <span class="n">edgefixer</span><span class="o">.</span><span class="n">fixSEedge</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">seme</span><span class="p">,</span> <span class="n">utr</span><span class="o">=</span><span class="s1">&#39;3pr&#39;</span><span class="p">)</span>
        <span class="n">seme2</span> <span class="o">=</span> <span class="n">edgefixer</span><span class="o">.</span><span class="n">fixSEedge</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">seme2</span><span class="p">,</span> <span class="n">utr</span><span class="o">=</span><span class="s1">&#39;5pr&#39;</span><span class="p">)</span>
        <span class="c1">#seme2 = edgefixer.fixSEedge(me, seme2, utr=&#39;se&#39;)</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">se0</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.#se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span>
        <span class="n">me2</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">seme2</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me2</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">se</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c1">#return ae, se, me2</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;assemble.exons0&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;write exons ...=&gt; assemble.exons0.txt.gz&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;assemble.exons0&#39;</span><span class="p">,</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">ae</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">se</span> <span class="o">=</span> <span class="n">se</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me2</span></div>

<div class="viewcode-block" id="FINDSE.find_se"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSE.find_se">[docs]</a>    <span class="k">def</span> <span class="nf">find_se</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">covth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">gap</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span><span class="n">binth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">sizeth</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span><span class="n">override</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="c1"># from bin0gap50 subtract ME choose &gt;200bp and cov&gt;1</span>
        <span class="c1"># covarage file</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; finding SE candidates...&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.tmp&#39;</span><span class="p">)</span>
        <span class="n">aname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.all&#39;</span><span class="p">)</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">override</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  reading cached SECOV {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">aname</span><span class="p">):</span>
            <span class="c1"># use cov calculated at FINDSECOVTH </span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">aname</span><span class="p">)</span>
            <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not using FINDSECOV then just calculate len&gt;sizeth</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  calculating SECOV...&#39;</span><span class="p">)</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">binth</span><span class="p">)</span>
            <span class="n">gapfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillgap</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">binfile</span><span class="p">)</span>
            <span class="n">mefile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="s1">&#39;findse.me.exons&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="c1"># subtract me from gapfilled</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; calculating coverage...&#39;</span><span class="p">)</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findse.gap-sub-me&#39;</span><span class="p">)</span> <span class="c1">#os.path.join(MD.SJEXDIR,sname+&#39;.gap-sub-me.bed.gz&#39;)</span>
            <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cname</span><span class="p">)):</span>
                <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolsubtract</span><span class="p">(</span><span class="n">gapfile</span><span class="p">,</span> <span class="n">mefile</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
            <span class="c1">#secov = BW.calc_cov(df, bwfile, fname) # ~30-40 sec</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_mp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span> <span class="c1"># here secovtmp is saved</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mefile</span><span class="p">)</span>

        <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;minsecovth&#39;</span><span class="p">]]</span> 
        <span class="c1"># use lower threshold here so that you don&#39;t lose non-SE (i.e. alternative 3&#39;,5&#39; UTR)</span>
        <span class="c1"># but can&#39;t process all of SE candidate since it will take forever, need to restrict to </span>
        <span class="c1"># reasonable amount =&gt; minsecovth</span>
        <span class="c1"># select SE with proper secovth later at SELECTSEME</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">secov</span><span class="p">,</span> <span class="s1">&#39;findse.secov&#39;</span><span class="p">,</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#candidate SE:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secov</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.#candidate_se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">secov</span><span class="p">)</span>
        <span class="c1"># see if additional filtering is necessary for intronic SE</span>
        <span class="c1"># ==&gt; covth 0.5 seems to be OK, ~4K overall</span>
        <span class="c1"># long ones are 3&#39;UTR ==&gt; needs to be fixed</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;fixing 3pr extension...&#39;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">recs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fix_se_ext</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="n">secov</span><span class="p">)]</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;#candidate SE after _fix_se_ext:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">recs</span><span class="p">)))</span>
        <span class="n">se</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">recs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.#candidate_se_after_fix_se_ext&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="s1">&#39;findse.se&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">se</span></div>
    
    <span class="k">def</span> <span class="nf">_fix_se_ext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">secov</span><span class="p">):</span>
        <span class="c1"># generator</span>
        <span class="c1"># go through se and see if it is attached to 5&#39; or 3&#39;of me exon</span>
        <span class="c1"># if so create extended exon</span>
        <span class="c1"># otherwise just spit out itself</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">])</span>
        <span class="n">eed</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">test0</span> <span class="o">=</span> <span class="n">tgt</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">chrom</span><span class="p">]</span>
                <span class="n">test1</span> <span class="o">=</span> <span class="n">test0</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="c1"># if no match =&gt; except</span>
                <span class="k">return</span> <span class="n">test0</span><span class="o">.</span><span class="n">ix</span><span class="p">[[</span><span class="n">pos</span><span class="p">]]</span> <span class="c1"># always return DataFrame</span>
            <span class="k">except</span><span class="p">:</span> <span class="c1"># constructing DataFrame for Null cases seems to take a lot of time</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  processing {0} SE candidates&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secov</span><span class="p">)))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">cov</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">secov</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">])):</span>
            <span class="n">le</span> <span class="o">=</span> <span class="n">_get</span><span class="p">(</span><span class="n">eed</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">)</span> <span class="c1"># for 3utr + strand find exons on left eed==st</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">_get</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span> <span class="c1"># for 3utr - strand find exons on right est==ed</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">le</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">pass</span>
                <span class="c1"># this should have been detected in iret</span>
                <span class="c1"># for nal,srl,e_st in le[[&#39;name&#39;,&#39;strand&#39;,&#39;st&#39;]].values:</span>
                <span class="c1">#     for nar,srr,e_ed in re[[&#39;name&#39;,&#39;strand&#39;,&#39;ed&#39;]].values:</span>
                <span class="c1">#         if srl==srr:</span>
                <span class="c1">#             name = nal+&#39;|SE{0}|&#39;.format(i)+nar</span>
                <span class="c1">#             yield (chrom,e_st,e_ed,name,cov,sr)            </span>
            <span class="k">elif</span> <span class="n">le</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span><span class="c1"># chr, st, ed, name, sc1, strand</span>
                <span class="k">for</span> <span class="n">nal</span><span class="p">,</span><span class="n">srl</span><span class="p">,</span><span class="n">e_st</span> <span class="ow">in</span> <span class="n">le</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">nal</span><span class="o">+</span><span class="s1">&#39;|SE{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">e_st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">srl</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">nar</span><span class="p">,</span><span class="n">srr</span><span class="p">,</span><span class="n">e_ed</span> <span class="ow">in</span> <span class="n">re</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SE{0}|&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">+</span><span class="n">nar</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">e_ed</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">srr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;SE{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">),</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                
    <span class="k">def</span> <span class="nf">_fix_se_3prext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exons</span><span class="p">,</span> <span class="n">secov</span><span class="p">):</span>
        <span class="c1"># generator</span>
        <span class="c1"># go through se and see if it is attached to 3&#39;of me exon</span>
        <span class="c1"># if so create extended 3pr end exon</span>
        <span class="c1"># otherwise just spit out itself</span>
        <span class="n">est</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">])</span>
        <span class="n">eed</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_get</span><span class="p">(</span><span class="n">tgt</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">strand</span><span class="p">,</span><span class="n">pos</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">tgt</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">chrom</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">strand</span><span class="p">]</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">cov</span> <span class="ow">in</span> <span class="n">secov</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
            <span class="n">le</span> <span class="o">=</span> <span class="n">_get</span><span class="p">(</span><span class="n">eed</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">st</span><span class="p">)</span> <span class="c1"># for 3utr + strand find exons on left eed==st</span>
            <span class="n">re</span> <span class="o">=</span> <span class="n">_get</span><span class="p">(</span><span class="n">est</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span> <span class="c1"># for 3utr - strand find exons on right est==ed</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">le</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">le</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span><span class="c1"># chr, st, ed, name, sc1, strand</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">le</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="n">le</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|SE&#39;</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">le</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">],</span><span class="n">ed</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">le</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|SE&#39;</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">],</span><span class="n">ed</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SE|&#39;</span><span class="o">+</span><span class="n">re</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">re</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">],</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">j</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="n">re</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;SE|&#39;</span><span class="o">+</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">],</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;SE&#39;</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FIND53IR"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIND53IR">[docs]</a><span class="k">class</span> <span class="nc">FIND53IR</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find 5&#39;,3&#39; exon (cut), intron retentions and single exons.</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :ae: exons with 5&#39;,3&#39; cuts, irets, and single exons.</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * minsecovth: minimum single exon coverage (normalized to million alignments)</span>
<span class="sd">          default {minsecovth} (merging: {minsecovth_m})</span>
<span class="sd">        * secovth: default SE cov threshold if not using adaptive version</span>
<span class="sd">          default {secovth} (merging: {secovth_m})</span>
<span class="sd">        * se_gap: single exon gap fill, default {se_gap}</span>
<span class="sd">        * se_binth: coverage threshold for SE finding, default {se_binth} (merging: {se_binth_m})</span>
<span class="sd">        * se_sizeth: single exon size th, default {se_sizeth} (merging: {se_sizeth_m})</span>
<span class="sd">        * find53ir_covratio: cov ratio threshold for FIND53IR, </span>
<span class="sd">          default {find53ir_covratio}, (merging: {find53ir_covratio_m})</span>
<span class="sd">        * find53ir_covth: cov threshold for FIND53IR</span>
<span class="sd">          default {find53ir_covth}, (mergin: {find53ir_covth_m})</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * se.cov.tmp.txt.gz</span>
<span class="sd">        * se.cov.all.txt.gz</span>
<span class="sd">        * me.exons.bed.gz</span>
<span class="sd">        * bw*.bed.gz</span>
<span class="sd">        * gap-sub-me.bed.gz</span>
<span class="sd">        * assemble.exons0.txt.gz</span>
<span class="sd">        * assemble.exons0.bed.gz</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FIND53IR.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIND53IR.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">me</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        
        <span class="n">secovth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;minsecovth&#39;</span><span class="p">],</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;secovth&#39;</span><span class="p">])</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.secovth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secovth</span>
        
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;find53ir&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; finding 53IR...&#39;</span><span class="p">)</span>
            <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">secovth</span><span class="p">)</span><span class="c1">#,gap=gap,binth=binth,sizeth=sesizeth)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; reading cached 53IR {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">ae</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="c1">#return ae</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">ae</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;assemble.exons0&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;write exons ...=&gt; assemble.exons0.txt.gz&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;assemble.exons0&#39;</span><span class="p">,</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FIND53IR.find"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIND53IR.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">secovth</span><span class="p">):</span>
        <span class="c1"># TODO fixedge dse as well?</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
                
        <span class="n">gap</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_gap&#39;</span><span class="p">]</span>
        <span class="n">sizeth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_sizeth&#39;</span><span class="p">]</span>
        <span class="n">override</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
        <span class="n">np</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span>

        <span class="c1"># calc SE candidates (subtract ME) and calc cov</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.tmp&#39;</span><span class="p">)</span>
        <span class="n">aname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">override</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  reading cached SECOV {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
            <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
        <span class="k">elif</span> <span class="p">(</span><span class="ow">not</span> <span class="n">override</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">aname</span><span class="p">):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  reading cached SECOV {0}...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aname</span><span class="p">))</span>
            <span class="c1"># use cov calculated at FINDSECOVTH </span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">aname</span><span class="p">)</span>
            <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># if not using FINDSECOV then just calculate len&gt;sizeth</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;  calculating SECOV...&#39;</span><span class="p">)</span>
            <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_binth&#39;</span><span class="p">])</span>
            <span class="n">gapfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillgap</span><span class="p">(</span><span class="n">gap</span><span class="p">,</span> <span class="n">binfile</span><span class="p">)</span>
            <span class="n">mefile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s1">&#39;find53ir.me.exons&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; calculating coverage...&#39;</span><span class="p">)</span>
            <span class="n">cname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;find53ir.gap-sub-me&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cname</span><span class="p">)):</span>
                <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolsubtract</span><span class="p">(</span><span class="n">gapfile</span><span class="p">,</span> <span class="n">mefile</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sizeth</span><span class="p">]</span>
            <span class="n">secov</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_mp</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">np</span><span class="p">)</span> <span class="c1"># here secovtmp is saved</span>
            <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">mefile</span><span class="p">)</span>

        <span class="c1"># calc ME cov</span>
        <span class="k">if</span> <span class="n">override</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;find53ir.cov&#39;</span><span class="p">)):</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calculating ME cov...&#39;</span><span class="p">)</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
            <span class="n">me</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_ovl_mp</span><span class="p">(</span>
                    <span class="n">srcname</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> 
                    <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> 
                    <span class="n">dstname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;find53ir.cov&#39;</span><span class="p">),</span> 
                    <span class="n">np</span><span class="o">=</span><span class="n">np</span><span class="p">,</span>
                    <span class="n">override</span><span class="o">=</span><span class="n">override</span><span class="p">,</span>
                    <span class="n">covciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;find53ir.covci&#39;</span><span class="p">),</span>
                    <span class="n">ciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;find53ir.ci&#39;</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">me</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">read_txt</span><span class="p">(</span><span class="s1">&#39;find53ir.cov&#39;</span><span class="p">)</span>

        <span class="c1"># write BED files and find attaching ME/SE </span>
        <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed+1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;SE{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secov</span><span class="p">))]</span>
        <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">secov</span><span class="p">))</span>
        <span class="n">secov</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;.&#39;</span>
        <span class="n">secols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st-1&#39;</span><span class="p">,</span><span class="s1">&#39;ed+1&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span>
        <span class="n">mecols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span>
        <span class="c1"># somehow [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;_id&#39;,&#39;strand&#39;,&#39;cov&#39;] this order segfaults</span>
        <span class="c1"># when intersected with others</span>
        <span class="n">mecols2</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;echr&#39;</span><span class="p">,</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;eid&#39;</span><span class="p">,</span><span class="s1">&#39;ecov&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">secov</span><span class="p">[</span><span class="n">secols</span><span class="p">],</span><span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;find53ir.se&#39;</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">me</span><span class="p">[</span><span class="n">mecols</span><span class="p">],</span><span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;find53ir.me&#39;</span><span class="p">),</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;find53ir.ovl&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolintersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">wao</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">secols</span><span class="o">+</span><span class="n">mecols2</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ovl&#39;</span><span class="p">]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;attachleft&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;ed+1&#39;</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="o">==</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;est&#39;</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;attachright&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s1">&#39;st-1&#39;</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="o">==</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;eed&#39;</span><span class="p">]</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;[&#39;</span><span class="p">))</span><span class="o">&amp;</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;ename&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">))</span>
        <span class="c1"># SE</span>
        <span class="n">dse</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;echr&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;.&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1"># no overlap</span>
        <span class="n">dse</span> <span class="o">=</span> <span class="n">dse</span><span class="p">[</span><span class="n">dse</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">secovth</span><span class="p">]</span>
        <span class="n">dse</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dse</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span> <span class="c1"># for writing BED</span>
        <span class="c1"># ME</span>
        <span class="n">dme</span> <span class="o">=</span> <span class="n">d</span><span class="p">[(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;attachleft&#39;</span><span class="p">]</span><span class="o">&amp;</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;bound&#39;</span><span class="p">])</span><span class="o">|</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;attachright&#39;</span><span class="p">]</span><span class="o">&amp;</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;bound&#39;</span><span class="p">])]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">dme</span><span class="p">[</span><span class="s1">&#39;covratio&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dme</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span><span class="o">/</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;ecov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">dme</span> <span class="o">=</span> <span class="n">dme</span><span class="p">[</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;covratio&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;find53ir_covratio&#39;</span><span class="p">]]</span> <span class="c1"># and substantial portion</span>

        <span class="c1"># attachleft sid, attachright sid, iret side, etc.</span>
        <span class="k">def</span> <span class="nf">_lri</span><span class="p">(</span><span class="n">strand</span><span class="p">):</span>
            <span class="n">al0p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dme</span><span class="p">[(</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;attachleft&#39;</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">)][</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">ar0p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dme</span><span class="p">[(</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;attachright&#39;</span><span class="p">])</span><span class="o">&amp;</span><span class="p">(</span><span class="n">dme</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">strand</span><span class="p">)][</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">irp</span> <span class="o">=</span> <span class="n">al0p</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">ar0p</span><span class="p">)</span>
            <span class="n">alp</span> <span class="o">=</span> <span class="n">al0p</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">ar0p</span><span class="p">)</span> 
            <span class="n">arp</span> <span class="o">=</span> <span class="n">ar0p</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">al0p</span><span class="p">)</span> 
            <span class="k">return</span> <span class="n">alp</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">irp</span>
        <span class="n">alp</span><span class="p">,</span><span class="n">arp</span><span class="p">,</span><span class="n">irp</span> <span class="o">=</span> <span class="n">_lri</span><span class="p">(</span><span class="s1">&#39;+&#39;</span><span class="p">)</span>
        <span class="n">aln</span><span class="p">,</span><span class="n">arn</span><span class="p">,</span><span class="n">irn</span> <span class="o">=</span> <span class="n">_lri</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="n">ir</span> <span class="o">=</span> <span class="n">irp</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">irn</span><span class="p">)</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">alp</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">aln</span><span class="p">)</span>
        <span class="n">ar</span> <span class="o">=</span> <span class="n">arp</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">arn</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;#al({0}) #ar({1}) #iret({2})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">al</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ar</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ir</span><span class="p">)))</span>

        <span class="c1"># fix edges, no chop necessary but need copy</span>
        <span class="n">sei</span> <span class="o">=</span> <span class="n">secov</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span>
        <span class="c1"># cicols: [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;, &#39;direction&#39;]</span>
        <span class="c1"># mecols: [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;strand&#39;,&#39;_id2&#39;]</span>
        <span class="c1"># ci.name == str(me._id2)</span>
        <span class="k">def</span> <span class="nf">_calc</span><span class="p">(</span><span class="n">id2s</span><span class="p">,</span><span class="n">direction</span><span class="p">,</span><span class="n">func</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">id2s</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">None</span>
            <span class="n">me</span> <span class="o">=</span> <span class="n">sei</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">id2s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ci</span> <span class="o">=</span> <span class="n">me</span><span class="p">[[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ci</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">ci</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;_id2&#39;</span><span class="p">]</span>
            <span class="n">ci</span><span class="p">[</span><span class="s1">&#39;direction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">direction</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">ci</span><span class="p">,</span><span class="n">me</span><span class="p">,</span><span class="n">func</span><span class="p">)</span>
        <span class="n">alr</span> <span class="o">=</span> <span class="n">_calc</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">fixedges_m</span><span class="p">)</span>
        <span class="n">arr</span> <span class="o">=</span> <span class="n">_calc</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">fixedges_m</span><span class="p">)</span>
        <span class="n">irr</span> <span class="o">=</span> <span class="n">_calc</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">cutedges_m</span><span class="p">)</span>
        <span class="c1"># returned [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;name&#39;,&#39;sc1&#39;,&#39;strand&#39;,&#39;_id2&#39;]</span>

        <span class="c1"># attach exons</span>
        <span class="n">dmi</span> <span class="o">=</span> <span class="n">dme</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id2&#39;</span><span class="p">)</span>
        <span class="n">i2c</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">df2dict</span><span class="p">(</span><span class="n">secov</span><span class="p">,</span> <span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;cov&#39;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">_makedics</span><span class="p">(</span><span class="n">id2s</span><span class="p">,</span> <span class="n">boolcol</span><span class="p">):</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">dmi</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">id2s</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">t</span><span class="p">[</span><span class="n">boolcol</span><span class="p">]]</span>
            <span class="n">tg</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;_id2&#39;</span><span class="p">)[</span><span class="s1">&#39;eid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">s2eids</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">df2dict</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="s1">&#39;_id2&#39;</span><span class="p">,</span><span class="s1">&#39;eid&#39;</span><span class="p">)</span>
            <span class="n">tg2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;eid&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
            <span class="n">e2row</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">tg2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">tg2</span><span class="p">,[</span><span class="s1">&#39;est&#39;</span><span class="p">,</span><span class="s1">&#39;eed&#39;</span><span class="p">,</span><span class="s1">&#39;ename&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])))</span>
            <span class="k">return</span> <span class="n">s2eids</span><span class="p">,</span> <span class="n">e2row</span>
        <span class="k">def</span> <span class="nf">_algen</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">alr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>            
            <span class="n">s2eids</span><span class="p">,</span><span class="n">e2row</span> <span class="o">=</span> <span class="n">_makedics</span><span class="p">(</span><span class="n">al</span><span class="p">,</span><span class="s1">&#39;attachleft&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">i2</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">alr</span><span class="p">,[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]):</span>
                <span class="c1"># SE|[mel] # (chr,sst,eed,sn|en,i2,estrand)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">s2eids</span><span class="p">[</span><span class="n">i2</span><span class="p">]:</span> <span class="c1"># erow: st,ed,name,strand</span>
                    <span class="n">erow</span> <span class="o">=</span> <span class="n">e2row</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">n</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">erow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">erow</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">erow</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_argen</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">arr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>            
            <span class="n">s2eids</span><span class="p">,</span><span class="n">e2row</span> <span class="o">=</span> <span class="n">_makedics</span><span class="p">(</span><span class="n">ar</span><span class="p">,</span><span class="s1">&#39;attachright&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">i2</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">arr</span><span class="p">,[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]):</span>
                <span class="c1"># [mer]|SE, (chr,est,sed,name,i2,estrand)</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">eid</span> <span class="ow">in</span> <span class="n">s2eids</span><span class="p">[</span><span class="n">i2</span><span class="p">]:</span> <span class="c1"># erow: st,ed,name,strand</span>
                    <span class="n">erow</span> <span class="o">=</span> <span class="n">e2row</span><span class="p">[</span><span class="n">eid</span><span class="p">]</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">erow</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">n</span>
                    <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">erow</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">erow</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">_irgen</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">irr</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">s2le</span><span class="p">,</span><span class="n">le2row</span> <span class="o">=</span> <span class="n">_makedics</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="s1">&#39;attachleft&#39;</span><span class="p">)</span>
            <span class="n">s2re</span><span class="p">,</span><span class="n">re2row</span> <span class="o">=</span> <span class="n">_makedics</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span><span class="s1">&#39;attachright&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">s</span><span class="p">,</span><span class="n">e</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">i2</span> <span class="ow">in</span> <span class="n">UT</span><span class="o">.</span><span class="n">izipcols</span><span class="p">(</span><span class="n">irr</span><span class="p">,[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]):</span>
                <span class="c1"># [mer]|SE|[mel]</span>
                <span class="n">cov</span> <span class="o">=</span> <span class="n">i2c</span><span class="p">[</span><span class="n">i2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">eidl</span> <span class="ow">in</span> <span class="n">s2le</span><span class="p">[</span><span class="n">i2</span><span class="p">]:</span>
                    <span class="n">erowl</span> <span class="o">=</span> <span class="n">le2row</span><span class="p">[</span><span class="n">eidl</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">eidr</span> <span class="ow">in</span> <span class="n">s2re</span><span class="p">[</span><span class="n">i2</span><span class="p">]:</span>
                        <span class="n">erowr</span> <span class="o">=</span> <span class="n">re2row</span><span class="p">[</span><span class="n">eidr</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">erowl</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">==</span><span class="n">erowr</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span>
                            <span class="n">name</span> <span class="o">=</span> <span class="n">erowr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">n</span><span class="o">+</span><span class="s1">&#39;|&#39;</span><span class="o">+</span><span class="n">erowl</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            <span class="k">yield</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">erowr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">erowl</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">name</span><span class="p">,</span><span class="n">cov</span><span class="p">,</span><span class="n">erowl</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">alrecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_algen</span><span class="p">()]</span>
        <span class="n">arrecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_argen</span><span class="p">()]</span>
        <span class="n">irrecs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_irgen</span><span class="p">()]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span> <span class="c1"># se cov in &#39;sc1&#39;</span>
        <span class="n">medf</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">alrecs</span><span class="o">+</span><span class="n">arrecs</span><span class="o">+</span><span class="n">irrecs</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dse</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">medf</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span><span class="s1">&#39;find53ir&#39;</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ptyp</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">idxse</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;s&#39;</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSE.#se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">idxse</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="s1">&#39;ptyp&#39;</span><span class="p">]</span>
        <span class="n">me</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span><span class="n">ex</span><span class="p">[</span><span class="n">cols</span><span class="p">]],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="n">ae</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ae</span></div>

<div class="viewcode-block" id="FIND53IR.process_mp"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIND53IR.process_mp">[docs]</a>    <span class="k">def</span> <span class="nf">process_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">bwname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span><span class="o">.</span><span class="n">bwfile</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">me</span><span class="p">):</span>
            <span class="n">mechr</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">][[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cichr</span> <span class="o">=</span> <span class="n">ci</span><span class="p">[</span><span class="n">ci</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cichr</span><span class="p">,</span><span class="n">mechr</span><span class="p">,</span><span class="n">bwname</span><span class="p">,</span><span class="n">pr</span><span class="p">,</span><span class="n">chrom</span><span class="p">))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># if pr[&#39;np&#39;]==1:</span>
        <span class="c1">#     for i,arg in enumerate(args):</span>
        <span class="c1">#         tmp = func(*arg)</span>
        <span class="c1">#         LOG.debug(&#39;  processing {3}: {0}/{1} {2}...&#39;.format(i+1,len(args),len(tmp),arg[-1]))</span>
        <span class="c1">#         rslts += tmp</span>
        <span class="c1">#     return PD.concat(rslts,ignore_index=True)</span>
        <span class="c1"># try:</span>
        <span class="c1">#     p = multiprocessing.Pool(pr[&#39;np&#39;])</span>
        <span class="c1">#     #tmp = p.map(cutedges_m, args)</span>
        <span class="c1">#     tmp = p.map(func, args)</span>
        <span class="c1"># finally:</span>
        <span class="c1">#     LOG.debug(&#39;  closing pool&#39;)</span>
        <span class="c1">#     p.close()</span>
        <span class="c1"># return PD.concat(tmp, ignore_index=True)</span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;sc1&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">,</span><span class="s1">&#39;_id2&#39;</span><span class="p">])</span></div></div>

<div class="viewcode-block" id="FINDSECOVTH"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH">[docs]</a><span class="k">class</span> <span class="nc">FINDSECOVTH</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find single exon coverage threshold (secovth).</span>

<span class="sd">    Args:</span>
<span class="sd">        me: exon DataFrame</span>

<span class="sd">    Returns:</span>
<span class="sd">        :secovth: threshold</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * findsecovth_useref: whether to use ref for finding secov, if not use ME</span>
<span class="sd">          default {findsecovth_useref}</span>
<span class="sd">        * minsecovth: minimum single exon coverage (normalized to million alignments)</span>
<span class="sd">          default {minsecovth} (merging: {minsecovth_m})</span>
<span class="sd">        * se_gap: single exon gap fill, default {se_gap}</span>

<span class="sd">    Files:</span>
<span class="sd">        * findsecovth.params.txt.gz</span>
<span class="sd">        * findsecovth.pdf</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * findsecovth.refex.covci.txt.gz</span>
<span class="sd">        * findsecovth.refex.cov.txt.gz</span>
<span class="sd">        * se.cov.all.txt.gz</span>
<span class="sd">        * irets.me.cov.txt.gz</span>
<span class="sd">        * me.covci.txt.gz</span>
<span class="sd">        * me.ci.txt.gz</span>
<span class="sd">        * findsecovth.gap-sub-me.bed.gz</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bins</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">1.7</span><span class="p">,</span><span class="mf">0.05</span><span class="p">)</span>
    
<div class="viewcode-block" id="FINDSECOVTH.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">me</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span>  
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;findsecovth&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;findsecovth_useref&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">refgtf</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calc_refexcov</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calc_allsecov</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">secovth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_secovth</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_params</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">secovth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;secovth&#39;</span><span class="p">]</span>
        <span class="n">secovth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;minsecovth&#39;</span><span class="p">],</span> <span class="n">secovth</span><span class="p">)</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSECOVTH.secovth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">secovth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;SECOVTH={0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">secovth</span><span class="p">)</span>
        <span class="c1">#return secovth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">secovth</span> <span class="o">=</span> <span class="n">secovth</span></div>
    
<div class="viewcode-block" id="FINDSECOVTH.save_params"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.save_params">[docs]</a>    <span class="k">def</span> <span class="nf">save_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">st</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># gamma, a1</span>
        <span class="c1"># residue, th99 for (ref, me, se)</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="s1">&#39;a1&#39;</span><span class="p">,</span><span class="s1">&#39;ref_res&#39;</span><span class="p">,</span><span class="s1">&#39;ref_th99bn&#39;</span><span class="p">,</span><span class="s1">&#39;me_res&#39;</span><span class="p">,</span><span class="s1">&#39;me_th99bn&#39;</span><span class="p">,</span><span class="s1">&#39;se_res&#39;</span><span class="p">,</span>
                <span class="s1">&#39;ref_nf&#39;</span><span class="p">,</span><span class="s1">&#39;me_nf&#39;</span><span class="p">,</span><span class="s1">&#39;se_nf&#39;</span><span class="p">,</span><span class="s1">&#39;se_th99&#39;</span><span class="p">]</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([(</span><span class="n">x</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">attrs</span><span class="p">:</span>
            <span class="n">st</span><span class="p">[</span><span class="s1">&#39;FINDSECOVTH.&#39;</span><span class="o">+</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
        <span class="n">prdf</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="n">fn</span><span class="o">.</span><span class="n">sname</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;findsecovth.params.txt&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;stats&#39;</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">prdf</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;ih&#39;</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="FINDSECOVTH.calc_refexcov"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.calc_refexcov">[docs]</a>    <span class="k">def</span> <span class="nf">calc_refexcov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">excovname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findsecovth.refex.cov&#39;</span><span class="p">)</span>
        <span class="k">if</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">excovname</span><span class="p">):</span>
            <span class="n">rsj</span><span class="p">,</span><span class="n">rex</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">refsjex</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rsj</span> <span class="o">=</span> <span class="n">rsj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rex</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">excovname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rsj</span><span class="p">,</span><span class="n">rex</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">refsjex</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rsj</span> <span class="o">=</span> <span class="n">rsj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rex</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_ovl_mp</span><span class="p">(</span>
                <span class="n">srcname</span><span class="o">=</span><span class="n">rex</span><span class="p">,</span> 
                <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> 
                <span class="n">dstname</span><span class="o">=</span><span class="n">excovname</span><span class="p">,</span> 
                <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">],</span> 
                <span class="n">covciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findsecovth.refex.covci&#39;</span><span class="p">),</span> 
                <span class="n">ciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">refname</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">),</span> 
                <span class="n">colname</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> 
                <span class="n">override</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
            <span class="p">)</span></div>
    
<div class="viewcode-block" id="FINDSECOVTH.calc_allsecov"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.calc_allsecov">[docs]</a>    <span class="k">def</span> <span class="nf">calc_allsecov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">aname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.all&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">aname</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calc_allsecov</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;calculating ME cov...&#39;</span><span class="p">)</span>
        <span class="n">mname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;irets.me.cov&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">mname</span><span class="p">):</span>
            <span class="c1"># use previously calculated cov (w/o irets)</span>
            <span class="c1"># since only used for making figs/fitting w/o irets is OK</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">mname</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_ovl_mp</span><span class="p">(</span>
                <span class="n">srcname</span><span class="o">=</span><span class="n">me</span><span class="p">,</span> 
                <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> 
                <span class="n">dstname</span><span class="o">=</span><span class="n">mname</span><span class="p">,</span>
                <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">],</span> 
                <span class="n">covciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findsecovth.me.covci&#39;</span><span class="p">),</span> 
                <span class="n">ciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;findsecovth.me.ci&#39;</span><span class="p">),</span> 
                <span class="n">colname</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span><span class="p">,</span> 
                <span class="n">override</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">]</span>
            <span class="p">)</span>        </div>

    <span class="k">def</span> <span class="nf">_calc_allsecov</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">me</span><span class="p">):</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; finding SE candidates...&#39;</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">binfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw2bed</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;binth&#39;</span><span class="p">])</span>
        <span class="n">gapfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fillgap</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_gap&#39;</span><span class="p">],</span> <span class="n">binfile</span><span class="p">)</span> 
        <span class="c1"># pr[&#39;gap&#39;] 50 vs. pr[&#39;se_gap&#39;] 170 makes huge difference...</span>
        <span class="n">mefile</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="s1">&#39;findsecovth.me.exons&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># subtract me from gapfilled</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; calculating coverage...&#39;</span><span class="p">)</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;findsecovth.gap-sub-me&#39;</span><span class="p">)</span>
        <span class="n">cname</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolsubtract</span><span class="p">(</span><span class="n">gapfile</span><span class="p">,</span> <span class="n">mefile</span><span class="p">,</span> <span class="n">cname</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">GGB</span><span class="o">.</span><span class="n">read_bed</span><span class="p">(</span><span class="n">cname</span><span class="p">)</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;se.cov.all&#39;</span><span class="p">)</span>
        <span class="c1">#secov = BW.calc_cov(df, bwfile, fname) # slow ~500K targets</span>
        <span class="n">secov</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_mp</span><span class="p">(</span><span class="n">bed</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> <span class="n">fname</span><span class="o">=</span><span class="n">fname</span><span class="p">,</span> <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1">#os.unlink(cname)</span>
    
    <span class="k">def</span> <span class="nf">_fit_hist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refcov</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
        <span class="c1"># find best gamma for gen4</span>
        <span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="mi">9</span><span class="o">-</span><span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">bins</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">gamma</span><span class="p">),</span><span class="mi">9</span><span class="p">,</span><span class="n">width</span><span class="p">)</span>
        <span class="n">tot</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">refcov</span><span class="p">))</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">refcov</span><span class="o">+</span><span class="n">gamma</span><span class="p">)</span>
        <span class="n">h</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">h</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># logscale</span>
        <span class="n">st</span><span class="p">,</span><span class="n">ed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">60</span> <span class="c1"># range of fit</span>
        <span class="k">if</span> <span class="n">a1</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">x3</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
            <span class="n">y3</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
            <span class="n">a1</span><span class="p">,</span><span class="n">a0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">x3</span><span class="p">,</span><span class="n">y3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">st</span> <span class="o">=</span> <span class="mi">15</span> <span class="c1"># throw away initial 14 points</span>
            <span class="n">x3</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
            <span class="n">y3</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">st</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
            <span class="n">a0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y3</span><span class="o">-</span><span class="n">a1</span><span class="o">*</span><span class="n">x3</span><span class="p">)</span>
        <span class="n">xf</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
        <span class="n">yo</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ed</span><span class="p">]</span>
        <span class="n">yf</span> <span class="o">=</span> <span class="n">a0</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">xf</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yo</span><span class="o">-</span><span class="n">yf</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span> <span class="c1"># also calculate th99</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">40</span><span class="p">)</span>
            <span class="n">cp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">yf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span>   <span class="c1"># condition positive</span>
            <span class="n">cn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">yo</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span><span class="o">-</span><span class="n">cp</span> <span class="c1"># condition negative</span>
            <span class="k">if</span> <span class="n">cn</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">cn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">yf</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span> <span class="c1"># false negative (condition positive but &lt; th)</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="n">cp</span> <span class="o">-</span> <span class="n">fn</span> <span class="c1"># true positive (condition positive and &gt;= th)</span>
            <span class="n">tn</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">yo</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span> <span class="o">-</span> <span class="n">fn</span>  <span class="c1"># true negative</span>
            <span class="n">tn</span><span class="p">[</span><span class="n">tn</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">cn</span> <span class="o">-</span> <span class="n">tn</span>
            <span class="n">fp</span><span class="p">[</span><span class="n">fp</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">tpr</span> <span class="o">=</span> <span class="n">tp</span><span class="o">/</span><span class="n">cp</span>
            <span class="n">fpr</span> <span class="o">=</span> <span class="n">fp</span><span class="o">/</span><span class="n">cn</span>
            <span class="n">fpr</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fpr</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="n">tpr</span><span class="o">-</span><span class="n">fpr</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">fpr</span><span class="o">&lt;=</span><span class="mf">0.01</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">th99x</span> <span class="o">=</span> <span class="n">xf</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">tmp</span><span class="p">)]</span>
            <span class="n">th99</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="n">th99x</span> <span class="o">-</span> <span class="n">gamma</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a0</span><span class="o">+</span><span class="n">a1</span><span class="o">*</span><span class="n">x</span><span class="p">,</span><span class="s1">&#39;m-&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">th99x</span><span class="p">,</span><span class="n">th99x</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">16</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">ed</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="n">ed</span><span class="p">]],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">8</span><span class="p">],</span><span class="s1">&#39;k--&#39;</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
            <span class="c1">#ax.plot([x[0],x[0]],[0,a0+a1*x[0]],&#39;k--&#39;,lw=0.5)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;log2(cov+gamma)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;log2(count+1)&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">14</span><span class="p">,</span><span class="s1">&#39;res={:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">12</span><span class="p">,</span><span class="s1">&#39;slope={:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a1</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;ncovth={:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">th99</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="s1">&#39;covth={:.1f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">th99</span><span class="o">*</span><span class="n">nf</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">17</span><span class="p">])</span>
            
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">th99</span>
        
        <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span><span class="n">a1</span><span class="p">,</span><span class="n">a0</span><span class="p">,</span><span class="n">res</span>
    
<div class="viewcode-block" id="FINDSECOVTH.find_gamma_slope"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.find_gamma_slope">[docs]</a>    <span class="k">def</span> <span class="nf">find_gamma_slope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bins</span>
        <span class="n">refcov</span><span class="p">,</span> <span class="n">ref_nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_refcov</span><span class="p">()</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="s1">&#39;a1&#39;</span><span class="p">,</span><span class="s1">&#39;a0&#39;</span><span class="p">,</span><span class="s1">&#39;res&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcovfits</span> <span class="o">=</span> <span class="n">fits</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_fit_hist</span><span class="p">(</span><span class="n">refcov</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="n">ref_nf</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">gammas</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="n">cols</span><span class="p">)</span>
        <span class="n">fits</span><span class="p">[</span><span class="s1">&#39;-gamma&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
        <span class="n">gamma</span><span class="p">,</span><span class="n">a1</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;res&#39;</span><span class="p">,</span><span class="s1">&#39;-gamma&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][[</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span><span class="s1">&#39;a1&#39;</span><span class="p">]]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span>
        <span class="k">return</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span></div>

    <span class="k">def</span> <span class="nf">_get_refcov</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;findsecovth_useref&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">refgtf</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">refcov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rex</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># use ME cov</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
            <span class="k">if</span> <span class="s1">&#39;cat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
                <span class="n">UT</span><span class="o">.</span><span class="n">set_exon_category</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
            <span class="n">refcov</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;s&#39;</span><span class="p">][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">refcov</span> <span class="o">=</span> <span class="n">refcov</span><span class="p">[</span><span class="n">refcov</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># only use expressed </span>
        <span class="c1"># normalize 1e4 factor is to match to 100bp readlen normalized to 1M reads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_nf</span> <span class="o">=</span> <span class="n">ref_nf</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">refcov</span><span class="p">)</span><span class="o">/</span><span class="mf">1e4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">refcov</span> <span class="o">=</span> <span class="n">refcov</span> <span class="o">=</span> <span class="n">refcov</span><span class="o">/</span><span class="n">ref_nf</span>
        <span class="k">return</span> <span class="n">refcov</span><span class="p">,</span> <span class="n">ref_nf</span>

<div class="viewcode-block" id="FINDSECOVTH.find_secovth"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDSECOVTH.find_secovth">[docs]</a>    <span class="k">def</span> <span class="nf">find_secovth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># find gamma, slope from reference coverage histogram</span>
        <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_gamma_slope</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a1</span> <span class="o">=</span> <span class="n">a1</span>
        
        <span class="c1"># use gamma, slope to find secovth</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axr</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
        <span class="c1"># fig, axr = P.subplots(2,3,figsize=(9,6))</span>
        <span class="n">P</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span><span class="n">top</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">sname</span><span class="p">)</span>
        <span class="c1"># panel1 refcov fits</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">refcovfits</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fits</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">fits</span><span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s1">&#39;.-&#39;</span><span class="p">)</span>
        <span class="n">ylim</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">gamma</span><span class="p">,</span><span class="n">gamma</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span> <span class="s1">&#39;r--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ypos</span><span class="o">=</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">0.9</span><span class="o">*</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">ypos</span><span class="p">,</span> <span class="s1">&#39;min at {0:.2f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">gamma</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;gamma&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;gen4 cov residual&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;finding gamma and slope&#39;</span><span class="p">)</span>
        
        <span class="c1"># panel2 refcov optimum</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">refcov</span><span class="p">,</span> <span class="n">ref_nf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_refcov</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;findsecovth_useref&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">fn</span><span class="o">.</span><span class="n">refgtf</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;ref ME &amp; SE&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;sample ME&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_th99bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_hist</span><span class="p">(</span><span class="n">refcov</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="n">ref_nf</span><span class="p">)</span>
        
        <span class="c1"># refcov SE</span>
        <span class="c1"># if pr[&#39;findsecovth_useref&#39;] and fn.refgtf.exists():</span>
        <span class="c1">#     rsj,rex = self.rsj, self.rex</span>
        <span class="c1">#     if &#39;cat&#39; not in rex.columns:</span>
        <span class="c1">#         UT.set_exon_category(rsj,rex)</span>
        <span class="c1">#     rse = rex[rex[&#39;cat&#39;]==&#39;s&#39;]</span>
        <span class="c1">#     rse = rse[rse[&#39;cov&#39;]&gt;0][&#39;cov&#39;].values</span>
        <span class="c1">#     rse_nf = N.sum(rse)/1e4</span>
        <span class="c1">#     self.rse = rse = rse/rse_nf</span>
        <span class="c1">#     ax = axr[0][2]</span>
        <span class="c1">#     tmp = self._fit_hist(rse, gamma, a1, ax=ax, title=&#39;ref SE&#39;, nf=rse_nf)</span>

        <span class="c1"># panel3 me fits</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ex</span>
        <span class="k">if</span> <span class="s1">&#39;cat&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
            <span class="n">UT</span><span class="o">.</span><span class="n">set_exon_category</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;s&#39;</span><span class="p">]</span>
        <span class="n">me</span> <span class="o">=</span> <span class="n">me</span><span class="p">[</span><span class="n">me</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me_nf</span> <span class="o">=</span> <span class="n">me_nf</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">me</span><span class="p">)</span><span class="o">/</span><span class="mf">1e4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me</span> <span class="o">=</span> <span class="n">me</span> <span class="o">=</span> <span class="n">me</span><span class="o">/</span><span class="n">me_nf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">me_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">me_th99bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_hist</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;ME&#39;</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="n">me_nf</span><span class="p">)</span>
        
        <span class="c1"># panel4 seall</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">axr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">secov</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">read_txt</span><span class="p">(</span><span class="s1">&#39;se.cov.all&#39;</span><span class="p">)</span>
        <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="p">[</span><span class="n">secov</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="c1"># normalize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se_nf</span> <span class="o">=</span> <span class="n">se_nf</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">secov</span><span class="p">)</span><span class="o">/</span><span class="mf">1e4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span> <span class="o">=</span> <span class="n">secov</span><span class="o">/</span><span class="n">se_nf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se_res</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">se_th99bn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fit_hist</span><span class="p">(</span><span class="n">secov</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">a1</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;SE candidates&#39;</span><span class="p">,</span> <span class="n">nf</span><span class="o">=</span><span class="n">se_nf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">se_th99</span> <span class="o">=</span> <span class="n">se_nf</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">se_th99bn</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;findsecovth.pdf&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;failed to save secovthfig&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">se_th99</span></div></div>
                
<div class="viewcode-block" id="SELECTSEME"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SELECTSEME">[docs]</a><span class="k">class</span> <span class="nc">SELECTSEME</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove noise.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon (all exon = single+multi exons) dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: junction dataframe without spurious junctions</span>
<span class="sd">        :ae: exon dataframe without spurious exons</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * se_sizeth2: remove SE with length smaller than this, default {se_sizeth2}</span>
<span class="sd">        * np: number of CPU to use, default {np}</span>
<span class="sd">        * me2exon_sjth: 2exon genes with splice junction support less than this will be removed</span>
<span class="sd">          default {me2exon_sjth}</span>
<span class="sd">        * me2exon_sizeth: 2exon genes terminal size th ~ 2 x read length, default {me2exon_sizeth}</span>
<span class="sd">        * me2exon_covth: 2exon genes cov th, default {me2exon_covth} </span>


<span class="sd">    Files:</span>
<span class="sd">        * sj.txt.gz</span>
<span class="sd">        * ex.txt.gz</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * selectseme.rm.se.bed.gz</span>
<span class="sd">        * selectseme.rm.me.bed.gz</span>
<span class="sd">        * selectseme.rm.ovl.txt.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="SELECTSEME.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SELECTSEME.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        
        <span class="c1"># select SE cov &gt; secovth</span>
        <span class="n">secovth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;FINDSE.secovth&#39;</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;secovth&#39;</span><span class="p">])</span>
        <span class="n">ae</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ae</span><span class="p">[</span><span class="s1">&#39;ed&#39;</span><span class="p">]</span><span class="o">-</span><span class="n">ae</span><span class="p">[</span><span class="s1">&#39;st&#39;</span><span class="p">]</span>
        <span class="n">me</span><span class="p">,</span> <span class="n">se</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">mese</span><span class="p">(</span><span class="n">ae</span><span class="p">)</span>
        <span class="n">se2</span> <span class="o">=</span> <span class="n">se</span><span class="p">[(</span><span class="n">se</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">secovth</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">se</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;se_sizeth2&#39;</span><span class="p">])]</span>
        <span class="c1"># sesizeth 50 (shorter in case of concatenation), sesizeth2 200 (real size threshold)</span>
        <span class="c1">#secov thresholding is also done at &quot;assemble&quot; FINDSE part, but there may be ME origin SE (irets)</span>
        <span class="n">sj1</span><span class="p">,</span> <span class="n">me1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_bad_2exon_genes</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">me</span><span class="p">)</span>
        <span class="n">sj2</span><span class="p">,</span> <span class="n">ex2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_overlapping_se</span><span class="p">(</span><span class="n">sj1</span><span class="p">,</span> <span class="n">se2</span><span class="p">,</span> <span class="n">me1</span><span class="p">)</span>
        <span class="c1"># ~400 SE (~15%) overlaps with ME</span>
        <span class="c1"># this will remove irets for 2 exon genes, which often can be noise</span>
        <span class="c1"># so removing corresponding iret will lose true model</span>
        <span class="c1"># only benefit of doing this is on the exon-match index, so not necessary</span>
        <span class="c1">#sj2 = sj1</span>
        <span class="c1">#ex2 = PD.concat([me1,se2], ignore_index=True)</span>
        <span class="n">ex3</span> <span class="o">=</span> <span class="n">ex2</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        
        <span class="c1"># SAVE</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">sj2</span><span class="p">,</span> <span class="s1">&#39;sj&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">ex3</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="c1"># if pr[&#39;findsecovth&#39;]: # save exname3</span>
        <span class="c1">#     fn.write_txt(ex3, &#39;ex2&#39;, category=&#39;output&#39;)</span>
        <span class="c1"># else: # save in exname2</span>
        <span class="c1">#     fn.write_txt(ex3, &#39;ex&#39;, category=&#39;output&#39;)</span>
        <span class="c1">#return sj2, ex3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">ex3</span></div>
    
    <span class="k">def</span> <span class="nf">_remove_bad_2exon_genes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">ex</span><span class="p">):</span>
        <span class="c1"># [TODO] also remove ME (&gt;2 exons) with low SJ support</span>
        <span class="c1"># e.g. 3 exon genes but uniq SJ support &lt;2 etc. </span>
        
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="c1"># find 2 exon genes</span>
        <span class="n">exg</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;_gidx&#39;</span><span class="p">)</span>
        <span class="n">exgs</span> <span class="o">=</span> <span class="n">exg</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">exons</span> <span class="o">=</span> <span class="n">ex</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_gidx&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">exgs</span><span class="p">[</span><span class="n">exgs</span><span class="o">==</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;  number of 2 exon exons:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">exons</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SELECTSEME_num_2exonexons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">exons</span><span class="p">)</span>
        <span class="c1"># find junction support</span>
        <span class="n">exons</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;_gidx&#39;</span><span class="p">,</span><span class="s1">&#39;a_id&#39;</span><span class="p">])</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;_gidx&#39;</span><span class="p">,</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)[</span><span class="s1">&#39;a_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">last</span><span class="p">()</span> <span class="c1"># -1,... </span>
        <span class="n">jsup</span> <span class="o">=</span> <span class="n">sj</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;a_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">aids</span><span class="o">.</span><span class="n">values</span><span class="p">][</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span>
        <span class="n">jsup</span> <span class="o">=</span> <span class="n">jsup</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">jsup</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">aid2jsup</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">jsup</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">jsup</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
        <span class="n">jsup</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">Series</span><span class="p">([</span><span class="n">aid2jsup</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aids</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;jsup&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">aids</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="c1"># find total length</span>
        <span class="n">tlen</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;_gidx&#39;</span><span class="p">)[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="c1"># find coverages</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">exons</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_gidx&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;len&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">e</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span>
        <span class="c1">#tval = val.groupby(val.index).sum()</span>
        <span class="c1">#tcov = tval/tlen</span>
        <span class="n">tval</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">val</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="c1"># in case one overlaps with an exon of another gene</span>
        <span class="n">tcov</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">tval</span><span class="o">/</span><span class="n">tlen</span>
        <span class="c1"># which ones to remove?</span>
        <span class="n">sjth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;me2exon_sjth&#39;</span><span class="p">]</span> <span class="c1"># 1 or 2</span>
        <span class="n">lenth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;me2exon_sizeth&#39;</span><span class="p">]</span>
        <span class="n">covth</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;me2exon_covth&#39;</span><span class="p">]</span>
        <span class="n">idx0</span> <span class="o">=</span> <span class="n">jsup</span><span class="o">&lt;</span><span class="n">sjth</span> <span class="c1"># if less than two uniq junction for 2 exon gene remove regardless of len/cov</span>
        <span class="n">idx1</span> <span class="o">=</span> <span class="p">(</span><span class="n">jsup</span><span class="o">==</span><span class="n">sjth</span><span class="p">)</span><span class="o">&amp;</span><span class="p">((</span><span class="n">tlen</span><span class="o">&lt;</span><span class="n">lenth</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">tcov</span><span class="o">&lt;</span><span class="n">covth</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">idx0</span> <span class="o">|</span> <span class="n">idx1</span>
        <span class="n">r_aids</span> <span class="o">=</span> <span class="n">aids</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">r_gids</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">ex1</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="o">~</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;_gidx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">r_gids</span><span class="p">)]</span>
        <span class="c1">#sj1 = sj[~sj[&#39;a_id&#39;].isin(r_aids)]</span>
        <span class="n">sj1</span> <span class="o">=</span> <span class="n">sj</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ex({0}) sj({1}) ==&gt; ex({2}) sj({3})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">ex1</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">sj1</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;SELECTSEME.#bad2exons&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">ex1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sj1</span><span class="p">,</span> <span class="n">ex1</span>
        
    <span class="k">def</span> <span class="nf">_remove_overlapping_se</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sj</span><span class="p">,</span> <span class="n">se</span><span class="p">,</span> <span class="n">me</span><span class="p">):</span>
        <span class="c1"># remove SE overlapping ME exons</span>
        <span class="c1"># 1. write SE,ME bed</span>
        <span class="c1"># 2. bedtools intersect</span>
        <span class="c1"># 3. remove overlapping SE</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">,</span><span class="s1">&#39;_id&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">se</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;selectseme.rm.se&#39;</span><span class="p">),</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">me</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;selectseme.rm.me&#39;</span><span class="p">),</span> <span class="n">fm</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">bedtoolintersect</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;selectseme.rm.ovl&#39;</span><span class="p">),</span><span class="n">wao</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1"># get original entry</span>
        <span class="n">cdf</span> <span class="o">=</span> <span class="n">BT</span><span class="o">.</span><span class="n">read_ovl</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">GGB</span><span class="o">.</span><span class="n">BEDCOLS</span><span class="p">[:</span><span class="mi">6</span><span class="p">])</span>
        <span class="n">cdfg</span> <span class="o">=</span> <span class="n">cdf</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;sc1&#39;</span><span class="p">)</span> <span class="c1"># sc1 &lt;= _id</span>
        <span class="n">ovl</span> <span class="o">=</span> <span class="n">cdfg</span><span class="p">[</span><span class="s1">&#39;ovl&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">siz</span> <span class="o">=</span> <span class="n">cdfg</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>
        <span class="n">nonovl_se</span> <span class="o">=</span> <span class="n">ovl</span><span class="p">[(</span><span class="n">ovl</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">siz</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span> 
        <span class="c1"># remove overlapping to only one ME exon ~((ovl&gt;0)&amp;(siz==1))</span>
        <span class="n">se2</span> <span class="o">=</span> <span class="n">se</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">ix</span><span class="p">[</span><span class="n">nonovl_se</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">ex2</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">me</span><span class="p">,</span><span class="n">se2</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;se({0}) =&gt; se({1}) {2} removed&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">se2</span><span class="p">),</span><span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">se2</span><span class="p">)))</span>
        <span class="n">st</span><span class="p">[</span><span class="s1">&#39;SELECTSEME.#removed_se&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">se</span><span class="p">)</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">se2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sj</span><span class="p">,</span> <span class="n">ex2</span></div>

<div class="viewcode-block" id="fixedge2"><a class="viewcode-back" href="../../modules.html#jgem.assembler.fixedge2">[docs]</a><span class="k">def</span> <span class="nf">fixedge2</span><span class="p">(</span><span class="n">ex</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">chrom</span><span class="p">):</span>
    <span class="n">ed</span> <span class="o">=</span> <span class="n">EdgeDetector</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># make sure first 3 cols are chr,st,ed</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ex</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
    <span class="n">ist</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;st&#39;</span><span class="p">)</span>
    <span class="n">ied</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span>
    <span class="n">icov</span> <span class="o">=</span> <span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;cov&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_gen</span><span class="p">():</span>
        <span class="k">with</span> <span class="n">ed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="c1"># left (st) =&gt; right (ed)</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">edges</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">find</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="n">icov</span><span class="p">])</span> <span class="c1"># [(interval, cov),...]</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">),</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">e1</span><span class="p">[</span><span class="n">ied</span><span class="p">]</span> <span class="o">=</span> <span class="n">x1</span>
                        <span class="n">e1</span><span class="p">[</span><span class="n">icov</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
                        <span class="k">yield</span> <span class="n">e1</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># right =&gt; left</span>
                <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ex</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">edges</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">find</span><span class="p">,</span><span class="bp">False</span><span class="p">,</span><span class="n">e</span><span class="p">[</span><span class="n">icov</span><span class="p">])</span> <span class="c1"># [(interval, cov),...]</span>
                    <span class="k">for</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">),</span> <span class="n">cov</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">:</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">e1</span><span class="p">[</span><span class="n">ist</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
                        <span class="n">e1</span><span class="p">[</span><span class="n">icov</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span>
                        <span class="k">yield</span> <span class="n">e1</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">_gen</span><span class="p">()]</span>
    <span class="c1">#msg = &#39;{2} found {0}/{1}&#39;.format(len(tmp),len(ex),chrom)</span>
    <span class="c1">#LOG.debug(msg)</span>
    <span class="c1">#open(&#39;fixedge2-{0}.txt&#39;.format(chrom),&#39;w&#39;).write(msg)</span>
    <span class="k">return</span> <span class="n">tmp</span></div>

<div class="viewcode-block" id="FIXEDGES2"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIXEDGES2">[docs]</a><span class="k">class</span> <span class="nc">FIXEDGES2</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find genes (connected components).</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon (all exon = single+multi exons) dataframe</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * np: number of CPU to use, default {np}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * genegraph-*</span>
<span class="sd">        * genes.cache.pic</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># look at cov and detect sharp drop/rise</span>
    
<div class="viewcode-block" id="FIXEDGES2.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIXEDGES2.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="c1"># clean up 3&#39;, 5&#39; ends by detecting sharp drop and removing them if covratio is &lt; threshold</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">cache</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;fixedge2&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;override&#39;</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">UT</span><span class="o">.</span><span class="n">read_pandas</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ex</span> <span class="o">=</span> <span class="n">ex</span>
        <span class="n">idx3</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;3&#39;</span>
        <span class="n">idx5</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;cat&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;5&#39;</span>
        <span class="n">idxp</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="s1">&#39;strand&#39;</span><span class="p">]</span><span class="o">==</span><span class="s1">&#39;+&#39;</span>
        <span class="n">idxn</span> <span class="o">=</span> <span class="o">~</span><span class="n">idxp</span>
        <span class="n">idxd</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx3</span><span class="o">&amp;</span><span class="n">idxp</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">idx5</span><span class="o">&amp;</span><span class="n">idxn</span><span class="p">)</span> <span class="c1"># =&gt; find sharp drop</span>
        <span class="n">idxr</span> <span class="o">=</span> <span class="p">(</span><span class="n">idx3</span><span class="o">&amp;</span><span class="n">idxn</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">idx5</span><span class="o">&amp;</span><span class="n">idxp</span><span class="p">)</span> <span class="c1"># &lt;= find sharp rise</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exd</span> <span class="o">=</span> <span class="n">exd</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">idxd</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exr</span> <span class="o">=</span> <span class="n">exr</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">idxr</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exo</span> <span class="o">=</span> <span class="n">exo</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[(</span><span class="o">~</span><span class="n">idx3</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="o">~</span><span class="n">idx5</span><span class="p">)]</span> <span class="c1"># &#39;i&#39;, &#39;s&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nexd</span> <span class="o">=</span> <span class="n">nexd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">exd</span><span class="p">,</span><span class="s1">&#39;drop&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nexr</span> <span class="o">=</span> <span class="n">nexr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">exr</span><span class="p">,</span><span class="s1">&#39;rise&#39;</span><span class="p">)</span>
        <span class="n">nex</span> <span class="o">=</span> <span class="n">PD</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">exo</span><span class="p">,</span><span class="n">nexd</span><span class="p">,</span><span class="n">nexr</span><span class="p">],</span><span class="n">ignore_index</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">nexg</span> <span class="o">=</span> <span class="n">nex</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s1">&#39;chr&#39;</span><span class="p">,</span><span class="s1">&#39;st&#39;</span><span class="p">,</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span><span class="s1">&#39;strand&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span> <span class="c1"># remove dup, in terms of pos&amp;strand</span>
        <span class="n">nexg</span><span class="p">[</span><span class="s1">&#39;_id0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nexg</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]</span> <span class="c1"># old id used for gene identification</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ids</span><span class="p">(</span><span class="n">nexg</span><span class="p">)</span> <span class="c1"># since there are dups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nexg</span> <span class="o">=</span> <span class="n">nexg</span> <span class="c1"># for debug</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">write_pandas</span><span class="p">(</span><span class="n">nexg</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="c1">#return nexg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#ae:{0}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nexg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;FIXEDGES2.#ae&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">nexg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">nexg</span></div>
        
<div class="viewcode-block" id="FIXEDGES2.process_mp"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FIXEDGES2.process_mp">[docs]</a>    <span class="k">def</span> <span class="nf">process_mp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span> <span class="n">find</span><span class="p">):</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39; preparing data...&#39;</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span>
                      <span class="n">sigmath</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_sigma&#39;</span><span class="p">],</span>
                      <span class="n">minth</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_minth&#39;</span><span class="p">],</span>
                      <span class="n">delta</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_window&#39;</span><span class="p">],</span>
                      <span class="n">covratio</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_covratio&#39;</span><span class="p">],</span>
                      <span class="n">winsize</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;ed_window&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">chrom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">chroms</span><span class="p">(</span><span class="n">ex</span><span class="p">):</span>
            <span class="n">exc</span> <span class="o">=</span> <span class="n">ex</span><span class="p">[</span><span class="n">ex</span><span class="p">[</span><span class="s1">&#39;chr&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">chrom</span><span class="p">]</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">exc</span><span class="p">,</span> <span class="n">find</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span><span class="n">chrom</span><span class="p">))</span>
        <span class="n">rslts</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">process_mp</span><span class="p">(</span><span class="n">fixedge2</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">])</span>
        <span class="c1"># rslts = []</span>
        <span class="c1"># np = p[&#39;np&#39;]</span>
        <span class="c1"># if np==1:</span>
        <span class="c1">#     for i,arg in enumerate(args):</span>
        <span class="c1">#         LOG.debug(&#39;  processing {0}/{1}...&#39;.format(i+1,len(args)))</span>
        <span class="c1">#         rslts += fixedge2(arg)</span>
        <span class="c1"># else:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         p = multiprocessing.Pool(np)</span>
        <span class="c1">#         tmp = p.map(fixedge2, args)</span>
        <span class="c1">#     finally:</span>
        <span class="c1">#         LOG.debug(&#39;  closing pool&#39;)</span>
        <span class="c1">#         p.close()</span>
        <span class="c1">#     rslts = reduce(iadd, tmp)</span>
        <span class="k">return</span> <span class="n">PD</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rslts</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">ex</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span></div></div>
        
<span class="c1"># class ADDJIE(SUBASE):</span>
    <span class="c1"># def call(self):</span>
        <span class="c1"># me = self.asm.me</span>
        <span class="c1"># sj = self.asm.sj</span>
        <span class="c1"># jie = self.asm.jie</span>
        <span class="c1"># fn = self.fnobj</span>
        <span class="c1"># pr = self.params        </span>
        <span class="c1"># # 1. find overlapping exons (discard jie if not found)</span>
        <span class="c1"># # 2. find surrounding junctions</span>
        <span class="c1"># # 3. select jie by ratio to surrounding junctions</span>
        <span class="c1"># a = GGB.write_bed(jie, fn.bedname(&#39;jie.sj&#39;), ncols=6)</span>
        <span class="c1"># b = GGB.write_bed(me, fn.bedname(&#39;jie.ex&#39;), ncols=6)</span>
        <span class="c1"># c = fn.txtname(&#39;jie.inte&#39;)</span>
        <span class="c1"># c = BT.bedtoolintersect(a,b,c,wao=True,f=1) # completely included</span>
        <span class="c1"># cols0 = GGB.BEDCOLS[:6]</span>
        <span class="c1"># cols = cols0+[&#39;b_&#39;+x for x in cols0]+[&#39;ovl&#39;]</span>
        <span class="c1"># o = UT.read_pandas(c, names=cols)</span>
        <span class="c1"># o[&#39;len&#39;] = o[&#39;ed&#39;] - o[&#39;st&#39;] # should be == ovl</span>
        <span class="c1"># UT._set_pos(sj, &#39;d_pos&#39;, &#39;st-1&#39;, &#39;ed&#39;)</span>
        <span class="c1"># UT._set_pos(sj, &#39;a_pos&#39;, &#39;ed&#39;, &#39;st-1&#39;)</span>
        <span class="c1"># UT._set_pos(o, &#39;d_pos&#39;, &#39;b_ed&#39;, &#39;b_st&#39;)</span>
        <span class="c1"># UT._set_pos(o, &#39;a_pos&#39;, &#39;b_st&#39;, &#39;b_ed&#39;)</span>
        <span class="c1"># # a_pos =&gt; max jcnt </span>
        <span class="c1"># # TODO fix from sc1 to appropriate column</span>
        <span class="c1"># sjg = sj.groupby(&#39;a_pos&#39;)[&#39;sc1&#39;].max().reset_index()</span>
        <span class="c1"># a2maxj = UT.df2dict(sjg, &#39;a_pos&#39;, &#39;sc1&#39;)</span>
        <span class="c1"># sjg = sj.groupby(&#39;d_pos&#39;)[&#39;sc1&#39;].max().reset_index()</span>
        <span class="c1"># d2maxj = UT.df2dict(sjg, &#39;d_pos&#39;, &#39;sc1&#39;)</span>
        <span class="c1"># o[&#39;d_max&#39;] = [d2maxj.get(x,0) for x in o[&#39;d_pos&#39;]]</span>
        <span class="c1"># o[&#39;a_max&#39;] = [a2maxj.get(x,0) for x in o[&#39;a_pos&#39;]]</span>
        <span class="c1"># o[&#39;sjmax&#39;] = o[[&#39;d_max&#39;,&#39;a_max&#39;]].max(axis=1)</span>
        <span class="c1"># o[&#39;locus&#39;] = UT.calc_locus_strand(o)</span>
        <span class="c1"># jie[&#39;locus&#39;] = UT.calc_locus_strand(jie)</span>
        <span class="c1"># l2j = UT.df2dict(jie, &#39;locus&#39;, &#39;sc1&#39;)</span>
        <span class="c1"># o[&#39;jcnt&#39;] = [l2j[x] for x in o[&#39;locus&#39;]]</span>
        <span class="c1"># o[&#39;ratio&#39;] = o[&#39;jcnt&#39;]/o[&#39;sjmax&#39;]</span>
        <span class="c1"># o = o[(o[&#39;strand&#39;]==o[&#39;b_strand&#39;])&amp;(o[&#39;len&#39;]==o[&#39;ovl&#39;])&amp;(o[&#39;ratio&#39;]&gt;pr[&#39;jieratio&#39;])]</span>
        <span class="c1"># usedjie = o.groupby([&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;strand&#39;]).first().reset_index()[cols0]</span>
        <span class="c1"># def _gen():</span>
        <span class="c1">#     cols = [&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;strand&#39;,&#39;name&#39;,&#39;b_st&#39;,&#39;b_ed&#39;,&#39;b_name&#39;]</span>
        <span class="c1">#     for c,s,e,t,n,bs,be,bn in UT.izipcols(o,cols):</span>
        <span class="c1">#         if bs&lt;s:</span>
        <span class="c1">#             yield (c,bs,s,bn+&#39;/&#39;+n,0,t)</span>
        <span class="c1">#         if e&lt;be:</span>
        <span class="c1">#             yield (c,e,be,n+&#39;/&#39;+bn,0,t)</span>
        <span class="c1"># ie = PD.DataFrame([x for x in _gen()], columns=cols0)</span>
        <span class="c1"># ex = PD.concat([me[cols0], ie[cols0]], ignore_index=True)</span>
        <span class="c1"># ex = ex.groupby([&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;strand&#39;]).first().reset_index()</span>
        <span class="c1"># sj1 = PD.concat([sj[cols0], usedjie[cols0]], ignore_index=True)</span>
        <span class="c1"># sj1 = sj1.groupby([&#39;chr&#39;,&#39;st&#39;,&#39;ed&#39;,&#39;strand&#39;]).first().reset_index()</span>
        <span class="c1"># LOG.info(&#39;add junctions in exon...&#39;)        </span>
        <span class="c1"># _sttime = time.time()</span>
        <span class="c1"># n0 = len(self.sj)</span>
        <span class="c1"># n1 = len(self.me)</span>
        <span class="c1"># LOG.info(&#39; sj {0}=&gt;{1} ex {2}=&gt;{3}&#39;.format(n0, len(self.sj), n1, len(self.me)))</span>
        <span class="c1"># LOG.info(&#39; time: {0:.3f}s&#39;.format(time.time()-_sttime))        </span>
        <span class="c1">## return ex, sj1</span>
        <span class="c1"># self.asm.me = ex</span>
        <span class="c1"># self.asm.sj = sj1</span>

<div class="viewcode-block" id="CALCCOV"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CALCCOV">[docs]</a><span class="k">class</span> <span class="nc">CALCCOV</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate coverages.</span>

<span class="sd">    Args:</span>
<span class="sd">        ae: exons dataframe</span>

<span class="sd">    SideEffects:</span>
<span class="sd">        add column (cov) to ae dataframe</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * cov.txt.gz</span>
<span class="sd">        * cov.bed.gz</span>
<span class="sd">        * assemble.cov.txt.gz</span>
<span class="sd">        * assemble.exons0.covci.txt.gz</span>
<span class="sd">        * assemble.exons0.ci.txt.gz</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CALCCOV.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CALCCOV.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">exons</span> <span class="o">=</span> <span class="n">CC</span><span class="o">.</span><span class="n">calc_cov_ovl_mp</span><span class="p">(</span>
                    <span class="n">srcname</span><span class="o">=</span><span class="n">ex</span><span class="p">,</span> <span class="c1">#fn.txtname(&#39;assemble.exons0&#39;), # cnt 2</span>
                    <span class="n">bwname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">bwfile</span><span class="p">,</span> 
                    <span class="n">dstname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;assemble.exons0.cov&#39;</span><span class="p">),</span> 
                    <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">],</span>
                    <span class="n">covciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;assemble.exons0.covci&#39;</span><span class="p">),</span> <span class="c1"># cnt 1</span>
                    <span class="n">ciname</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;assemble.exons0.ci&#39;</span><span class="p">),</span> <span class="c1"># cnt 1</span>
                    <span class="n">colname</span><span class="o">=</span><span class="s1">&#39;cov&#39;</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span> <span class="o">=</span> <span class="n">exons</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="s1">&#39;cov&#39;</span><span class="p">)</span>
        <span class="c1"># write BED format as well for checking purpose</span>
        <span class="n">exons</span><span class="p">[</span><span class="s1">&#39;sc1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exons</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">exons</span><span class="p">,</span> <span class="s1">&#39;cov&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="SETINFO"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SETINFO">[docs]</a><span class="k">class</span> <span class="nc">SETINFO</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set acceptor/donor id, exon categories.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon dataframe</span>

<span class="sd">    SideEffects:</span>
<span class="sd">        add columns to sj, ae dataframe</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SETINFO.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.SETINFO.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_ad_info</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">ae</span><span class="p">)</span>
        <span class="n">UT</span><span class="o">.</span><span class="n">set_exon_category</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="n">ae</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="FINDGENES"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDGENES">[docs]</a><span class="k">class</span> <span class="nc">FINDGENES</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find genes (connected components).</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon (all exon = single+multi exons) dataframe</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * np: number of CPU to use, default {np}</span>

<span class="sd">    TempFiles:</span>
<span class="sd">        * genegraph-*</span>
<span class="sd">        * genes.cache.pic</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FINDGENES.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.FINDGENES.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
        <span class="n">st</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stats</span>
        <span class="n">genes</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">find_genes4</span><span class="p">(</span>
            <span class="n">sj</span><span class="o">=</span><span class="n">sj</span><span class="p">,</span> 
            <span class="n">ae</span><span class="o">=</span><span class="n">ae</span><span class="p">,</span> 
            <span class="n">filepre</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genegraph-&#39;</span><span class="p">),</span> 
            <span class="n">cachename</span><span class="o">=</span><span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genes.cache.pic&#39;</span><span class="p">),</span> 
            <span class="n">np</span><span class="o">=</span><span class="n">pr</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">numme</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">genes</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">numse</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span> <span class="o">-</span> <span class="n">numme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39;#genes:ME{0}, SE(before selection){1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">numme</span><span class="p">,</span> <span class="n">numse</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;FINDGENES.#me_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;FINDGENES.#se_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numse</span>
        <span class="c1">#return genes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">genes</span> <span class="o">=</span> <span class="n">genes</span></div></div>

<div class="viewcode-block" id="WRITESJEX"><a class="viewcode-back" href="../../modules.html#jgem.assembler.WRITESJEX">[docs]</a><span class="k">class</span> <span class="nc">WRITESJEX</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write sj, ex and ci files.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon dataframe</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * findsecovth (bool): whether secovth is found from data</span>

<span class="sd">    Files:</span>
<span class="sd">        * sj.txt.gz</span>
<span class="sd">        * ex.txt.gz</span>
<span class="sd">        * ci.txt.gz</span>
<span class="sd">        * sj.bed.gz</span>
<span class="sd">        * ex.bed.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WRITESJEX.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.WRITESJEX.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>

        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="s1">&#39;sj&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span> <span class="s1">&#39;sj&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_txt</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">write_bed</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="s1">&#39;ex&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">cipath</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">txtname</span><span class="p">(</span><span class="s1">&#39;ci&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
        <span class="n">ci</span> <span class="o">=</span> <span class="n">UT</span><span class="o">.</span><span class="n">chopintervals</span><span class="p">(</span><span class="n">ae</span><span class="p">,</span> <span class="n">cipath</span><span class="p">)</span></div></div>

        <span class="c1"># if pr[&#39;findsecovth&#39;]: # save exname3</span>
        <span class="c1">#     fn.write_txt(ae, &#39;ex2&#39;, category=&#39;output&#39;)</span>
        <span class="c1">#     fn.write_bed(ae, &#39;ex2&#39;, category=&#39;output&#39;, ncols=6)</span>
        <span class="c1"># else: # save in exname2</span>
        <span class="c1">#     fn.write_txt(ae, &#39;ex&#39;, category=&#39;output&#39;)</span>
        <span class="c1">#     fn.write_bed(ae, &#39;ex&#39;, category=&#39;output&#39;, ncols=6)</span>

<div class="viewcode-block" id="WRITEGENES"><a class="viewcode-back" href="../../modules.html#jgem.assembler.WRITEGENES">[docs]</a><span class="k">class</span> <span class="nc">WRITEGENES</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Write genes (and isoform) BED (and GTF) files for viewing on browsers.</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon dataframe</span>

<span class="sd">    Related Parameters:</span>
<span class="sd">        * writeiso (bool): whether to write isoforms or not, default {writeiso}</span>
<span class="sd">        * maxisonum (int):; number of maximum isoforms to write, default {maxisonum}</span>
<span class="sd">        * writegtf (bool): whether to write GTF file, default {writegtf}</span>

<span class="sd">    Files:</span>
<span class="sd">        * genes.bed.gz</span>
<span class="sd">        * genes.iso*.bed.gz</span>
<span class="sd">        * genes.gtf.gz</span>
<span class="sd">        * genes.iso*.gtf.gz</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="WRITEGENES.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.WRITEGENES.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fnobj</span>
        <span class="n">pr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>

        <span class="n">mg</span> <span class="o">=</span> <span class="n">GP</span><span class="o">.</span><span class="n">MEGraph4</span><span class="p">(</span><span class="n">sj</span><span class="p">,</span><span class="n">ae</span><span class="p">,</span><span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genegraph-&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bedwriter</span> <span class="o">=</span> <span class="n">bw</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">BEDWriter</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; writing bed12 genes...&#39;</span><span class="p">)</span>
        <span class="n">bw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">bedname</span><span class="p">(</span><span class="s1">&#39;genes&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">))</span>
        <span class="n">maxiso</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;maxisonum&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;writeiso&#39;</span><span class="p">]:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; writing bed12 isoforms...&#39;</span><span class="p">)</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genes.iso{0}.bed.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxiso</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
            <span class="n">bw</span><span class="o">.</span><span class="n">write_iso</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">maxiso</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;writegtf&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gtfwriter</span> <span class="o">=</span> <span class="n">gw</span> <span class="o">=</span> <span class="n">CV</span><span class="o">.</span><span class="n">GTFWriter</span><span class="p">(</span><span class="n">mg</span><span class="p">)</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; writing gtf genes...&#39;</span><span class="p">)</span>
            <span class="n">gw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genes.gtf.gz&#39;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">pr</span><span class="p">[</span><span class="s1">&#39;writeiso&#39;</span><span class="p">]:</span>
                <span class="n">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39; writing gtf isoforms...&#39;</span><span class="p">)</span>
                <span class="n">fname</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">fname</span><span class="p">(</span><span class="s1">&#39;genes.iso{0}.gtf.gz&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">maxiso</span><span class="p">),</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;output&#39;</span><span class="p">)</span>
                <span class="n">gw</span><span class="o">.</span><span class="n">write_iso</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">maxiso</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="CONSISTENTSJ"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CONSISTENTSJ">[docs]</a><span class="k">class</span> <span class="nc">CONSISTENTSJ</span><span class="p">(</span><span class="n">SUBASE</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Remove junctions without connections to exons</span>

<span class="sd">    Args:</span>
<span class="sd">        sj: junction dataframe</span>
<span class="sd">        ae: exon dataframe</span>

<span class="sd">    Returns:</span>
<span class="sd">        :sj: modify assembler sj</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="CONSISTENTSJ.call"><a class="viewcode-back" href="../../modules.html#jgem.assembler.CONSISTENTSJ.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span>
        <span class="n">ae</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">ae</span>
        <span class="n">dids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ae</span><span class="p">[</span><span class="s1">&#39;d_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">aids</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">ae</span><span class="p">[</span><span class="s1">&#39;a_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;a_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">aids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">sj</span><span class="p">[</span><span class="s1">&#39;d_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">dids</span><span class="p">)</span>
        <span class="n">sj2</span> <span class="o">=</span> <span class="n">sj</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="s1">&#39; #sj {0} =&gt; {1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sj</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;CONSISTENTSJ.#sj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sj2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asm</span><span class="o">.</span><span class="n">sj</span> <span class="o">=</span> <span class="n">sj2</span></div></div>



<span class="c1"># EdgeDetector ##########################################################</span>

<div class="viewcode-block" id="EdgeDetector"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector">[docs]</a><span class="k">class</span> <span class="nc">EdgeDetector</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO</span>
    <span class="c1"># double mimath: lower always just cut, between lower and higher: also return entire interval</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bwname</span><span class="p">,</span> <span class="n">sigmath</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">minth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">covratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> 
                       <span class="n">winsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">covth</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">smwinsize</span><span class="o">=</span><span class="mi">151</span><span class="p">,</span> <span class="n">minintsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                       <span class="n">mimath</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">triggerth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">mimath2</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">mincutlen</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                       <span class="n">aggregateratio</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">gap</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">gapth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Args:</span>
<span class="sd">            bwname (str): path to coverage bigwig file </span>
<span class="sd">            sigmath (float): sigma threshold (default 3)</span>
<span class="sd">            minth (float):  (default 0.5)</span>
<span class="sd">            delta (int): (default 15)</span>
<span class="sd">            covratio (float): (default 0.1)</span>
<span class="sd">            winsize (int): (default 15)</span>
<span class="sd">            covth (float): (default 0.005)</span>
<span class="sd">            smwinsize (int): (default 151)</span>
<span class="sd">            minintsize (int): (default 10)</span>
<span class="sd">            mimath (float): min, max threshold (default 0.15)</span>
<span class="sd">            triggerth (float): (default 2)</span>
<span class="sd">            mimath2 (float): (default None)</span>
<span class="sd">            mincutlen (int): (default 50)</span>
<span class="sd">            aggregateratio (float): (default 0.1)</span>
<span class="sd">            verbose (bool): (default False)</span>
<span class="sd">            gap (int): (default 0)</span>
<span class="sd">            gapth (float): (default 0.)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bwname</span> <span class="o">=</span> <span class="n">bwname</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sigmath</span> <span class="o">=</span> <span class="n">sigmath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minth</span> <span class="o">=</span> <span class="n">minth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="o">=</span> <span class="n">delta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covratio</span><span class="o">=</span><span class="n">covratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covth</span><span class="o">=</span><span class="n">covth</span>
        <span class="k">if</span> <span class="n">winsize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">winsize</span> <span class="o">+=</span> <span class="mi">1</span> <span class="c1"># make sure to use odd number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">winsize</span> <span class="o">=</span> <span class="n">winsize</span>
        <span class="k">if</span> <span class="n">smwinsize</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">smwinsize</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smwinsize</span> <span class="o">=</span> <span class="n">smwinsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span> <span class="o">=</span> <span class="n">minintsize</span> <span class="c1"># ignore interval smaller than this</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mimath</span> <span class="o">=</span> <span class="n">mimath</span> <span class="c1"># min/max ratio threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">triggerth</span> <span class="o">=</span> <span class="n">triggerth</span> <span class="c1"># once under mimath, trigger rise if cov &gt; triggerthth*mimath </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">swin</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">smwinsize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">winsize</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mimath2</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">mimath</span><span class="o">*</span><span class="mf">2.5</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span> <span class="o">=</span> <span class="n">mimath2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mincutlen</span> <span class="o">=</span> <span class="n">mincutlen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aggregateratio</span> <span class="o">=</span> <span class="n">aggregateratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gap</span> <span class="o">=</span> <span class="n">gap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gapth</span> <span class="o">=</span> <span class="n">gapth</span>


    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fobj</span> <span class="o">=</span> <span class="n">fobj</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bwname</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bw</span> <span class="o">=</span> <span class="n">BW</span><span class="o">.</span><span class="n">BigWigFile</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fobj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
<div class="viewcode-block" id="EdgeDetector.get"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">):</span>
        <span class="c1"># bw.get(chr,st,ed) =&gt; [ (st,ed,val), ... ]</span>
        <span class="c1">#d = self.delta</span>
        <span class="c1">#st0 = st-d</span>
        <span class="n">st0</span> <span class="o">=</span> <span class="n">st</span>
        <span class="c1">#ed0 = ed+d</span>
        <span class="n">ed0</span> <span class="o">=</span> <span class="n">ed</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">ed0</span><span class="o">-</span><span class="n">st0</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span><span class="p">):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">-</span><span class="n">st0</span>
            <span class="n">i1</span> <span class="o">=</span> <span class="n">x1</span><span class="o">-</span><span class="n">st0</span>
            <span class="n">vals</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="k">return</span> <span class="n">vals</span></div>
        
<div class="viewcode-block" id="EdgeDetector.findpeak"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.findpeak">[docs]</a>    <span class="k">def</span> <span class="nf">findpeak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sign</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="o">==-</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># negative peak</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">dtmp</span><span class="o">&lt;-</span><span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">dtmp</span><span class="o">&gt;</span><span class="n">th</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># if non found at this stage return []</span>
        <span class="c1">#LOG.debug &#39;len(idx)=&#39;,len(idx)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1"># group into contiguous indices</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">cgr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span> <span class="c1"># next index</span>
                <span class="n">cgr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                <span class="n">x0</span><span class="o">=</span><span class="n">x</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cgr</span><span class="p">))</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">cgr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
        <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cgr</span><span class="p">)</span> <span class="c1"># last group</span>
        <span class="c1">#LOG.debug &#39;groups=&#39;,groups</span>
        <span class="c1"># find min(sign -1) or max(sign +1) within each group</span>
        <span class="k">if</span> <span class="n">sign</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">dtmp</span><span class="p">[</span><span class="n">g</span><span class="p">])]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rslt</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span><span class="p">[</span><span class="n">N</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">dtmp</span><span class="p">[</span><span class="n">g</span><span class="p">])]</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rslt</span></div>
        
<div class="viewcode-block" id="EdgeDetector.cutQ"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.cutQ">[docs]</a>    <span class="k">def</span> <span class="nf">cutQ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">)</span>
        <span class="n">mima</span><span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mima</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="EdgeDetector.plotcut"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.plotcut">[docs]</a>    <span class="k">def</span> <span class="nf">plotcut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">direction</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
            <span class="n">itvs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getdm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covth</span> <span class="c1"># absolute min</span>
        <span class="c1">#th2 = 2**(N.max(N.log2(v+1))*self.covratio)-1 # relative conservative</span>
        <span class="n">th2</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covratio</span>
        <span class="n">th3</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span> <span class="c1"># last resort</span>
        <span class="n">th3b</span> <span class="o">=</span> <span class="n">th3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">triggerth</span>
        <span class="n">thd</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmath</span><span class="o">*</span><span class="n">dm</span><span class="o">.</span><span class="n">std</span><span class="p">())</span>
        <span class="c1">#thd = 2**thd - 1</span>
        <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;plotcut variables:ma({ma}),th1({th1}),th2({th2}),th3({th3}),th3b({th3b})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">locals</span><span class="p">()))</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">axr</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="c1">#P.plot(x,2**N.abs(dm)-1)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">dm</span><span class="p">)</span>

        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">thd</span><span class="p">,</span><span class="n">thd</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">th1</span><span class="p">,</span><span class="n">th1</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">th2</span><span class="p">,</span><span class="n">th2</span><span class="p">],</span><span class="s1">&#39;g--&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">th3</span><span class="p">,</span><span class="n">th3</span><span class="p">],</span><span class="s1">&#39;m--&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">th3b</span><span class="p">,</span><span class="n">th3b</span><span class="p">],</span><span class="s1">&#39;m--&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
            <span class="n">axr</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">axr</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">itvs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">:</span>
                <span class="n">itvs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">itvs</span><span class="p">)</span>
                <span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span> <span class="o">=</span> <span class="n">itvs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span> <span class="n">st1</span><span class="p">,</span> <span class="n">ed1</span> <span class="ow">in</span> <span class="n">itvs</span><span class="p">:</span>
                    <span class="n">ist</span> <span class="o">=</span> <span class="n">st0</span><span class="o">-</span><span class="n">st</span>
                    <span class="n">ied</span> <span class="o">=</span> <span class="n">ed1</span><span class="o">-</span><span class="n">st</span>
                    <span class="n">cov</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="n">ist</span><span class="p">:</span><span class="n">ied</span><span class="p">])</span>
                    <span class="n">st0</span> <span class="o">=</span> <span class="n">ed1</span>
                    <span class="c1">#LOG.debug((chrom1, st1, ed1), cov, (ist,ied))</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">ed1</span><span class="p">,</span><span class="n">ed1</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">ed1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span><span class="s1">&#39;{0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vi</span> <span class="o">=</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">itvsi</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">itvs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">chrom0</span><span class="p">,</span><span class="n">st0</span><span class="p">,</span><span class="n">ed0</span> <span class="o">=</span> <span class="n">itvsi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">chrom1</span><span class="p">,</span> <span class="n">st1</span><span class="p">,</span> <span class="n">ed1</span> <span class="ow">in</span> <span class="n">itvsi</span><span class="p">:</span>
                    <span class="n">ist</span> <span class="o">=</span> <span class="n">ed</span> <span class="o">-</span> <span class="n">ed0</span>
                    <span class="n">ied</span> <span class="o">=</span> <span class="n">ed</span> <span class="o">-</span> <span class="n">st1</span>
                    <span class="n">cov</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">vi</span><span class="p">[</span><span class="n">ist</span><span class="p">:</span><span class="n">ied</span><span class="p">])</span>
                    <span class="n">ed0</span> <span class="o">=</span> <span class="n">st1</span>
                    <span class="c1">#LOG.debug((chrom1, st1, ed1), cov, (ist,ied))</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">st1</span><span class="p">,</span><span class="n">st1</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                    <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">st1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span><span class="s1">&#39;{0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="EdgeDetector.cutboth"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.cutboth">[docs]</a>    <span class="k">def</span> <span class="nf">cutboth</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span><span class="p">)</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mincutlen</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],[],[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mima</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
        <span class="n">sws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smwinsize</span> <span class="c1"># smooth window for abs cov th detection</span>
        <span class="n">swin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swin</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">swin</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)[</span><span class="n">sws</span><span class="p">:</span><span class="o">-</span><span class="n">sws</span><span class="p">]</span>
        <span class="c1"># left and right</span>
        <span class="n">cleft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sm</span><span class="p">)</span>
        <span class="n">cright</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sm</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mima</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">cleft</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cright</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">cleft</span><span class="p">,</span> <span class="n">cright</span><span class="p">,</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">cleft</span><span class="p">,</span> <span class="n">cright</span><span class="p">,</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="EdgeDetector.cutone"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.cutone">[docs]</a>    <span class="k">def</span> <span class="nf">cutone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">direction</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ed</span><span class="o">-</span><span class="n">st</span><span class="p">)</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mincutlen</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],[],[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mima</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
        <span class="n">sws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smwinsize</span> <span class="c1"># smooth window for abs cov th detection</span>
        <span class="n">swin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swin</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">swin</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)[</span><span class="n">sws</span><span class="p">:</span><span class="o">-</span><span class="n">sws</span><span class="p">]</span>
        <span class="c1"># left and right</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;+&#39;</span><span class="p">:</span>
            <span class="n">cleft</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sm</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mima</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cleft</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">cleft</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
            <span class="k">return</span> <span class="n">cleft</span><span class="p">,[],[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cright</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="s1">&#39;-&#39;</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">sm</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mima</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cright</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[],</span> <span class="n">cright</span><span class="p">,</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">[],</span> <span class="n">cright</span><span class="p">,</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="EdgeDetector.getdm"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.getdm">[docs]</a>    <span class="k">def</span> <span class="nf">getdm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winsize</span> <span class="c1"># smooth window for derivative</span>
        <span class="n">hws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ws</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># ws has to be odd number</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span> 
        <span class="c1">#lv = N.log2(v+1)</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">lv1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lv</span><span class="p">,</span> <span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">lv1</span><span class="p">,</span> <span class="n">win</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="n">ws</span><span class="p">:]</span><span class="o">-</span><span class="n">sm</span><span class="p">[:</span><span class="o">-</span><span class="n">ws</span><span class="p">])[(</span><span class="n">hws</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="n">hws</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">dm</span></div>

<div class="viewcode-block" id="EdgeDetector.getsm"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.getsm">[docs]</a>    <span class="k">def</span> <span class="nf">getsm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">sws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smwinsize</span> <span class="c1"># smooth window for abs cov th detection</span>
        <span class="n">swin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swin</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="k">return</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">swin</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)[</span><span class="n">sws</span><span class="p">:</span><span class="o">-</span><span class="n">sws</span><span class="p">]</span></div>

    <span class="k">def</span> <span class="nf">_findmax</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">v</span><span class="p">):</span>
        <span class="n">gap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gap</span>
        <span class="n">minidx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">gapth</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">minidx</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">cidx</span> <span class="o">=</span> <span class="n">minidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">minidx</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="n">idx</span><span class="o">-</span><span class="n">cidx</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># contiguous</span>
                <span class="n">size</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">size</span><span class="o">&gt;</span><span class="n">gap</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">),</span><span class="n">cidx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">cidx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="c1"># all gaps were &lt; gap size th</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>

<div class="viewcode-block" id="EdgeDetector.fix"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.fix">[docs]</a>    <span class="k">def</span> <span class="nf">fix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sm</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sm</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getsm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># gap?</span>
        <span class="n">olen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">maidx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_findmax</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="p">[:</span><span class="n">maidx</span><span class="p">]</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">sm</span><span class="p">[:</span><span class="n">maidx</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;size={0}=&gt;{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">olen</span><span class="p">,</span><span class="n">maidx</span><span class="p">))</span>

        <span class="n">mima</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="n">eds0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_sharp_drops</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">olen</span><span class="p">)</span>
        <span class="n">l0</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds0</span><span class="p">)</span>
        <span class="n">eds1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_rise</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">l1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l1</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">eds1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_low_level</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">l2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">l2</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">l0</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">eds1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="n">l3</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">l3</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span><span class="c1"># nothing detected, last resort</span>
                    <span class="n">eds1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_rise2</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="n">l4</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;drop({0}), rise({1}), low({2}), min({3}), rise2({4})&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">l0</span><span class="p">,</span><span class="n">l1</span><span class="p">,</span><span class="n">l2</span><span class="p">,</span><span class="n">l3</span><span class="p">,</span><span class="n">l4</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds1</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">eds1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trim</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">sm</span><span class="p">,</span><span class="n">eds1</span><span class="p">)</span>
        <span class="n">eds</span> <span class="o">=</span> <span class="n">eds0</span><span class="o">+</span><span class="n">eds1</span>  
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">olen</span><span class="o">&gt;</span><span class="n">maidx</span><span class="p">):</span>
            <span class="n">eds</span> <span class="o">=</span> <span class="p">[</span><span class="n">maidx</span><span class="p">]</span>
        <span class="n">eds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">olen</span><span class="p">,</span><span class="n">eds</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eds</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">direction</span><span class="o">==</span><span class="s1">&#39;-&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">ed</span><span class="o">-</span><span class="n">x</span><span class="p">,</span> <span class="n">ed</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eds</span><span class="p">]</span> <span class="c1"># (st=ed-idx, ed)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">st</span><span class="o">+</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eds</span><span class="p">]</span> <span class="c1"># (st, st+idx)</span></div>

    <span class="k">def</span> <span class="nf">_aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">,</span> <span class="n">bs</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">maxlen</span><span class="o">-</span><span class="n">bs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">bsi</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregateratio</span> <span class="c1"># 10% of longer</span>
            <span class="n">cur</span> <span class="o">=</span> <span class="n">bsi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mis2</span> <span class="o">=</span> <span class="n">ar</span><span class="o">*</span><span class="n">cur</span>
            <span class="n">bs2</span> <span class="o">=</span> <span class="p">[</span><span class="n">cur</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">bsi</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">cur</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">&gt;</span><span class="n">mis2</span><span class="p">:</span><span class="c1">#ar*cur:</span>
                    <span class="n">bs2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                    <span class="n">cur</span> <span class="o">=</span> <span class="n">b</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">bs2</span><span class="p">)</span>
        <span class="c1"># if len(bs)&gt;1: # aggregate close by</span>
        <span class="c1">#     bs = [bs[0]] + [x1 for x0,x1 in zip(bs[:-1], bs[1:]) if x1-x0&gt;mis]</span>
        <span class="k">return</span> <span class="n">bs</span>

<div class="viewcode-block" id="EdgeDetector.detect_rise"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.detect_rise">[docs]</a>    <span class="k">def</span> <span class="nf">detect_rise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">/</span><span class="n">ma</span>
        <span class="k">if</span> <span class="n">mima</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span>
            <span class="n">th2</span> <span class="o">=</span> <span class="n">th1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">triggerth</span>
        <span class="k">elif</span> <span class="n">mima</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span>
            <span class="n">th2</span> <span class="o">=</span> <span class="n">th1</span><span class="o">+</span><span class="p">(</span><span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">ist</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="n">th1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ist</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-</span><span class="n">ist</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1">#LOG.debug(&#39;detect_rise startidx:{0}&#39;.format(ist))</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">ist</span><span class="p">]</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">ist</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ist</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cmin</span><span class="o">&gt;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">imin</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">th2</span><span class="p">:</span> <span class="c1"># rise detected</span>
                <span class="c1">#LOG.debug(&#39; rise at:{0},trigger at:{1}&#39;.format(imin, i))</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">imin</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="EdgeDetector.detect_rise2"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.detect_rise2">[docs]</a>    <span class="k">def</span> <span class="nf">detect_rise2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mi</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">mi</span><span class="o">/</span><span class="n">ma</span>
        <span class="k">if</span> <span class="n">mima</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span>
            <span class="n">th2</span> <span class="o">=</span> <span class="n">th1</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">triggerth</span>
        <span class="k">elif</span> <span class="n">mima</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span><span class="p">:</span>
            <span class="n">th1</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath2</span>
            <span class="n">th2</span> <span class="o">=</span> <span class="n">th1</span><span class="o">+</span><span class="p">(</span><span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mimath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">ist</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&gt;=</span><span class="n">th1</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ist</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">-</span><span class="n">ist</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="c1">#LOG.debug(&#39;detect_rise startidx:{0}&#39;.format(ist))</span>
        <span class="n">cmin</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">ist</span><span class="p">]</span>
        <span class="n">imin</span> <span class="o">=</span> <span class="n">ist</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ist</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cmin</span><span class="o">&gt;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                <span class="n">cmin</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">imin</span> <span class="o">=</span> <span class="n">i</span>
            <span class="k">elif</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">th2</span><span class="p">:</span> <span class="c1"># rise detected</span>
                <span class="c1">#LOG.debug(&#39; rise at:{0},trigger at:{1}&#39;.format(imin, i))</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">imin</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="EdgeDetector.detect_low_level"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.detect_low_level">[docs]</a>    <span class="k">def</span> <span class="nf">detect_low_level</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covth</span> <span class="c1"># absolute min</span>
        <span class="n">th2</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covratio</span>
        <span class="n">th3</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">th2</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="n">th1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">def</span> <span class="nf">_chk</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
           <span class="k">return</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">_chk</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="n">th2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">_chk</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">v</span><span class="o">&lt;</span><span class="n">th3</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">_chk</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></div>

<div class="viewcode-block" id="EdgeDetector.detect_min"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.detect_min">[docs]</a>    <span class="k">def</span> <span class="nf">detect_min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">idx</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">idx</span><span class="p">]</span></div>


<div class="viewcode-block" id="EdgeDetector.trim"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.trim">[docs]</a>    <span class="k">def</span> <span class="nf">trim</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">eds</span><span class="p">):</span>
        <span class="c1"># just trim left most</span>
        <span class="n">th1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covth</span> <span class="c1"># absolute min</span>
        <span class="c1">#th2 = 2**(N.max(N.log2(v+1))*self.covratio)-1 # relative conservative</span>
        <span class="n">eidx</span><span class="o">=</span><span class="n">eds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">eidx</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eds</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">[:</span><span class="n">eidx</span><span class="p">])</span> <span class="c1"># max of the region</span>
        <span class="n">th2</span> <span class="o">=</span> <span class="n">ma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covratio</span>
        <span class="c1">#acovth = max(th1,th2)</span>
        <span class="c1">#acovth=th2</span>
        <span class="c1">#self._acovth = acovth</span>
        <span class="k">while</span><span class="p">(</span><span class="n">eidx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sm</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">th2</span><span class="p">):</span>
            <span class="n">eidx</span> <span class="o">=</span> <span class="n">eidx</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span><span class="p">(</span><span class="n">eidx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">v</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">th2</span><span class="p">):</span>
            <span class="n">eidx</span> <span class="o">=</span> <span class="n">eidx</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">eds</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="o">&lt;</span><span class="n">eidx</span><span class="p">]</span><span class="o">+</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span></div>

<div class="viewcode-block" id="EdgeDetector.detect_sharp_drops"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.detect_sharp_drops">[docs]</a>    <span class="k">def</span> <span class="nf">detect_sharp_drops</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">maxlen</span><span class="p">):</span>
        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winsize</span> <span class="c1"># smooth window for derivative</span>
        <span class="n">hws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ws</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># ws has to be odd number</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span> 
        <span class="c1">#lv = N.log2(v+1)</span>
        <span class="n">lv</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">lv1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lv</span><span class="p">,</span> <span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">lv1</span><span class="p">,</span> <span class="n">win</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="n">ws</span><span class="p">:]</span><span class="o">-</span><span class="n">sm</span><span class="p">[:</span><span class="o">-</span><span class="n">ws</span><span class="p">])[(</span><span class="n">hws</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="n">hws</span><span class="p">]</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">th</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmath</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">bs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeak</span><span class="p">(</span><span class="n">dm</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># detect drop</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">maxlen</span><span class="p">,</span><span class="n">bs</span><span class="p">)</span></div>


<div class="viewcode-block" id="EdgeDetector.calc_stats"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.calc_stats">[docs]</a>    <span class="k">def</span> <span class="nf">calc_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span> <span class="c1"># raw cov between (st,ed)</span>
        <span class="n">th</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covth</span> <span class="c1"># abs th</span>
        <span class="c1">#d = self.delta # not use </span>
        <span class="n">sws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smwinsize</span> <span class="c1"># smooth window for abs cov th detection</span>

        <span class="n">ws</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">winsize</span> <span class="c1"># smooth window for derivative</span>
        <span class="n">hws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ws</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># ws has to be odd number</span>
        <span class="n">swin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">swin</span>
        <span class="n">win</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">win</span> 

        <span class="n">lv</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">v0</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">,</span> <span class="n">swin</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">ssm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">swin</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">sws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)[</span><span class="n">sws</span><span class="p">:</span><span class="o">-</span><span class="n">sws</span><span class="p">]</span>

        <span class="n">lv1</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lv</span><span class="p">,</span> <span class="n">win</span><span class="o">*</span><span class="n">lv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">lv1</span><span class="p">,</span> <span class="n">win</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ws</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="p">(</span><span class="n">sm</span><span class="p">[</span><span class="n">ws</span><span class="p">:]</span><span class="o">-</span><span class="n">sm</span><span class="p">[:</span><span class="o">-</span><span class="n">ws</span><span class="p">])[(</span><span class="n">hws</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="o">-</span><span class="n">hws</span><span class="p">]</span>
        <span class="c1">#LOG.debug len(dm),len(lv),len(sm)</span>
        <span class="n">mi</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">ma</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="n">mima</span> <span class="o">=</span> <span class="n">mi</span><span class="o">/</span><span class="n">ma</span>
        <span class="c1">#dmax = N.max(N.abs(dm))</span>
        <span class="c1">#rdmax = dmax/N.max(sm)</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">dm</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">th</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">minth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sigmath</span><span class="o">*</span><span class="n">sigma</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">,</span> <span class="n">dm</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">ssm</span><span class="p">,</span> <span class="n">mima</span></div>

        <span class="c1">#ltmp = N.log2(tmp+1)</span>
        <span class="c1">#w = N.ones(sws)/float(sws)</span>
        <span class="c1">#sm = N.convolve(ltmp, w, &#39;same&#39;)</span>
        <span class="c1">#dtmp = N.array(ltmp[1:]-ltmp[:-1])</span>
        <span class="c1">#hws = int(ws/2)</span>
        <span class="c1">#dtmp = N.array([0]+[(ltmp[i:i+ws].mean()-ltmp[max(0,i-ws):i].mean()) for i in range(1,len(ltmp))])    </span>
        <span class="c1">#w2 = N.ones(ws)/float(ws)</span>
        <span class="c1">#sm2 = N.convolve(ltmp, w2, &#39;same&#39;)</span>
        <span class="c1">#dtmp1 = sm2[ws:]-sm2[:-ws]</span>
        <span class="c1">#dtmp = N.concatenate([N.zeros(hws+1),dtmp1, N.zeros(hws)])</span>
        <span class="c1">#sigma = dtmp.std()</span>
        <span class="c1">#th = max(self.minth, self.sigmath*sigma)</span>
        <span class="c1">#return tmp, dtmp, th, sm</span>
        
<div class="viewcode-block" id="EdgeDetector.find"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.find">[docs]</a>    <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">chrom</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">ed</span><span class="p">,</span> <span class="n">find</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span><span class="n">returnall</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">ocov</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="c1">#tmp, dtmp, th, sm = self._calc_dtmp(chrom,st,ed)</span>
        <span class="n">tmp</span><span class="p">,</span> <span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">mima</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_stats</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">v</span><span class="p">)</span>
        <span class="c1"># trim edge</span>
        <span class="c1">#d = self.delta</span>
        <span class="c1">#s0 = st-d </span>
        <span class="n">s0</span> <span class="o">=</span> <span class="n">st</span>
        <span class="c1"># acovth = self.covth</span>
        <span class="c1"># use adaptive abs cov</span>
        <span class="n">acovth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">covth</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covratio</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acovth</span> <span class="o">=</span> <span class="n">acovth</span>
        <span class="k">if</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="c1"># trim right side</span>
            <span class="n">eidx</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span><span class="p">(</span><span class="n">eidx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">sm</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">acovth</span><span class="p">):</span>
                <span class="n">eidx</span> <span class="o">=</span> <span class="n">eidx</span><span class="o">-</span><span class="mi">1</span>
            <span class="k">while</span><span class="p">(</span><span class="n">eidx</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">tmp</span><span class="p">[</span><span class="n">eidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">acovth</span><span class="p">):</span>
                <span class="n">eidx</span> <span class="o">=</span> <span class="n">eidx</span><span class="o">-</span><span class="mi">1</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ed</span><span class="p">,</span><span class="n">s0</span><span class="o">+</span><span class="n">eidx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">e1</span> <span class="o">=</span> <span class="n">ed</span>
        <span class="k">if</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;both&#39;</span> <span class="ow">or</span> <span class="n">find</span><span class="o">!=</span><span class="s1">&#39;drop&#39;</span><span class="p">:</span> <span class="c1"># trim left side</span>
            <span class="n">sidx</span><span class="o">=</span><span class="mi">0</span>
            <span class="n">n</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="k">while</span><span class="p">(</span><span class="n">sidx</span><span class="o">&lt;</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">sm</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">acovth</span><span class="p">):</span>
                <span class="n">sidx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="k">while</span><span class="p">(</span><span class="n">sidx</span><span class="o">&lt;</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span> <span class="ow">and</span> <span class="n">tmp</span><span class="p">[</span><span class="n">sidx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">acovth</span><span class="p">):</span>
                <span class="n">sidx</span><span class="o">+=</span><span class="mi">1</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="n">s0</span><span class="o">+</span><span class="n">sidx</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">st</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_st</span> <span class="o">=</span> <span class="n">st</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ed</span> <span class="o">=</span> <span class="n">ed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_s1</span> <span class="o">=</span> <span class="n">s1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_e1</span> <span class="o">=</span> <span class="n">e1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">e1</span><span class="o">&lt;=</span><span class="n">st</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">s1</span><span class="o">&gt;=</span><span class="n">ed</span><span class="p">):</span> <span class="c1"># entire region below covth return original</span>
            <span class="k">if</span> <span class="n">returnall</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[((</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">),</span><span class="n">ocov</span><span class="p">,</span><span class="bp">False</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">[((</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">),</span><span class="n">ocov</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;both&#39;</span><span class="p">:</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeak</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#N.nonzero(dtmp&lt;-th)[0]+1</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeak</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#N.nonzero(dtmp&gt;th)[0]</span>
        <span class="k">elif</span> <span class="n">find</span><span class="o">==</span><span class="s1">&#39;drop&#39;</span><span class="p">:</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeak</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#N.nonzero(dtmp&lt;-th)[0]+1</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">findpeak</span><span class="p">(</span><span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#N.nonzero(dtmp&gt;th)[0]</span>
            <span class="n">idx0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idx0</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">idx1</span><span class="p">)))</span>
        
        <span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">s0</span><span class="o">+</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span> <span class="k">if</span> <span class="p">((</span><span class="n">s0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;=</span><span class="n">s1</span><span class="p">)</span> <span class="ow">and</span> <span class="p">((</span><span class="n">s0</span><span class="o">+</span><span class="n">x</span><span class="p">)</span><span class="o">&lt;=</span><span class="n">e1</span><span class="p">)]</span> <span class="c1"># boundaries</span>
        <span class="n">mis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minintsize</span>
        <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">s1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">while</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">e1</span><span class="p">)</span><span class="o">&lt;</span><span class="n">mis</span><span class="p">):</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="n">bs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># aggregate close by</span>
            <span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">x1</span> <span class="k">for</span> <span class="n">x0</span><span class="p">,</span><span class="n">x1</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="k">if</span> <span class="n">x1</span><span class="o">-</span><span class="n">x0</span><span class="o">&gt;</span><span class="n">mis</span><span class="p">]</span>
        <span class="c1"># for each ed1 in bs make (chr,st,ed1)</span>
        <span class="c1"># bs=[b1,b2,b3,...,bn]</span>
        <span class="c1"># intervals = (st,b1),(b1,b2),(b2,b3),...,(bn-1,bn),(bn,ed)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">itvs</span> <span class="o">=</span><span class="p">[(</span><span class="n">s1</span><span class="p">,</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">+</span><span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">bs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])]</span><span class="o">+</span><span class="p">[(</span><span class="n">bs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">e1</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">itvs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">s1</span><span class="p">,</span><span class="n">e1</span><span class="p">)]</span>
        <span class="c1"># for each interval, calculate cov (just sum of tmp/len)</span>
        <span class="n">covs</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">N</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">s0</span><span class="p">:</span><span class="n">y</span><span class="o">-</span><span class="n">s0</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="ow">in</span> <span class="n">itvs</span><span class="p">])</span>
        <span class="c1">#covs = [N.sum(tmp[x-s0:y-s0])/(y-x) for x,y in itvs]</span>
        <span class="c1">#rth = self.covratio</span>
        <span class="c1">#th = self.covth</span>
        <span class="n">acovth2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">covs</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">covratio</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acovth2</span> <span class="o">=</span> <span class="n">acovth2</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">covs</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1">#i1 = set([i for i in range(len(covs)-1) if ((covs[i]/covs[i+1])&gt;rth)&amp;(covs[i]&gt;th)])</span>
            <span class="c1">#i2 = set([i for i in range(1,len(covs)) if ((covs[i]/covs[i-1])&gt;rth)&amp;(covs[i]&gt;th)])</span>
            <span class="c1">#idx = sorted(i1.union(i2))</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">covs</span><span class="p">))</span> <span class="k">if</span> <span class="n">covs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">acovth2</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">returnall</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">itvs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">covs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">itvs</span><span class="p">))]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">itvs</span><span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="n">covs</span><span class="p">[</span><span class="n">x</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">itvs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">covs</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="p">(</span><span class="n">itvs</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="n">covs</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])]</span> <span class="c1"># only return first &amp; last</span></div>
        
<div class="viewcode-block" id="EdgeDetector.plotone"><a class="viewcode-back" href="../../modules.html#jgem.assembler.EdgeDetector.plotone">[docs]</a>    <span class="k">def</span> <span class="nf">plotone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">strand</span><span class="o">=</span><span class="s1">&#39;+&#39;</span><span class="p">,</span><span class="n">utr</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">,</span> <span class="n">find</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ylim</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">xlim</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">find</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">utr</span><span class="o">==</span><span class="s1">&#39;3&#39;</span><span class="p">:</span>
                <span class="n">find</span> <span class="o">=</span> <span class="s1">&#39;drop&#39;</span> <span class="k">if</span> <span class="n">strand</span><span class="o">==</span><span class="s1">&#39;+&#39;</span> <span class="k">else</span> <span class="s1">&#39;rise&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">find</span> <span class="o">=</span> <span class="s1">&#39;drop&#39;</span> <span class="k">if</span> <span class="n">strand</span><span class="o">==</span><span class="s1">&#39;-&#39;</span> <span class="k">else</span> <span class="s1">&#39;rise&#39;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>
            <span class="c1">#tmp, dtmp, th, sm = self._calc_dtmp(chrom,st,ed)</span>
            <span class="n">tmp</span><span class="p">,</span> <span class="n">dtmp</span><span class="p">,</span> <span class="n">th</span><span class="p">,</span> <span class="n">sm</span><span class="p">,</span> <span class="n">mima</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_stats</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
            <span class="n">itcv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">find</span><span class="p">)</span>
        <span class="n">ltmp</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#covs = N.log2(N.array([x[1] for x in itcv])+1)</span>
        <span class="c1">#lacovth = N.max(ltmp)*self.covratio</span>
        <span class="c1">#lacovth2 = N.max(lcovs)*self.covratio</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lacovth</span> <span class="o">=</span> <span class="n">lacovth</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_acovth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lacovth2</span> <span class="o">=</span> <span class="n">lacovth2</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_acovth2</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#         cs0 = N.cumsum(tmp)</span>
        <span class="c1">#         tot = N.sum(tmp)</span>
        <span class="c1">#         cs1 = tot - cs0</span>
        <span class="c1">#         cs0 = cs0/tot</span>
        <span class="c1">#         cs1 = cs1/tot</span>
        
        <span class="n">fig</span><span class="p">,</span><span class="n">axr</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="c1">#d = self.delta</span>
        <span class="c1">#x = N.arange(st-d,ed+d)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">N</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ltmp</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">N</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dtmp</span><span class="p">))</span>
        <span class="c1">#         P.plot(x,cs0)</span>
        <span class="c1">#         P.plot(x,cs1)</span>
        
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">th</span><span class="p">,</span><span class="n">th</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">lacovth</span><span class="p">,</span><span class="n">lacovth</span><span class="p">],</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="n">lacovth2</span><span class="p">,</span><span class="n">lacovth2</span><span class="p">],</span><span class="s1">&#39;g--&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ylim</span><span class="p">:</span>
            <span class="n">axr</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ylim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ylim</span> <span class="o">=</span> <span class="n">P</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">xlim</span><span class="p">:</span>
            <span class="n">axr</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xlim</span><span class="p">)</span>
        <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.8</span><span class="p">,</span> <span class="s1">&#39;{0}:{1}-{2}:{3}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">chrom</span><span class="p">,</span><span class="n">st</span><span class="p">,</span><span class="n">ed</span><span class="p">,</span><span class="n">strand</span><span class="p">))</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">),</span><span class="n">cov</span><span class="p">,</span> <span class="n">sel</span> <span class="ow">in</span> <span class="n">itcv</span><span class="p">:</span>
            <span class="n">LOG</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span> <span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">),</span> <span class="n">cov</span><span class="p">,</span> <span class="n">sel</span> <span class="p">)</span>
            <span class="k">if</span> <span class="n">sel</span><span class="p">:</span>
                <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span><span class="n">x2</span><span class="p">],</span><span class="n">ylim</span><span class="p">,</span><span class="s1">&#39;r--&#39;</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.9</span><span class="p">,</span><span class="s1">&#39;{0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span><span class="n">x1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">],</span><span class="s1">&#39;c--&#39;</span><span class="p">)</span>
                <span class="n">P</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span><span class="n">x2</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.5</span><span class="p">],</span><span class="s1">&#39;c--&#39;</span><span class="p">)</span>                
                <span class="n">P</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x1</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mf">0.45</span><span class="p">,</span><span class="s1">&#39;{0:.4f}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">cov</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fig</span></div></div>


<span class="k">for</span> <span class="n">klass</span> <span class="ow">in</span> <span class="n">SUBASE</span><span class="o">.</span><span class="n">__subclasses__</span><span class="p">():</span>
    <span class="n">klass</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">__doc__</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">PARAMSDOC</span><span class="p">)</span>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2016, Ken Sugino.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>